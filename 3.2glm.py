import requests
import json
import random
import sys
import os

# å¯¼å…¥TTSåŠŸèƒ½
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from xunfei_tts import text_to_speech

def call_zhipu_api(messages, model="glm-4-flash"):
    url = "https://open.bigmodel.cn/api/paas/v4/chat/completions"
    
    headers = {
        "Authorization": "ab16c0b7809545e99d60ae7b73023ba4.YwWPxLoEG60CWy6k",
        "Content-Type": "application/json"
    }
    
    data = {
        "model": model,
        "messages": messages,
        "temperature": 0.5   
    }
    
    response = requests.post(url, headers=headers, json=data)
    
    if response.status_code == 200:
        return response.json()
    else:
        raise Exception(f"APIè°ƒç”¨å¤±è´¥: {response.status_code}, {response.text}")

# æ¸¸æˆè®¾ç½®
role_system = ["ä¿å®‰", "ä¿é•–"]
current_role = random.choice(role_system)

# ç³»ç»Ÿæç¤ºè¯
game_system = f"""ä½ æ­£åœ¨ç©"è°æ˜¯å§åº•"æ¸¸æˆã€‚ä½ çš„èº«ä»½æ˜¯ï¼š{current_role}

ã€é‡è¦ï¼šä½ å¿…é¡»å®Œå…¨ä»¥{current_role}çš„èº«ä»½å’Œå£å»æ¥å›ç­”ï¼Œè¯´è¯æ–¹å¼è¦ç¬¦åˆè¿™ä¸ªèŒä¸šçš„ç‰¹ç‚¹ã€‘

ã€ç¦æ­¢ã€‘ç»å¯¹ä¸è¦æåˆ°"äººè´¨"ã€"å°ä¸‘"æˆ–å…¶ä»–ä»»ä½•ä¸ç›¸å…³çš„è§’è‰²ï¼Œä½ çš„èº«ä»½åªèƒ½æ˜¯"ä¿å®‰"æˆ–"ä¿é•–"ä¸­çš„ä¸€ä¸ªã€‚

è§’è‰²ç‰¹å¾å’Œè¯´è¯æ–¹å¼ï¼š
- å¦‚æœä½ æ˜¯"ä¿å®‰"ï¼šè¯´è¯è¦æ­£å¼ã€ä¸¥è°¨ï¼Œæ³¨é‡ç»´æŠ¤ç§©åºå’Œå…¬å…±å®‰å…¨ï¼Œè¯­æ°”å¯èƒ½æ¯”è¾ƒå®˜æ–¹ï¼Œä¼šæåˆ°å·¡é€»ã€æ£€æŸ¥ã€ç»´æŠ¤ç§©åºç­‰å·¥ä½œå†…å®¹
- å¦‚æœä½ æ˜¯"ä¿é•–"ï¼šè¯´è¯è¦ä¸“ä¸šã€è­¦æƒ•ï¼Œæ³¨é‡ä¸ªäººä¿æŠ¤ï¼Œè¯­æ°”å¯èƒ½æ›´ç®€æ´ã€ä¸“ä¸šï¼Œä¼šæåˆ°è´´èº«ä¿æŠ¤ã€é£é™©è¯„ä¼°ã€ä¸ªäººå®‰å…¨ç­‰å·¥ä½œå†…å®¹

æ¸¸æˆè§„åˆ™ï¼š

1. ç”¨æˆ·ä¼šé€šè¿‡æé—®æ¥çŒœæµ‹ä½ çš„èº«ä»½

2. ä½ è¦é€šè¿‡æè¿°è‡ªå·±çš„ç‰¹å¾ã€æ„Ÿå—ã€å¤„å¢ƒæ¥æš—ç¤ºï¼Œä½†ç»å¯¹ä¸èƒ½ç›´æ¥è¯´å‡º"{current_role}"è¿™ä¸ªè¯

3. ä¸è¦ç›´æ¥å›ç­”"æ˜¯"æˆ–"å¦"ï¼Œè€Œæ˜¯é€šè¿‡æè¿°ç‰¹å¾è®©ç”¨æˆ·è‡ªå·±åˆ¤æ–­

4. ä¸è¦è¯´"æˆ‘ä¸æ˜¯XX"è¿™ç§ç›´æ¥å¦å®šï¼Œè€Œæ˜¯è¯´"æˆ‘æ›´åƒæ˜¯..."æ¥æè¿°

5. ä¸è¦æåŠå…¶ä»–å¯èƒ½çš„èº«ä»½é€‰é¡¹

6. å½“ç”¨æˆ·å‡†ç¡®è¯´å‡º"{current_role}"è¿™ä¸ªè¯æ—¶ï¼Œä½ åªå›å¤"å†è§"æ¥ç»“æŸæ¸¸æˆ

7. ä¿æŒç¥ç§˜æ„Ÿï¼Œè®©æ¸¸æˆæœ‰è¶£

8. ã€å…³é”®ã€‘ä½ å¿…é¡»ä»¥{current_role}çš„èŒä¸šå£å»å’Œè¯´è¯æ–¹å¼æ¥å›ç­”ï¼Œè®©ç”¨æˆ·èƒ½ä»ä½ çš„è¯´è¯é£æ ¼ä¸­æ„Ÿå—åˆ°èŒä¸šç‰¹å¾

å›ç­”ç¤ºä¾‹ï¼š

- å¦‚æœä½ æ˜¯"ä¿å®‰"ï¼Œç”¨æˆ·é—®"ä½ æ˜¯ä¿é•–å—ï¼Ÿ"
  å¥½çš„å›ç­”ï¼š"æˆ‘æ¯å¤©çš„å·¥ä½œå°±æ˜¯å·¡é€»ã€æ£€æŸ¥ï¼Œç»´æŠ¤è¿™é‡Œçš„ç§©åºå’Œå®‰å…¨..."ï¼ˆä»¥ä¿å®‰çš„å£å»ï¼Œæåˆ°å·¡é€»ã€æ£€æŸ¥ç­‰ï¼Œä½†ä¹Ÿä¸è¦å¤ªæ˜æ˜¾ï¼Œä¿æŒç¥ç§˜æ„Ÿã€‚ï¼‰
  åçš„å›ç­”ï¼š"ä¸æ˜¯ä¿é•–ï¼Œæˆ‘æ˜¯ä¿å®‰" æˆ– "æ—¢ä¸æ˜¯ä¿é•–ä¹Ÿä¸æ˜¯ä¿å®‰"

- å¦‚æœä½ æ˜¯"ä¿é•–"ï¼Œç”¨æˆ·é—®"ä½ æ˜¯ä¿å®‰å—ï¼Ÿ"  
  å¥½çš„å›ç­”ï¼š"æˆ‘çš„èŒè´£æ˜¯ç¡®ä¿ç‰¹å®šäººå‘˜çš„å®‰å…¨ï¼Œéœ€è¦æ—¶åˆ»ä¿æŒè­¦æƒ•..."ï¼ˆä»¥ä¿é•–çš„å£å»ï¼Œæåˆ°ä¸ªäººä¿æŠ¤ã€è­¦æƒ•ç­‰ï¼‰
  åçš„å›ç­”ï¼š"ä¸æ˜¯ä¿å®‰ï¼Œæˆ‘æ˜¯ä¿é•–" æˆ– "æˆ‘ä¸æ˜¯ä¿å®‰"

ç°åœ¨å¼€å§‹æ¸¸æˆï¼Œç”¨æˆ·ä¼šå¼€å§‹æé—®ã€‚ä½ å¿…é¡»å®Œå…¨ä»¥{current_role}çš„èº«ä»½ã€å£å»å’Œè¯´è¯æ–¹å¼æ¥å›ç­”ï¼Œé€šè¿‡æè¿°ç‰¹å¾æ¥æš—ç¤ºï¼Œä¸è¦ç›´æ¥å¦å®šæˆ–è‚¯å®šã€‚"""

# ç»´æŠ¤å¯¹è¯å†å²
conversation_history = [
    {"role": "system", "content": game_system}
]

# å¤šè½®å¯¹è¯å¾ªç¯
while True:
    user_input = input("è¯·è¾“å…¥ä½ è¦è¯´çš„è¯ï¼š")
    
    # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
    conversation_history.append({"role": "user", "content": user_input})
    
    # è°ƒç”¨API
    result = call_zhipu_api(conversation_history)
    assistant_reply = result['choices'][0]['message']['content']
    
    # æ·»åŠ åŠ©æ‰‹å›å¤åˆ°å†å²
    conversation_history.append({"role": "assistant", "content": assistant_reply})
    
    # æ‰“å°å›å¤
    print(f"\nğŸ¤– AIå›å¤: {assistant_reply}\n")
    
    # ä½¿ç”¨TTSæ’­æ”¾AIçš„å›å¤
    try:
        print("ğŸ”Š æ­£åœ¨ç”Ÿæˆå¹¶æ’­æ”¾è¯­éŸ³ï¼Œè¯·ç¨å€™...")
        text_to_speech(assistant_reply)
        print("âœ… è¯­éŸ³æ’­æ”¾å®Œæˆ\n")
    except Exception as e:
        print(f"âš ï¸ è¯­éŸ³æ’­æ”¾å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
    
    # æ£€æŸ¥æ˜¯å¦çŒœå¯¹ï¼ˆæ¨¡å‹å›å¤"å†è§"ï¼‰
    if "å†è§" in assistant_reply:
        print(f"\næ¸¸æˆç»“æŸï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š{current_role}")
        break

