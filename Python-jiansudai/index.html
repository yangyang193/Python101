<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£è·ƒå‡é€Ÿå¸¦å®éªŒç³»ç»Ÿ - æ•°æ®å¯è§†åŒ–ç•Œé¢</title>
    
    <!-- TailwindCSS 3.0+ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* Cursor é«˜é¥±å’Œæ·±è‰²é£æ ¼ */
        body {
            background: #000000;
            color: #ffffff;
        }
        
        /* å·¦ä¾§å˜é‡é€‰æ‹©æ¨¡å— - è“è‰²è¾¹æ¡† */
        .card.variable-selection {
            background: transparent;
            border: 2px solid #00D9FF;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        .card.variable-selection:hover {
            border-color: #0099FF;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        /* ä¸­é—´æ¨¡æ‹Ÿç»“æœæ¨¡å— - è“è‰²è¾¹æ¡† */
        .card.simulation-result {
            background: transparent;
            border: 2px solid #00D9FF;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        .card.simulation-result:hover {
            border-color: #0099FF;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        /* å³ä¾§é€Ÿåº¦è®¾ç½®æ¨¡å— - è“è‰²è¾¹æ¡† */
        .card.speed-settings {
            background: transparent;
            border: 2px solid #00D9FF;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        .card.speed-settings:hover {
            border-color: #0099FF;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        /* é€šç”¨å¡ç‰‡æ ·å¼ï¼ˆæ— èƒŒæ™¯ï¼Œä»…è¾¹æ¡†ï¼‰ */
        .card {
            background: transparent;
            border: 2px solid #ffffff;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        
        .btn-primary {
            background: transparent;
            border: 2px solid #00D9FF;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            border-color: #0099FF;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.6);
            transform: translateY(-2px);
        }
        
        .select-option {
            padding: 12px 16px;
            border: 1px solid #ffffff;
            border-radius: 8px;
            background: transparent;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .select-option:hover {
            border-color: #ffffff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        .select-option.active {
            border-color: #ffffff;
            border-width: 2px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* æ¨èæ¨¡å—æ ·å¼ */
        .recommendation-card {
            background: transparent;
            border: 1px solid #ffffff;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .recommendation-card:hover {
            transform: scale(1.02);
            border-color: #ffffff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
        }
        
        .recommendation-card .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .recommendation-card .recommendation-badge {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid #ffffff;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            color: #ffffff;
        }
        
        .recommendation-card .recommendation-vars {
            font-size: 12px;
            color: #ffffff;
            margin-bottom: 6px;
            line-height: 1.5;
        }
        
        .recommendation-card .recommendation-reason {
            font-size: 11px;
            color: #aaa;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .recommendation-card .recommendation-preview {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
        }
        
        .recommendation-card .apply-btn {
            width: 100%;
            padding: 6px;
            background: transparent;
            border: 1px solid #ffffff;
            border-radius: 4px;
            color: #ffffff;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .recommendation-card .apply-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #ffffff;
            color: #ffffff;
        }
        
        /* é€Ÿåº¦è¡¨æ ·å¼ */
        .speedometer {
            width: 100%;
            height: 350px;
            position: relative;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .speedometer svg {
            width: 350px;
            height: 350px;
            max-width: 350px;
            max-height: 350px;
            margin: 0 auto;
            display: block;
        }
        
        /* é€Ÿåº¦æ»‘å—æ ·å¼ */
        #speed-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: transparent;
            outline: none;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }
        
        #speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #00D9FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.6);
            transition: all 0.2s ease;
        }
        
        #speed-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.8);
        }
        
        #speed-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #00D9FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.6);
            transition: all 0.2s ease;
        }
        
        #speed-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.8);
        }
        
        #speed-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            background: transparent;
        }
        
        #speed-slider::-moz-range-track {
            width: 100%;
            height: 2px;
            background: transparent;
        }
        
        
        /* å·¥å…·æç¤º */
        .tooltip {
            position: absolute;
            background: #000000;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #ffffff;
            max-width: 300px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #000000;
            border: 2px solid #00D9FF;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        /* å›¾è¡¨å®¹å™¨ - ä¸åŒé¢œè‰²è¾¹æ¡†åŒºåˆ† */
        .chart-container {
            background: transparent;
            border: 2px solid #00D9FF;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        .chart-container {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            box-shadow: 0 0 20px currentColor;
            transform: scale(1.02);
        }
        
        /* å¹¸å­˜ç‡æ˜¾ç¤º - ä»…è¾¹æ¡†ï¼Œæ— èƒŒæ™¯ */
        .survival-display {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            background: transparent;
            border: 3px solid;
        }
        
        .survival-safe {
            border-color: #00FF88;
            color: #ffffff;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .survival-warning {
            border-color: #ffffff;
            color: #ffffff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        
        .survival-danger {
            border-color: #FF0040;
            color: #ffffff;
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.5);
        }
        
        /* åˆ†æé¢æ¿ */
        .analysis-panel {
            position: sticky;
            top: 20px;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .grid-layout {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto px-4 py-8 max-w-full" style="border: 2px solid #00D9FF; border-radius: 12px; padding: 24px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8 fade-in" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 24px; margin-bottom: 32px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
            <h1 class="text-3xl font-bold mb-2 text-white">
                é£è·ƒå‡é€Ÿå¸¦
            </h1>
            <p class="text-white opacity-90">æ•°æ®å¯è§†åŒ–ç•Œé¢ - æ¢ç´¢é€Ÿåº¦ä¸å®‰å…¨çš„è¾¹ç•Œ</p>
        </div>

        <!-- ä¸»å¸ƒå±€ -->
        <div class="grid grid-cols-12 gap-6 grid-layout">
            <!-- å·¦ä¾§ï¼šå˜é‡é€‰æ‹© -->
            <div class="col-span-12 lg:col-span-2 space-y-4">
                <div class="card variable-selection p-6">
                    <h2 class="text-lg font-semibold mb-4 text-white">
                        <i class="fas fa-cog mr-2"></i>å˜é‡é€‰æ‹©
                    </h2>
                    
                    <!-- è½¦è¾†é€‰æ‹© -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-white mb-2">è½¦è¾†ç±»å‹</label>
                        <div class="space-y-2">
                            <div class="select-option" data-type="vehicle" data-value="èŠ‚èƒ½å‹å°å‹è½¦" data-tooltip="è™½ç„¶èŠ‚èƒ½å‹å°å‹è½¦æœ‰åŠ©äºå‡å°‘èƒ½æºæ¶ˆè€—å’Œç¯å¢ƒæ±¡æŸ“ï¼Œä½†å®ƒä»¬å¯èƒ½ç‰ºç‰²äº†é©¾é©¶èˆ’é€‚æ€§å’Œå®‰å…¨æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨å®‰å…¨æ€§æ–¹é¢ï¼Œå°å‹è½¦å¯èƒ½ä¸å¦‚å¤§å‹è½¦åšå›ºã€‚">
                                <i class="fas fa-car mr-2"></i>èŠ‚èƒ½å‹å°å‹è½¦
                            </div>
                            <div class="select-option" data-type="vehicle" data-value="é«˜æ€§èƒ½è·‘è½¦" data-tooltip="é«˜æ€§èƒ½è·‘è½¦é€šå¸¸é‡é‡è¾ƒè½»ï¼Œä»¥æé«˜åŠ é€Ÿæ€§èƒ½ï¼Œä½†è¿™ä¹Ÿå¯èƒ½å¢åŠ äº‹æ•…é£é™©ã€‚ä»ä¼¦ç†è§’åº¦æ¥çœ‹ï¼Œè¿™ç§é€‰æ‹©æ¶‰åŠåˆ°å¯¹ä¸ªäººé©¾é©¶ä¹è¶£çš„è¿½æ±‚ä¸å¯¹å…¬å…±å®‰å…¨çš„è´£ä»»ã€‚">
                                <i class="fas fa-car-side mr-2"></i>é«˜æ€§èƒ½è·‘è½¦
                            </div>
                            <div class="select-option" data-type="vehicle" data-value="å…¨å°ºå¯¸SUV" data-tooltip="SUVé€šå¸¸é‡é‡è¾ƒå¤§ï¼Œæ¶ˆè€—æ›´å¤šèƒ½æºï¼Œæ’æ”¾æ›´å¤šæ¸©å®¤æ°”ä½“ã€‚æ­¤å¤–ï¼Œå®ƒä»¬çš„ä½“ç§¯å’Œé‡é‡ä¹Ÿå¯èƒ½å¢åŠ é“è·¯äº‹æ•…çš„ä¸¥é‡æ€§ã€‚ä¼¦ç†ä¸Šï¼Œè¿™ç§é€‰æ‹©æ¶‰åŠåˆ°ä¸ªäººèˆ’é€‚ä¸èµ„æºæ¶ˆè€—ã€ç¯å¢ƒå½±å“çš„è€ƒé‡ã€‚">
                                <i class="fas fa-truck mr-2"></i>å…¨å°ºå¯¸SUV
                            </div>
                            <div class="select-option" data-type="vehicle" data-value="è±ªåè½¿è½¦" data-tooltip="è±ªåè½¿è½¦å¾€å¾€ä¸é«˜èƒ½è€—å’Œç¯å¢ƒæ±¡æŸ“ç›¸å…³ã€‚æ­¤å¤–ï¼Œè¿™ç§é€‰æ‹©å¯èƒ½åŠ å‰§ç¤¾ä¼šä¸å¹³ç­‰ï¼Œå› ä¸ºè±ªåè½¿è½¦é€šå¸¸ä»·æ ¼æ˜‚è´µï¼Œåªæœ‰å°‘æ•°äººèƒ½å¤Ÿè´Ÿæ‹…å¾—èµ·ã€‚">
                                <i class="fas fa-car mr-2"></i>è±ªåè½¿è½¦
                            </div>
                            <div class="select-option" data-type="vehicle" data-value="å¤§å¡è½¦" data-tooltip="å¤§å¡è½¦å…¨åŠ›åŠ é€Ÿæƒ…å†µä¸‹ä¸€èˆ¬é€Ÿåº¦ä¼šæ›´å¿«ã€‚ä½†åœ¨æµ‹è¯•è·¯é¢ä¸Šè¡Œé©¶å¯èƒ½ä¼šåŠ é€Ÿé“è·¯çš„ç£¨æŸï¼Œå¹¶ä¸”å®éªŒè½¦è¾†æ’æ”¾çš„å°¾æ°”å¯èƒ½ä¼šå¯¹ç©ºæ°”è´¨é‡äº§ç”Ÿè´Ÿé¢å½±å“ã€‚">
                                <i class="fas fa-truck mr-2"></i>å¤§å¡è½¦
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‡é€Ÿå¸¦é€‰æ‹© -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-white mb-2">å‡é€Ÿå¸¦ç±»å‹</label>
                        <div class="space-y-2">
                            <div class="select-option" data-type="bump" data-value="æ©¡èƒ¶å‡é€Ÿå¸¦" data-tooltip="æ©¡èƒ¶å‡é€Ÿå¸¦çš„ç”Ÿäº§å’Œæœ€ç»ˆåºŸå¼ƒå¯èƒ½å¯¹ç¯å¢ƒé€ æˆè´Ÿæ‹…ï¼ŒåŒ…æ‹¬æ©¡èƒ¶æå–ã€ç”Ÿäº§è¿‡ç¨‹ä¸­çš„åŒ–å­¦ç‰©è´¨æ’æ”¾ä»¥åŠåºŸå¼ƒç‰©çš„å¤„ç†ã€‚">
                                <i class="fas fa-road mr-2"></i>æ©¡èƒ¶å‡é€Ÿå¸¦
                            </div>
                            <div class="select-option" data-type="bump" data-value="é‡‘å±å‡é€Ÿå¸¦" data-tooltip="é‡‘å±å‡é€Ÿå¸¦åœ¨è½¦è¾†é€šè¿‡æ—¶å¯èƒ½äº§ç”Ÿæ›´å¤šçš„å™ªéŸ³å’ŒæŒ¯åŠ¨ï¼Œå½±å“å‘¨è¾¹ç¯å¢ƒå’Œå±…æ°‘çš„ç”Ÿæ´»è´¨é‡ã€‚">
                                <i class="fas fa-road mr-2"></i>é‡‘å±å‡é€Ÿå¸¦
                            </div>
                            <div class="select-option" data-type="bump" data-value="æ³¡æ²«å‡é€Ÿå¸¦" data-tooltip="æ³¡æ²«å‡é€Ÿå¸¦çš„è€ç”¨æ€§å¯èƒ½ä¸å¦‚æ©¡èƒ¶æˆ–é‡‘å±ï¼Œéœ€è¦æ›´é¢‘ç¹çš„æ›´æ¢å’Œç»´æŠ¤ï¼Œè¿™å¯èƒ½ä¼šå¢åŠ æˆæœ¬å’Œèµ„æºæ¶ˆè€—ã€‚">
                                <i class="fas fa-road mr-2"></i>æ³¡æ²«å‡é€Ÿå¸¦
                            </div>
                            <div class="select-option" data-type="bump" data-value="æ°´å‹å‡é€Ÿå¸¦" data-tooltip="æ°´å‹å‡é€Ÿå¸¦å¯èƒ½éœ€è¦å¤§é‡çš„æ°´èµ„æºï¼Œè¿™å¯èƒ½ä¼šåœ¨æ°´èµ„æºåŒ®ä¹çš„åœ°åŒºå¼•èµ·ä¼¦ç†äº‰è®®ã€‚">
                                <i class="fas fa-road mr-2"></i>æ°´å‹å‡é€Ÿå¸¦
                            </div>
                        </div>
                    </div>
                    
                    <!-- åœ°ç‚¹é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-medium text-white mb-2">åœ°ç‚¹</label>
                        <div class="space-y-2">
                            <div class="select-option" data-type="location" data-value="å­¦æ ¡é—¨å£" data-tooltip="è¯·å…³æ³¨å­¦ç”Ÿçš„å®‰å…¨ï¼Œå‡å°‘äº¤é€šäº‹æ•…ã€‚">
                                <i class="fas fa-school mr-2"></i>å­¦æ ¡é—¨å£
                            </div>
                            <div class="select-option" data-type="location" data-value="æ£®æ—" data-tooltip="è¯·ä¿æŠ¤è‡ªç„¶ç¯å¢ƒå’Œç”Ÿç‰©å¤šæ ·æ€§ã€‚">
                                <i class="fas fa-tree mr-2"></i>æ£®æ—
                            </div>
                            <div class="select-option" data-type="location" data-value="å†å²é—è¿¹é™„è¿‘" data-tooltip="è¯·éµå®ˆæ³•å¾‹æ³•è§„ï¼Œé«˜é€Ÿé©¾é©¶å¯èƒ½å¯¹é—è¿¹é€ æˆæŸå®³ã€‚">
                                <i class="fas fa-monument mr-2"></i>å†å²é—è¿¹é™„è¿‘
                            </div>
                            <div class="select-option" data-type="location" data-value="æ™®é€šè·‘é“" data-tooltip="åœ¨æ­¤åœ°å¯ä»¥å°½æƒ…é©°éª‹äº«å—é€Ÿåº¦ä¸æ¿€æƒ…ã€‚">
                                <i class="fas fa-flag-checkered mr-2"></i>æ™®é€šè·‘é“
                            </div>
                            <div class="select-option" data-type="location" data-value="å±±åœ°æ»‘å¡" data-tooltip="æ­¤å¤„é£é™©æé«˜ï¼Œé€‰æ‹©åå¹¸å­˜ç‡å°†å¤§å¹…åº¦é™ä½ï¼Œè¯·è°¨æ…é€‰æ‹©ã€‚">
                                <i class="fas fa-mountain mr-2"></i>å±±åœ°æ»‘å¡
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ™ºèƒ½æ¨èæ¨¡å— - å³ä¾§ç‹¬ç«‹æ¨¡å— -->
            <div class="col-span-12 lg:col-span-2 space-y-4">
                <div class="card variable-selection p-6">
                    <h2 class="text-lg font-semibold mb-2 text-white">
                        <i class="fas fa-magic mr-2"></i>æ™ºèƒ½æ¨è
                    </h2>
                    <p class="text-sm text-white opacity-70 mb-4" style="font-size: 12px;">é€‰æ‹©å›°éš¾ç—‡ï¼Ÿè¯•è¯•æ™ºèƒ½æ¨è</p>
                    <div class="mb-3">
                        <select id="recommendation-target" class="w-full p-2 bg-transparent border border-white border-opacity-30 rounded text-white text-sm focus:outline-none focus:border-opacity-60">
                            <option value="max-speed">æœ€é«˜é€Ÿåº¦æŒ‘æˆ˜</option>
                            <option value="safest">æœ€å®‰å…¨é€šè¿‡</option>
                            <option value="eco-friendly">æœ€ç¯ä¿é€‰æ‹©</option>
                            <option value="extreme">æœ€æç«¯æµ‹è¯•</option>
                            <option value="balanced">å¹³è¡¡é€‰æ‹©</option>
                        </select>
                    </div>
                    <button id="get-recommendations" class="btn-primary w-full text-sm py-2">
                        <i class="fas fa-sparkles mr-2"></i>è·å–æ¨è
                    </button>
                    <div id="recommendations-container" class="mt-4 space-y-3 hidden">
                        <!-- æ¨èç»“æœå°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šä¸»è¦å†…å®¹åŒº -->
            <div class="col-span-12 lg:col-span-6 space-y-6">
                <!-- å¹¸å­˜ç»“æœæ˜¾ç¤º -->
                <div class="card simulation-result p-6">
                    <h2 class="text-lg font-semibold mb-4 text-white">
                        <i class="fas fa-shield-alt mr-2"></i>æ¨¡æ‹Ÿç»“æœ
                    </h2>
                    <div id="survival-display" class="survival-display survival-safe">
                        <div class="text-2xl mb-2">ç­‰å¾…æ¨¡æ‹Ÿ</div>
                        <div class="text-sm opacity-90">è¯·é€‰æ‹©å‚æ•°å¹¶å¼€å§‹æ¨¡æ‹Ÿ</div>
                    </div>
                    <div id="survival-details" class="mt-4 text-sm text-white"></div>
                </div>

                <!-- å¤©æ°”é€‰æ‹©æ¨¡å— -->
                <div class="card p-6" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                    <h2 class="text-lg font-semibold mb-4 text-white">
                        <i class="fas fa-cloud-sun mr-2"></i>é€‰æ‹©ä»Šæ—¥å¤©æ°”
                    </h2>
                    <div class="grid grid-cols-5 gap-3">
                        <div class="select-option weather-option" data-weather="æ™´" data-tooltip="æ™´å¤©ï¼Œè·¯é¢å¹²ç‡¥ï¼Œæ‘©æ“¦ç³»æ•°æ­£å¸¸">
                            <i class="fas fa-sun mr-2" style="color: #FFD700;"></i>æ™´
                        </div>
                        <div class="select-option weather-option" data-weather="å¤šäº‘" data-tooltip="å¤šäº‘å¤©æ°”ï¼Œè·¯é¢æ¡ä»¶è‰¯å¥½">
                            <i class="fas fa-cloud mr-2" style="color: #87CEEB;"></i>å¤šäº‘
                        </div>
                        <div class="select-option weather-option" data-weather="é˜´" data-tooltip="é˜´å¤©ï¼Œè·¯é¢å¯èƒ½ç•¥æœ‰æ¹¿æ»‘">
                            <i class="fas fa-cloud mr-2" style="color: #708090;"></i>é˜´
                        </div>
                        <div class="select-option weather-option" data-weather="é›¨" data-tooltip="é›¨å¤©ï¼Œè·¯é¢æ¹¿æ»‘ï¼Œæ‘©æ“¦ç³»æ•°é™ä½">
                            <i class="fas fa-cloud-rain mr-2" style="color: #4682B4;"></i>é›¨
                        </div>
                        <div class="select-option weather-option" data-weather="é›ª" data-tooltip="é›ªå¤©ï¼Œè·¯é¢éå¸¸æ¹¿æ»‘ï¼Œæ‘©æ“¦ç³»æ•°æ˜¾è‘—é™ä½">
                            <i class="fas fa-snowflake mr-2" style="color: #E0E0E0;"></i>é›ª
                        </div>
                    </div>
                </div>

                <!-- D3.js å›¾è¡¨åŒºåŸŸ -->
                <div class="space-y-4">
                    <!-- é€Ÿåº¦ä¸äº‹æ•…æ¦‚ç‡çƒ­åŠ›å›¾ -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-md font-semibold text-white">
                                <i class="fas fa-chart-area mr-2"></i>é€Ÿåº¦ä¸äº‹æ•…æ¦‚ç‡çƒ­åŠ›å›¾
                            </h3>
                        </div>
                        <div id="heatmap-chart"></div>
                    </div>

                    <!-- å†²å‡»åŠ›åŠ¨æ€å›¾ -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-md font-semibold text-white">
                                <i class="fas fa-wave-square mr-2"></i>å†²å‡»åŠ›åŠ¨æ€å›¾
                            </h3>
                        </div>
                        <div id="impact-chart"></div>
                    </div>

                    <!-- é€Ÿåº¦-æ—¶é—´æ›²çº¿å›¾ -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-md font-semibold text-white">
                                <i class="fas fa-chart-line mr-2"></i>é€Ÿåº¦-æ—¶é—´æ›²çº¿å›¾
                            </h3>
                        </div>
                        <div id="speed-time-chart"></div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šé€Ÿåº¦è¡¨å’Œåˆ†æé¢æ¿ -->
            <div class="col-span-12 lg:col-span-2 space-y-6">
                <!-- é€Ÿåº¦è¡¨ -->
                <div class="card speed-settings p-6">
                    <h2 class="text-lg font-semibold mb-4 text-white text-center">
                        <i class="fas fa-tachometer-alt mr-2"></i>é€Ÿåº¦è®¾ç½®
                    </h2>
                    <div class="speedometer" id="speedometer">
                        <svg width="350" height="350" viewBox="0 0 300 300" style="display: block; margin: 0 auto;">
                            <!-- é€Ÿåº¦è¡¨èƒŒæ™¯ -->
                            <circle cx="150" cy="150" r="120" fill="none" stroke="#ffffff" stroke-width="8" stroke-opacity="0.2"/>
                            
                            <!-- ä½é€ŸåŒºé—´ (10-30 km/h) - ç»¿è‰² -->
                            <path d="M 150 30 A 120 120 0 0 1 270 150" fill="none" stroke="#00FF88" stroke-width="12" stroke-linecap="round" id="low-speed-arc"/>
                            
                            <!-- ä¸­é€ŸåŒºé—´ (30-50 km/h) - æ©™è‰² -->
                            <path d="M 270 150 A 120 120 0 0 1 150 270" fill="none" stroke="#ffffff" stroke-width="12" stroke-linecap="round" id="mid-speed-arc"/>
                            
                            <!-- é«˜é€ŸåŒºé—´ (50-70 km/h) - çº¢è‰² -->
                            <path d="M 150 270 A 120 120 0 0 1 30 150" fill="none" stroke="#FF0040" stroke-width="12" stroke-linecap="round" id="high-speed-arc"/>
                            
                            <!-- ä¸­å¿ƒç‚¹ -->
                            <circle cx="150" cy="150" r="8" fill="#ffffff"/>
                            
                            <!-- Emoji è¡¨æƒ… -->
                            <text x="150" y="150" text-anchor="middle" font-size="60" id="speed-emoji" dominant-baseline="middle">ğŸ˜Š</text>
                            
                            <!-- åˆ»åº¦ -->
                            <text x="150" y="40" text-anchor="middle" fill="#ffffff" font-size="14" font-weight="600">0</text>
                            <text x="270" y="160" text-anchor="middle" fill="#ffffff" font-size="14" font-weight="600">30</text>
                            <text x="150" y="280" text-anchor="middle" fill="#ffffff" font-size="14" font-weight="600">50</text>
                            <text x="30" y="160" text-anchor="middle" fill="#ffffff" font-size="14" font-weight="600">70</text>
                        </svg>
                    </div>
                    <div class="text-center mt-4">
                        <div style="position: relative; width: 100%; padding: 10px 0;">
                            <!-- ç™½è‰²è¾…åŠ©ç›´çº¿ -->
                            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: #ffffff; opacity: 1; transform: translateY(-50%); z-index: 0;"></div>
                            <!-- æ»‘å— -->
                            <input type="range" id="speed-slider" min="0" max="70" value="0" step="1" class="w-full" style="position: relative; z-index: 1; top: 50%; transform: translateY(-50%);">
                        </div>
                        <div class="mt-2">
                            <span class="text-2xl font-bold text-white" id="speed-value">0</span>
                            <span class="text-white ml-1 opacity-80">km/h</span>
                        </div>
                        <div class="mt-2 text-sm text-white" id="speed-zone">åˆå§‹çŠ¶æ€</div>
                    </div>
                    <button class="btn-primary w-full mt-4" id="start-simulation">
                        <i class="fas fa-play mr-2"></i>å¼€å§‹æ¨¡æ‹Ÿ
                    </button>
                    <button class="btn-primary w-full mt-2" id="reset-simulation" style="background: transparent; border-color: #ffffff;">
                        <i class="fas fa-redo mr-2"></i>é‡ç½®
                    </button>
                </div>

            </div>
        </div>

        <!-- ä½œè€…ä¿¡æ¯ -->
        <div class="text-center mt-12 pt-8 border-t border-white border-opacity-20">
            <p class="text-white text-xs mt-2 opacity-60">Â© é£è·ƒå‡é€Ÿå¸¦å®éªŒç³»ç»Ÿ</p>
        </div>
    </div>

    <!-- å·¥å…·æç¤º -->
    <div class="tooltip" id="tooltip"></div>

    <!-- å›¾è¡¨æç¤ºå¼¹çª— -->
    <div class="modal" id="chart-tip-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="text-center">
                <div class="mb-4" style="font-size: 48px;">
                    <i class="fas fa-info-circle" style="color: #00D9FF;"></i>
                </div>
                <h2 class="text-xl font-bold mb-3 text-white">æç¤º</h2>
                <p class="text-white opacity-90 mb-6">è¯·å…ˆæ¨¡æ‹Ÿä¸€æ¬¡å®éªŒï¼Œä¹‹åå°†è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ã€‚</p>
                <button class="btn-primary" id="close-chart-tip" style="min-width: 100px;">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- ä¼¦ç†åˆ†ææç¤ºæ¨¡æ€æ¡† -->
    <div class="modal" id="ethics-modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-white">ä¼¦ç†åˆ†ææç¤º</h2>
            <div class="text-white space-y-4 mb-6 opacity-90">
                <p>äº²çˆ±çš„ç”¨æˆ·ï¼Œ</p>
                <p>æ‚¨å³å°†å°†æ¨¡æ‹Ÿé€Ÿåº¦è°ƒæ•´è‡³é«˜é€ŸåŒºé—´ã€‚åœ¨æ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›æé†’æ‚¨ï¼š</p>
                <ul class="list-disc list-inside space-y-2 ml-4">
                    <li><strong>å®‰å…¨ç¬¬ä¸€</strong>ï¼šåœ¨ç°å®ä¸–ç•Œä¸­ï¼Œä»¥é«˜é€Ÿé€šè¿‡å‡é€Ÿå¸¦æ˜¯æå…¶å±é™©çš„ï¼Œå¯èƒ½å¯¼è‡´è½¦è¾†å¤±æ§ã€ç¢°æ’ç”šè‡³ç¿»è½¦ã€‚</li>
                    <li><strong>æ¨¡æ‹Ÿé£é™©</strong>ï¼šè™½ç„¶è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿç¯å¢ƒï¼Œä½†é«˜é€Ÿé©¾é©¶ä»ç„¶å¯èƒ½å¯¹è™šæ‹Ÿè½¦è¾†é€ æˆä¸¥é‡æŸå®³ï¼Œå¹¶å½±å“æ¨¡æ‹Ÿçš„å‡†ç¡®æ€§ã€‚</li>
                    <li><strong>æ•™è‚²æ„ä¹‰</strong>ï¼šæˆ‘ä»¬è®¾è®¡è¿™ä¸ªæ¨¡æ‹Ÿæ˜¯ä¸ºäº†æ•™è‚²å…¬ä¼—å…³äºè½¦è¾†åŠ¨åŠ›å­¦å’Œå‡é€Ÿå¸¦å®‰å…¨ã€‚è¯·è®°ä½ï¼Œæ¨¡æ‹Ÿçš„ç›®çš„æ˜¯ä¸ºäº†å­¦ä¹ å’Œç†è§£ï¼Œè€Œéå®é™…é©¾é©¶è¡Œä¸ºã€‚</li>
                </ul>
                <p>å› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨åœ¨é«˜é€ŸåŒºé—´è°¨æ…æ“ä½œï¼Œä»¥å……åˆ†ç†è§£é«˜é€Ÿé©¾é©¶çš„æ½œåœ¨é£é™©ï¼Œå¹¶ç¡®ä¿æ¨¡æ‹Ÿçš„å®‰å…¨æ€§å’Œæ•™è‚²ä»·å€¼ã€‚</p>
            </div>
            <div class="flex gap-4">
                <button class="btn-primary flex-1" id="confirm-high-speed">ç¡®è®¤</button>
                <button class="btn-primary flex-1" style="background: transparent; border-color: #ffffff;" id="cancel-high-speed">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ€§æ ¼ä¸æ­£ä¹‰æ„Ÿæ¢ç´¢å¼¹å‡ºçª—å£ -->
    <div class="modal" id="explore-modal">
        <div class="modal-content" style="max-width: 650px; background: #000000; border: 2px solid #00D9FF; animation: fadeInScale 0.3s ease; box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);">
            <div class="text-center text-white">
                <div class="mb-6">
                    <div class="mb-4" style="animation: bounce 1s infinite;">
                        <i class="fas fa-user-circle" style="font-size: 80px; color: #fff;"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-3">æ˜¯å¦é€‰æ‹©æ¢ç´¢ä½ çš„æ€§æ ¼ç‰¹ç‚¹ä¸æ­£ä¹‰æ„ŸæŒ‡æ•°</h2>
                    <p class="text-lg opacity-90 mb-4">åŸºäºä½ çš„é€‰æ‹©ï¼Œæˆ‘ä»¬å°†ä¸ºä½ ç”Ÿæˆä¸€ä»½ä¸ªæ€§åŒ–çš„åˆ†ææŠ¥å‘Š</p>
                </div>
                <div class="bg-white bg-opacity-10 rounded-lg p-5 mb-6 backdrop-blur-sm">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-shield-alt text-2xl mt-1"></i>
                        <div class="text-left">
                            <p class="font-semibold mb-2">æ•°æ®å®‰å…¨æ‰¿è¯º</p>
                            <p class="text-sm opacity-90">
                                æˆ‘ä»¬æ‰¿è¯ºï¼šä½ çš„æ•°æ®å°†è¢«ä¸¥æ ¼ä¿æŠ¤ï¼Œä»…ç”¨äºç”Ÿæˆä¸ªæ€§åŒ–æŠ¥å‘Šï¼Œä¸ä¼šç”¨äºå…¶ä»–ä»»ä½•ç›®çš„ã€‚æ‰€æœ‰åˆ†æå‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button class="btn-primary flex-1 text-lg py-4" id="explore-btn" style="background: #fff; color: #667eea; font-weight: 600; transition: all 0.3s;">
                        <i class="fas fa-compass mr-2"></i>æ¢ç´¢
                    </button>
                    <button class="btn-primary flex-1 text-lg py-4" id="not-interested-btn" style="background: rgba(255,255,255,0.2); color: #fff; border: 2px solid #fff; transition: all 0.3s;">
                        <i class="fas fa-times mr-2"></i>ä¸æ„Ÿå…´è¶£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯è§†åŒ–æŠ¥å‘Šæ¨¡æ€æ¡† -->
    <div class="modal" id="report-modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; height: 90vh; overflow: hidden; background: #000000; padding: 15px; display: flex; flex-direction: column; border: 2px solid #00D9FF;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #00D9FF;">
                <h2 style="font-size: 20px; color: #00D9FF; margin: 0;">
                    <i class="fas fa-chart-line mr-2"></i>æ€§æ ¼ä¸æ­£ä¹‰æ„Ÿåˆ†ææŠ¥å‘Š
                </h2>
                <button class="close-report" style="background: transparent; border: 2px solid #ffffff; color: #ffffff; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    <i class="fas fa-times mr-2"></i>å…³é—­
                </button>
            </div>
            <div id="report-content" style="flex: 1; overflow-y: auto; padding-right: 8px;"></div>
        </div>
    </div>

    <!-- ç‰©ç†å­¦å®¶åˆ†ææ¨¡å— -->
    <div class="modal" id="physics-analysis-modal">
        <div class="modal-content" style="max-width: 90%; max-height: 95vh; overflow: hidden; background: #000000; padding: 20px; display: flex; flex-direction: column; border: 2px solid #00FF88;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #00FF88;">
                <h2 style="font-size: 24px; color: #00FF88; margin: 0;">
                    <i class="fas fa-atom mr-2"></i>ç‰©ç†å­¦å®¶å…¬å¼åˆ†æ
                </h2>
                <button class="close-physics-analysis" style="background: transparent; border: 2px solid #ffffff; color: #ffffff; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s;">
                    <i class="fas fa-times mr-2"></i>å…³é—­
                </button>
            </div>
            <div id="physics-analysis-content" style="flex: 1; overflow-y: auto; padding-right: 10px; color: #ffffff; line-height: 1.8;">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <style>
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* ç‰©ç†å­¦å®¶åˆ†ææ¨¡æ€æ¡†æ ·å¼ */
        #physics-analysis-modal .modal-content {
            animation: fadeInScale 0.3s ease;
        }
        
        #physics-analysis-content {
            scrollbar-width: thin;
            scrollbar-color: #28a745 #1a1a1a;
        }
        
        #physics-analysis-content::-webkit-scrollbar {
            width: 8px;
        }
        
        #physics-analysis-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        #physics-analysis-content::-webkit-scrollbar-thumb {
            background: #28a745;
            border-radius: 4px;
        }
        
        #physics-analysis-content::-webkit-scrollbar-thumb:hover {
            background: #20c997;
        }
        
        #explore-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255,255,255,0.3);
        }
        
        #not-interested-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: scale(1.05);
        }
        
        .close-physics-analysis:hover {
            background: #dc3545 !important;
            transform: scale(1.05);
        }
        
        .report-section {
            padding: 15px 18px;
            margin-bottom: 12px;
            background: transparent;
            border-radius: 8px;
            border: 2px solid #00D9FF;
        }
        
        .report-cover {
            text-align: center;
            padding: 25px 20px;
            background: transparent;
            border: 2px solid #00D9FF;
            border-radius: 10px;
            color: white;
            margin-bottom: 15px;
        }
        
        /* æŠ¥å‘Šå°æ¨¡å—æ‚¬åœæ•ˆæœ */
        .report-chart,
        .report-section > div[style*="border"],
        .report-section div[style*="background: transparent"],
        .report-section div[style*="background: #222"] {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .report-chart:hover,
        .report-section > div[style*="border"]:hover,
        .report-section div[style*="background: transparent"]:hover,
        .report-section div[style*="background: #222"]:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.5);
        }
        
        .report-cover h1 {
            font-size: 28px !important;
            margin-bottom: 10px !important;
        }
        
        .report-cover p {
            font-size: 14px !important;
        }
        
        .report-chart {
            margin: 10px 0;
            padding: 12px;
            background: transparent;
            border-radius: 6px;
            border: 1px solid #00D9FF;
            min-height: 200px;
        }
        
        /* ç´§å‡‘å¸ƒå±€ */
        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .report-grid-full {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 1200px) {
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .report-section {
                padding: 20px !important;
            }
            
            .report-cover h1 {
                font-size: 32px !important;
            }
            
            .report-chart {
                padding: 10px !important;
            }
            
            #personality-radar-chart,
            #personality-pie-chart {
                min-height: 250px;
            }
        }
        
        /* å›¾è¡¨äº¤äº’æ ·å¼ */
        .report-chart svg {
            display: block;
            margin: 0 auto;
        }
        
        .report-chart circle,
        .report-chart rect,
        .report-chart path {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .report-chart circle:hover,
        .report-chart rect:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }
    </style>

    <!-- å¯è§†åŒ–æŠ¥å‘Šé¡µé¢ -->
    <div class="modal" id="report-modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; max-height: 95vh; overflow-y: auto; background: #000000; position: relative; border: 2px solid #00D9FF;">
            <button class="close-report" style="position: absolute; top: 20px; right: 20px; background: transparent; border: 2px solid #ffffff; color: #ffffff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 1000;">
                <i class="fas fa-times"></i>
            </button>
            <div id="report-content" class="space-y-8 p-8">
                <!-- æŠ¥å‘Šå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- JavaScript ä»£ç  -->
    <script>
        // ========== æ•°æ®å®šä¹‰ ==========
        const vehicleParams = {
            'èŠ‚èƒ½å‹å°å‹è½¦': {
                mass: { min: 1000, max: 1500, avg: 1250 },
                springStiffness: { min: 5000, max: 10000, avg: 7500 },
                dampingCoeff: { min: 50, max: 150, avg: 100 }
            },
            'é«˜æ€§èƒ½è·‘è½¦': {
                mass: { min: 1200, max: 1800, avg: 1500 },
                springStiffness: { min: 10000, max: 20000, avg: 15000 },
                dampingCoeff: { min: 100, max: 200, avg: 150 }
            },
            'å…¨å°ºå¯¸SUV': {
                mass: { min: 2000, max: 3000, avg: 2500 },
                springStiffness: { min: 15000, max: 30000, avg: 22500 },
                dampingCoeff: { min: 150, max: 300, avg: 225 }
            },
            'è±ªåè½¿è½¦': {
                mass: { min: 1500, max: 2000, avg: 1750 },
                springStiffness: { min: 8000, max: 15000, avg: 11500 },
                dampingCoeff: { min: 100, max: 200, avg: 150 }
            },
            'å¤§å¡è½¦': {
                mass: { min: 15000, max: 40000, avg: 27500 },
                springStiffness: { min: 10000, max: 30000, avg: 20000 },
                dampingCoeff: { min: 100, max: 200, avg: 150 }
            }
        };

        const speedBumpParams = {
            'æ©¡èƒ¶å‡é€Ÿå¸¦': {
                forceAmplitude: { min: 1000, max: 5000, avg: 3000 },
                frequency: { min: 1, max: 10, avg: 5.5 },
                length: { min: 2, max: 5, avg: 3.5 },
                height: { min: 0.05, max: 0.20, avg: 0.125 }
            },
            'é‡‘å±å‡é€Ÿå¸¦': {
                forceAmplitude: { min: 5000, max: 15000, avg: 10000 },
                frequency: { min: 1, max: 10, avg: 5.5 },
                length: { min: 3, max: 6, avg: 4.5 },
                height: { min: 0.10, max: 0.30, avg: 0.20 }
            },
            'æ³¡æ²«å‡é€Ÿå¸¦': {
                forceAmplitude: { min: 500, max: 2000, avg: 1250 },
                frequency: { min: 0.5, max: 5, avg: 2.75 },
                length: { min: 2, max: 4, avg: 3 },
                height: { min: 0.02, max: 0.10, avg: 0.06 }
            },
            'æ°´å‹å‡é€Ÿå¸¦': {
                forceAmplitude: { min: 100, max: 1000, avg: 550 },
                frequency: { min: 0.1, max: 1, avg: 0.55 },
                length: { min: 2, max: 5, avg: 3.5 },
                height: { min: 0.05, max: 0.15, avg: 0.10 }
            }
        };

        const locationFactors = {
            'å­¦æ ¡é—¨å£': { safetyFactor: 0.9, legalPenalty: 1.2 },
            'æ£®æ—': { safetyFactor: 0.85, legalPenalty: 1.1 },
            'å†å²é—è¿¹é™„è¿‘': { safetyFactor: 0.8, legalPenalty: 1.5 },
            'æ™®é€šè·‘é“': { safetyFactor: 1.0, legalPenalty: 0.8 },
            'å±±åœ°æ»‘å¡': { safetyFactor: 0.3, legalPenalty: 2.0 }  // é«˜é£é™©ï¼Œå¤§å¹…é™ä½å¹¸å­˜ç‡
        };

        const g = 9.81;
        // é™ä½å®‰å…¨åŠ é€Ÿåº¦é˜ˆå€¼ï¼Œä½¿è®¡ç®—æ›´ä¸¥æ ¼ï¼ˆ2g = 19.6 m/sÂ²ï¼Œè¶…è¿‡æ­¤å€¼é£é™©æ˜¾è‘—å¢åŠ ï¼‰
        const MAX_SAFE_ACCELERATION = 2 * g; // ä»3gé™ä½åˆ°2g
        const MAX_SAFE_DISPLACEMENT = 0.3;
        const MAX_SAFE_VELOCITY_CHANGE = 10;
        
        // å¤©æ°”å¯¹æ‘©æ“¦ç³»æ•°çš„å½±å“
        const weatherFrictionFactors = {
            'æ™´': 1.0,
            'å¤šäº‘': 0.95,
            'é˜´': 0.85,
            'é›¨': 0.6,
            'é›ª': 0.3
        };
        
        // ç¯ä¿è¯„åˆ†
        const ecoScores = {
            vehicle: {
                'èŠ‚èƒ½å‹å°å‹è½¦': 10,
                'é«˜æ€§èƒ½è·‘è½¦': 7,
                'å…¨å°ºå¯¸SUV': 4,
                'è±ªåè½¿è½¦': 3,
                'å¤§å¡è½¦': 2
            },
            bump: {
                'æ³¡æ²«å‡é€Ÿå¸¦': 8,
                'æ©¡èƒ¶å‡é€Ÿå¸¦': 6,
                'é‡‘å±å‡é€Ÿå¸¦': 4,
                'æ°´å‹å‡é€Ÿå¸¦': 3
            },
            location: {
                'æ™®é€šè·‘é“': 9,
                'æ£®æ—': 7,
                'å­¦æ ¡é—¨å£': 6,
                'å†å²é—è¿¹é™„è¿‘': 5,
                'å±±åœ°æ»‘å¡': 3
            }
        };

        // ========== çŠ¶æ€ç®¡ç† ==========
        let currentVehicle = 'èŠ‚èƒ½å‹å°å‹è½¦';
        let currentBump = 'æ©¡èƒ¶å‡é€Ÿå¸¦';
        let currentLocation = 'å­¦æ ¡é—¨å£';
        let currentSpeed = 0;
        let currentWeather = 'æ™´'; // é»˜è®¤å¤©æ°”
        let isSimulating = false;
        let simulationResult = null;
        let sessionId = `session_${Date.now()}`;
        // ========== é…ç½®ç®¡ç† ==========
        const CONFIG = {
            API_BASE_URL: (window.location.protocol === 'file:' || window.location.protocol === '') 
                ? 'http://localhost:5001' 
                : (window.location.origin || 'http://localhost:5001'),
            STREAMING_DELAY: 50,  // æµå¼è¾“å‡ºå»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
            ANALYSIS_TIMEOUT: 60000,  // åˆ†æè¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            CHART_UPDATE_DELAY: 300  // å›¾è¡¨æ›´æ–°å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
        };
        const API_BASE_URL = CONFIG.API_BASE_URL;
        console.log('API_BASE_URL:', API_BASE_URL);
        console.log('å½“å‰é¡µé¢åè®®:', window.location.protocol);
        console.log('å½“å‰é¡µé¢origin:', window.location.origin);
        
        // ========== å·¥å…·å‡½æ•° ==========
        // å…¬å¼æ¸…ç†å‡½æ•° - ç»Ÿä¸€å¤„ç†LaTeXæ ¼å¼
        function cleanFormula(formula) {
            return formula
                // å…ˆå¤„ç†åµŒå¥—ç»“æ„
                .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1)/($2)')
                .replace(/\\sqrt\{([^}]+)\}/g, 'âˆš($1)')
                .replace(/\\sqrt\[(\d+)\]\{([^}]+)\}/g, '$1âˆš($2)')
                // å¤„ç†å¸Œè…Šå­—æ¯ï¼ˆå¸¦ä¸‹æ ‡çš„å…ˆå¤„ç†ï¼‰
                .replace(/\\omega_n/g, 'Ï‰_n')
                .replace(/\\omega/g, 'Ï‰')
                .replace(/\\zeta/g, 'Î¶')
                .replace(/\\alpha/g, 'Î±')
                .replace(/\\beta/g, 'Î²')
                .replace(/\\gamma/g, 'Î³')
                .replace(/\\theta/g, 'Î¸')
                .replace(/\\pi/g, 'Ï€')
                .replace(/\\Delta/g, 'Î”')
                .replace(/\\lambda/g, 'Î»')
                .replace(/\\mu/g, 'Î¼')
                .replace(/\\sigma/g, 'Ïƒ')
                .replace(/\\phi/g, 'Ï†')
                .replace(/\\chi/g, 'Ï‡')
                .replace(/\\psi/g, 'Ïˆ')
                // å¤„ç†æ•°å­¦å‡½æ•°
                .replace(/\\exp\(/g, 'exp(')
                .replace(/\\exp/g, 'exp')
                .replace(/\\max\(/g, 'max(')
                .replace(/\\max/g, 'max')
                .replace(/\\min\(/g, 'min(')
                .replace(/\\min/g, 'min')
                .replace(/\\sin\(/g, 'sin(')
                .replace(/\\sin/g, 'sin')
                .replace(/\\cos\(/g, 'cos(')
                .replace(/\\cos/g, 'cos')
                .replace(/\\tan\(/g, 'tan(')
                .replace(/\\tan/g, 'tan')
                .replace(/\\ln\(/g, 'ln(')
                .replace(/\\ln/g, 'ln')
                .replace(/\\log\(/g, 'log(')
                .replace(/\\log/g, 'log')
                // å¤„ç†æ–‡æœ¬å‘½ä»¤
                .replace(/\\text\{([^}]+)\}/g, '$1')
                .replace(/\\mathrm\{([^}]+)\}/g, '$1')
                .replace(/\\mathit\{([^}]+)\}/g, '$1')
                // å¤„ç†ä¸Šæ ‡å’Œä¸‹æ ‡ï¼ˆå…ˆå¤„ç†å¸¦èŠ±æ‹¬å·çš„ï¼‰
                .replace(/\^\{([^}]+)\}/g, '^$1')
                .replace(/_\{([^}]+)\}/g, '_$1')
                .replace(/\^(\d+)/g, '^$1')
                .replace(/_(\d+)/g, '_$1')
                // æœ€åç§»é™¤æ‰€æœ‰å‰©ä½™çš„èŠ±æ‹¬å·
                .replace(/\{([^}]+)\}/g, '$1')
                // æ¸…ç†å¤šä½™çš„åæ–œæ 
                .replace(/\\/g, '')
                // æ¸…ç†å¤šä½™ç©ºæ ¼
                .replace(/\s+/g, ' ')
                .trim();
        }

        // ========== å·¥å…·æç¤ºåŠŸèƒ½ ==========
        const tooltip = d3.select('#tooltip');
        
        document.querySelectorAll('.select-option').forEach(option => {
            option.addEventListener('mouseenter', function(e) {
                const tooltipText = this.getAttribute('data-tooltip');
                if (tooltipText) {
                    tooltip
                        .html(tooltipText)
                        .style('left', (e.pageX + 10) + 'px')
                        .style('top', (e.pageY + 10) + 'px')
                        .classed('show', true);
                }
            });
            
            option.addEventListener('mouseleave', function() {
                tooltip.classed('show', false);
            });
            
            option.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const value = this.getAttribute('data-value');
                
                // ç§»é™¤å…¶ä»–é€‰é¡¹çš„activeç±»
                document.querySelectorAll(`[data-type="${type}"]`).forEach(el => {
                    el.classList.remove('active');
                });
                
                // æ·»åŠ activeç±»
                this.classList.add('active');
                
                // æ›´æ–°çŠ¶æ€
                if (type === 'vehicle') {
                    currentVehicle = value;
                } else if (type === 'bump') {
                    currentBump = value;
                } else if (type === 'location') {
                    currentLocation = value;
                }
            });
        });

        // ========== å¤©æ°”é€‰æ‹©åŠŸèƒ½ ==========
        document.querySelectorAll('.weather-option').forEach(option => {
            option.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.weather-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                
                // æ·»åŠ activeç±»
                this.classList.add('active');
                
                // æ›´æ–°å¤©æ°”çŠ¶æ€
                currentWeather = this.getAttribute('data-weather');
            });
        });
        
        // é»˜è®¤é€‰ä¸­"æ™´"
        document.querySelector('.weather-option[data-weather="æ™´"]')?.classList.add('active');

        // ========== é€Ÿåº¦è¡¨åŠŸèƒ½ ==========
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const speedZone = document.getElementById('speed-zone');
        const lowSpeedArc = document.getElementById('low-speed-arc');
        const midSpeedArc = document.getElementById('mid-speed-arc');
        const highSpeedArc = document.getElementById('high-speed-arc');
        const ethicsModal = document.getElementById('ethics-modal');
        let hasConfirmedHighSpeed = false;

        function updateSpeedometer(speed) {
            currentSpeed = speed;
            speedValue.textContent = speed;
            
            // æ›´æ–°Emojiè¡¨æƒ…
            const emojiElement = document.getElementById('speed-emoji');
            if (speed === 0) {
                emojiElement.textContent = 'ğŸ˜Š';
            } else if (speed < 20) {
                emojiElement.textContent = 'ğŸ˜Š';
            } else if (speed < 35) {
                emojiElement.textContent = 'ğŸ™‚';
            } else if (speed < 45) {
                emojiElement.textContent = 'ğŸ˜';
            } else if (speed < 55) {
                emojiElement.textContent = 'ğŸ˜Ÿ';
            } else if (speed < 65) {
                emojiElement.textContent = 'ğŸ˜¨';
            } else {
                emojiElement.textContent = 'ğŸ˜±';
            }
            
            // æ›´æ–°é€Ÿåº¦åŒºé—´æ˜¾ç¤ºå’Œé¢œè‰²
            let zoneText = '';
            let zoneColor = '';
            
            if (speed === 0) {
                zoneText = 'åˆå§‹çŠ¶æ€';
                zoneColor = '#ffffff';
                lowSpeedArc.style.stroke = '#ffffff';
                lowSpeedArc.style.strokeOpacity = '0.2';
                midSpeedArc.style.stroke = '#ffffff';
                midSpeedArc.style.strokeOpacity = '0.2';
                highSpeedArc.style.stroke = '#ffffff';
                highSpeedArc.style.strokeOpacity = '0.2';
            } else if (speed > 0 && speed < 30) {
                zoneText = 'ä½é€ŸåŒºé—´';
                zoneColor = '#00FF88';
                lowSpeedArc.style.stroke = '#00FF88';
                lowSpeedArc.style.strokeOpacity = '1';
                midSpeedArc.style.stroke = '#ffffff';
                midSpeedArc.style.strokeOpacity = '0.2';
                highSpeedArc.style.stroke = '#ffffff';
                highSpeedArc.style.strokeOpacity = '0.2';
            } else if (speed >= 30 && speed < 50) {
                zoneText = 'ä¸­é€ŸåŒºé—´';
                zoneColor = '#ffffff';
                lowSpeedArc.style.stroke = '#ffffff';
                lowSpeedArc.style.strokeOpacity = '0.2';
                midSpeedArc.style.stroke = '#ffffff';
                midSpeedArc.style.strokeOpacity = '1';
                highSpeedArc.style.stroke = '#ffffff';
                highSpeedArc.style.strokeOpacity = '0.2';
            } else if (speed >= 50) {
                zoneText = 'é«˜é€ŸåŒºé—´';
                zoneColor = '#FF0040';
                lowSpeedArc.style.stroke = '#ffffff';
                lowSpeedArc.style.strokeOpacity = '0.2';
                midSpeedArc.style.stroke = '#ffffff';
                midSpeedArc.style.strokeOpacity = '0.2';
                highSpeedArc.style.stroke = '#FF0040';
                highSpeedArc.style.strokeOpacity = '1';
                
                // å¦‚æœè¿›å…¥é«˜é€ŸåŒºé—´ä¸”æœªç¡®è®¤ï¼Œæ˜¾ç¤ºæç¤ºæ¡†
                if (!hasConfirmedHighSpeed && speed >= 50) {
                    ethicsModal.classList.add('show');
                }
            }
            
            speedZone.textContent = zoneText;
            speedZone.style.color = zoneColor;
        }

        speedSlider.addEventListener('input', function() {
            const speed = parseInt(this.value);
            
            // æ£€æŸ¥æ˜¯å¦è¿›å…¥é«˜é€ŸåŒºé—´
            if (speed >= 50 && !hasConfirmedHighSpeed) {
                updateSpeedometer(speed);
                return; // ç­‰å¾…ç”¨æˆ·ç¡®è®¤
            }
            
            updateSpeedometer(speed);
        });

        // æ¨¡æ€æ¡†æŒ‰é’®
        document.getElementById('confirm-high-speed').addEventListener('click', function() {
            hasConfirmedHighSpeed = true;
            ethicsModal.classList.remove('show');
            updateSpeedometer(currentSpeed);
        });

        document.getElementById('cancel-high-speed').addEventListener('click', function() {
            speedSlider.value = 45; // å›åˆ°ä¸­é€ŸåŒºé—´
            updateSpeedometer(45);
            ethicsModal.classList.remove('show');
        });

        // ========== ç‰©ç†è®¡ç®—å‡½æ•° ==========
        function calculatePhysicsResponse(v0, vehicle, speedBump) {
            const m = vehicle.mass.avg;
            const k = vehicle.springStiffness.avg;
            const c = vehicle.dampingCoeff.avg;
            const F0 = speedBump.forceAmplitude.avg;
            const omega = speedBump.frequency.avg * 2 * Math.PI;
            const L = speedBump.length.avg;
            const H = speedBump.height.avg;
            
            const t_pass = L / v0;
            const omega_n = Math.sqrt(k / m);
            const zeta = c / (2 * Math.sqrt(k * m));
            
            const impactVelocity = v0;
            const maxDisplacement = (F0 / k) * (1 + Math.exp(-zeta * omega_n * t_pass));
            const maxAcceleration = (F0 / m) + (omega_n * omega_n * maxDisplacement);
            const velocityChange = Math.abs(impactVelocity - v0 * Math.exp(-zeta * omega_n * t_pass));
            const bounceHeight = Math.max(0, (maxDisplacement - H) * 0.5);
            
            return {
                maxDisplacement,
                maxAcceleration,
                velocityChange,
                bounceHeight,
                t_pass,
                omega_n,
                zeta
            };
        }

        function calculateSurvivalRate(speed, vehicleType, speedBumpType, location = 'å­¦æ ¡é—¨å£') {
            const v0 = speed / 3.6;
            const vehicle = vehicleParams[vehicleType];
            const speedBump = speedBumpParams[speedBumpType];
            const locationFactor = locationFactors[location] || locationFactors['å­¦æ ¡é—¨å£'];
            
            if (!vehicle || !speedBump) {
                return { error: 'å‚æ•°é”™è¯¯' };
            }
            
            const physics = calculatePhysicsResponse(v0, vehicle, speedBump);
            
            const risks = {
                accelerationRisk: Math.min(100, (physics.maxAcceleration / MAX_SAFE_ACCELERATION) * 100),
                displacementRisk: Math.min(100, (physics.maxDisplacement / MAX_SAFE_DISPLACEMENT) * 100),
                velocityChangeRisk: Math.min(100, (physics.velocityChange / MAX_SAFE_VELOCITY_CHANGE) * 100),
                bounceRisk: physics.bounceHeight > 0.1 ? 80 : (physics.bounceHeight > 0.05 ? 50 : 20)
            };
            
            // é€Ÿåº¦é£é™©è®¡ç®— - æ›´ä¸¥æ ¼çš„æƒ©ç½šæœºåˆ¶
            let speedRisk = 0;
            if (speed >= 30 && speed < 50) {
                speedRisk = 15 + (speed - 30) * 1.5; // 30-50: 15-45
            } else if (speed >= 50 && speed < 70) {
                speedRisk = 45 + (speed - 50) * 4; // 50-70: 45-125ï¼Œä½†ä¼šè¢«é™åˆ¶åˆ°100
            } else if (speed >= 70 && speed < 90) {
                speedRisk = 100; // 70ä»¥ä¸Šç›´æ¥100%é£é™©
            } else if (speed >= 90) {
                speedRisk = 100; // 90ä»¥ä¸Šç›´æ¥100%é£é™©
            }
            speedRisk = Math.min(100, speedRisk);
            
            // è°ƒæ•´æƒé‡ï¼Œå¢åŠ é€Ÿåº¦é£é™©çš„é‡è¦æ€§ï¼Œå¹¶è®©é«˜é€Ÿæ—¶é£é™©æ›´ä¸¥æ ¼
            let speedWeight = 0.20; // åŸºç¡€æƒé‡
            if (speed >= 70) {
                speedWeight = 0.35; // 70ä»¥ä¸Šé€Ÿåº¦é£é™©æƒé‡æå‡åˆ°35%
            } else if (speed >= 50) {
                speedWeight = 0.28; // 50-70é€Ÿåº¦é£é™©æƒé‡æå‡åˆ°28%
            }
            
            const totalRisk = (
                risks.accelerationRisk * 0.25 +
                risks.displacementRisk * 0.20 +
                risks.velocityChangeRisk * 0.20 +
                risks.bounceRisk * 0.15 +
                speedRisk * speedWeight
            ) * locationFactor.safetyFactor;
            
            // å¯¹äºæé™é€Ÿåº¦ï¼ˆ70ä»¥ä¸Šï¼‰ï¼Œé¢å¤–å¢åŠ é£é™©æƒ©ç½š
            let finalRisk = totalRisk;
            if (speed >= 70) {
                const extraRisk = (speed - 70) * 2.5; // æ¯å¢åŠ 1km/hï¼Œé¢å¤–å¢åŠ 2.5%é£é™©
                finalRisk = Math.min(100, totalRisk + extraRisk);
            }
            
            const survivalRate = Math.max(0, Math.min(100, 100 - finalRisk));
            
            let result = 'æœªçŸ¥';
            let color = '#666';
            let className = 'survival-safe';
            
            if (survivalRate >= 80) {
                result = 'å®‰å…¨é€šè¿‡';
                color = '#28a745';
                className = 'survival-safe';
            } else if (survivalRate >= 60) {
                result = 'å¯èƒ½é€šè¿‡';
                color = '#ffc107';
                className = 'survival-warning';
            } else if (survivalRate >= 40) {
                result = 'å±é™©';
                color = '#fd7e14';
                className = 'survival-warning';
            } else {
                result = 'æå±é™©';
                color = '#dc3545';
                className = 'survival-danger';
            }
            
            return {
                survivalRate: Math.round(survivalRate),
                result,
                color,
                className,
                physics,
                risks,
                speedRisk
            };
        }


        // ========== æ™ºèƒ½æ¨èç³»ç»Ÿ ==========
        
        // è®¡ç®—æ¨èè¯„åˆ†
        function calculateRecommendationScore(vehicle, bump, location, weather, targetType, testSpeed = 50) {
            const vehicleData = vehicleParams[vehicle];
            const bumpData = speedBumpParams[bump];
            const locationData = locationFactors[location];
            const weatherFactor = weatherFrictionFactors[weather] || 1.0;
            
            if (!vehicleData || !bumpData || !locationData) return 0;
            
            let score = 0;
            
            switch(targetType) {
                case 'max-speed':
                    // æœ€é«˜é€Ÿåº¦æŒ‘æˆ˜ï¼šæµ‹è¯•åœ¨50-70km/hèŒƒå›´å†…çš„æœ€é«˜å¯æ‰¿å—é€Ÿåº¦
                    let maxSafeSpeed = 0;
                    for (let speed = 50; speed <= 70; speed += 5) {
                        const result = calculateSurvivalRate(speed, vehicle, bump, location);
                        if (result.survivalRate >= 40) {
                            maxSafeSpeed = speed;
                        } else {
                            break;
                        }
                    }
                    score = maxSafeSpeed * 1.5; // é€Ÿåº¦è¶Šé«˜åˆ†æ•°è¶Šé«˜
                    // è€ƒè™‘è½¦è¾†è´¨é‡ï¼ˆè´¨é‡å¤§çš„è½¦è¾†æ›´ç¨³å®šï¼‰
                    score += vehicleData.mass.avg / 100;
                    break;
                    
                case 'safest':
                    // æœ€å®‰å…¨ï¼šåœ¨30km/hä¸‹è®¡ç®—å¹¸å­˜ç‡
                    const safeResult = calculateSurvivalRate(30, vehicle, bump, location);
                    score = safeResult.survivalRate * 10;
                    // åœ°ç‚¹å®‰å…¨ç³»æ•°åŠ æˆ
                    score += locationData.safetyFactor * 20;
                    // å¤©æ°”å½±å“ï¼ˆæ™´å¤©æ›´å®‰å…¨ï¼‰
                    score *= weatherFactor;
                    break;
                    
                case 'eco-friendly':
                    // æœ€ç¯ä¿ï¼šåŸºäºç¯ä¿è¯„åˆ†
                    score = ecoScores.vehicle[vehicle] * 10;
                    score += ecoScores.bump[bump] * 5;
                    score += ecoScores.location[location] * 5;
                    // å¤©æ°”å½±å“ï¼ˆæ™´å¤©å¯¹ç¯å¢ƒå½±å“è¾ƒå°ï¼‰
                    if (weather === 'æ™´') score += 10;
                    break;
                    
                case 'extreme':
                    // æœ€æç«¯ï¼šé«˜é£é™©ä½†å¯æµ‹è¯•
                    const extremeResult = calculateSurvivalRate(50, vehicle, bump, location);
                    // éœ€è¦æœ‰ä¸€å®šé£é™©ï¼ˆå¹¸å­˜ç‡20-50%ï¼‰
                    if (extremeResult.survivalRate < 20 || extremeResult.survivalRate > 50) {
                        score = 0;
                    } else {
                        score = (50 - extremeResult.survivalRate) * 2; // é£é™©è¶Šé«˜åˆ†æ•°è¶Šé«˜
                        // ä¼˜å…ˆé€‰æ‹©é«˜é£é™©åœ°ç‚¹å’Œè½¦è¾†
                        if (location === 'å±±åœ°æ»‘å¡') score += 30;
                        if (vehicle === 'å¤§å¡è½¦') score += 20;
                        if (bump === 'é‡‘å±å‡é€Ÿå¸¦') score += 15;
                    }
                    break;
                    
                case 'balanced':
                    // å¹³è¡¡é€‰æ‹©ï¼šç»¼åˆè€ƒè™‘å®‰å…¨ã€é€Ÿåº¦ã€ç¯ä¿
                    const balancedResult = calculateSurvivalRate(40, vehicle, bump, location);
                    const safetyScore = balancedResult.survivalRate * 0.4;
                    const speedScore = Math.min(100, (vehicleData.mass.avg / 200) * 100) * 0.3;
                    const ecoScore = (ecoScores.vehicle[vehicle] + ecoScores.bump[bump] + ecoScores.location[location]) / 3 * 0.3;
                    score = safetyScore + speedScore + ecoScore;
                    break;
            }
            
            return Math.round(score * 100) / 100;
        }
        
        // ç”Ÿæˆæ¨èç†ç”±
        function generateRecommendationReason(recommendation, targetType) {
            const { vehicle, bump, location, weather, preview } = recommendation;
            const reasons = {
                'max-speed': [
                    `${vehicle}å…·æœ‰è¾ƒå¤§çš„è´¨é‡å’Œè¾ƒé«˜çš„å¼¹ç°§åˆšåº¦ï¼Œèƒ½å¤Ÿæ‰¿å—æ›´é«˜çš„å†²å‡»åŠ›ã€‚`,
                    `${bump}ä¸${location}çš„ç»„åˆåœ¨é«˜é€Ÿä¸‹ä»èƒ½ä¿æŒç›¸å¯¹ç¨³å®šã€‚`,
                    `åœ¨${weather}å¤©æ°”æ¡ä»¶ä¸‹ï¼Œé¢„è®¡å¯æ‰¿å—${preview.maxSpeed}km/hçš„é€Ÿåº¦ã€‚`
                ],
                'safest': [
                    `${vehicle}ä¸${bump}çš„ç»„åˆåœ¨${location}ç¯å¢ƒä¸‹å…·æœ‰æœ€ä½³çš„å®‰å…¨æ€§èƒ½ã€‚`,
                    `é¢„è®¡åœ¨30km/hé€Ÿåº¦ä¸‹å¹¸å­˜ç‡å¯è¾¾${preview.survivalRate}%ã€‚`,
                    `${weather}å¤©æ°”æ¡ä»¶æä¾›äº†è‰¯å¥½çš„è·¯é¢æ‘©æ“¦ç³»æ•°ã€‚`
                ],
                'eco-friendly': [
                    `${vehicle}æ˜¯ç¯ä¿è¯„åˆ†è¾ƒé«˜çš„è½¦å‹ï¼Œ${bump}å¯¹ç¯å¢ƒçš„å½±å“ä¹Ÿè¾ƒå°ã€‚`,
                    `é€‰æ‹©${location}å¯ä»¥æœ€å°åŒ–å¯¹ç¯å¢ƒçš„è´Ÿé¢å½±å“ã€‚`,
                    `è¯¥ç»„åˆåœ¨ä¿æŒåŠŸèƒ½æ€§çš„åŒæ—¶ï¼Œæœ€å¤§ç¨‹åº¦å‡å°‘äº†ç¯å¢ƒè´Ÿæ‹…ã€‚`
                ],
                'extreme': [
                    `è¯¥ç»„åˆå…·æœ‰è¾ƒé«˜çš„é£é™©æ€§ï¼Œé€‚åˆè¿›è¡Œæé™æµ‹è¯•ã€‚`,
                    `${vehicle}åœ¨${location}çš„${bump}ä¸Šï¼Œé¢„è®¡åœ¨50km/hä¸‹å¹¸å­˜ç‡ä¸º${preview.survivalRate}%ã€‚`,
                    `è­¦å‘Šï¼šæ­¤ç»„åˆé£é™©æé«˜ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚`
                ],
                'balanced': [
                    `è¯¥ç»„åˆåœ¨é€Ÿåº¦ã€å®‰å…¨å’Œç¯ä¿ä¹‹é—´å–å¾—äº†è‰¯å¥½å¹³è¡¡ã€‚`,
                    `${vehicle}ä¸${bump}çš„ç»„åˆåœ¨${location}ç¯å¢ƒä¸‹è¡¨ç°å‡è¡¡ã€‚`,
                    `é¢„è®¡åœ¨40km/hé€Ÿåº¦ä¸‹å¹¸å­˜ç‡çº¦ä¸º${preview.survivalRate}%ï¼Œé€‚åˆä¸€èˆ¬æµ‹è¯•ã€‚`
                ]
            };
            
            return reasons[targetType] || ['è¿™æ˜¯ä¸€ä¸ªæ¨èçš„å˜é‡ç»„åˆã€‚'];
        }
        
        // è®¡ç®—æ¨è
        function calculateRecommendation(targetType, testSpeed = 50) {
            const allCombinations = [];
            const vehicles = Object.keys(vehicleParams);
            const bumps = Object.keys(speedBumpParams);
            const locations = Object.keys(locationFactors);
            const weathers = ['æ™´', 'å¤šäº‘', 'é˜´', 'é›¨', 'é›ª'];
            
            // éå†æ‰€æœ‰ç»„åˆ
            vehicles.forEach(vehicle => {
                bumps.forEach(bump => {
                    locations.forEach(location => {
                        weathers.forEach(weather => {
                            const score = calculateRecommendationScore(vehicle, bump, location, weather, targetType, testSpeed);
                            if (score > 0) {
                                // è®¡ç®—é¢„è§ˆæ•°æ®
                                let previewSpeed = testSpeed;
                                if (targetType === 'max-speed') {
                                    previewSpeed = 60; // é»˜è®¤é¢„è§ˆé€Ÿåº¦
                                } else if (targetType === 'safest') {
                                    previewSpeed = 30;
                                } else if (targetType === 'balanced') {
                                    previewSpeed = 40;
                                } else if (targetType === 'extreme') {
                                    previewSpeed = 50;
                                }
                                
                                const previewResult = calculateSurvivalRate(previewSpeed, vehicle, bump, location);
                                
                                // è®¡ç®—æœ€é«˜å¯æ‰¿å—é€Ÿåº¦ï¼ˆä»…å¯¹max-speedï¼‰
                                let maxSpeed = previewSpeed;
                                if (targetType === 'max-speed') {
                                    for (let s = previewSpeed; s <= 70; s += 5) {
                                        const r = calculateSurvivalRate(s, vehicle, bump, location);
                                        if (r.survivalRate >= 40) {
                                            maxSpeed = s;
                                        } else {
                                            break;
                                        }
                                    }
                                }
                                
                                allCombinations.push({
                                    vehicle,
                                    bump,
                                    location,
                                    weather,
                                    score,
                                    preview: {
                                        survivalRate: previewResult.survivalRate,
                                        maxSpeed: maxSpeed
                                    }
                                });
                            }
                        });
                    });
                });
            });
            
            // æŒ‰åˆ†æ•°æ’åºï¼Œå–å‰3å
            allCombinations.sort((a, b) => b.score - a.score);
            return allCombinations.slice(0, 3);
        }
        
        // åº”ç”¨æ¨è
        function applyRecommendation(recommendation) {
            const { vehicle, bump, location, weather } = recommendation;
            
            // æ›´æ–°è½¦è¾†é€‰æ‹©
            document.querySelectorAll('[data-type="vehicle"]').forEach(el => {
                el.classList.remove('active');
                if (el.getAttribute('data-value') === vehicle) {
                    el.classList.add('active');
                    currentVehicle = vehicle;
                }
            });
            
            // æ›´æ–°å‡é€Ÿå¸¦é€‰æ‹©
            document.querySelectorAll('[data-type="bump"]').forEach(el => {
                el.classList.remove('active');
                if (el.getAttribute('data-value') === bump) {
                    el.classList.add('active');
                    currentBump = bump;
                }
            });
            
            // æ›´æ–°åœ°ç‚¹é€‰æ‹©
            document.querySelectorAll('[data-type="location"]').forEach(el => {
                el.classList.remove('active');
                if (el.getAttribute('data-value') === location) {
                    el.classList.add('active');
                    currentLocation = location;
                }
            });
            
            // æ›´æ–°å¤©æ°”é€‰æ‹©
            document.querySelectorAll('.weather-option').forEach(el => {
                el.classList.remove('active');
                if (el.getAttribute('data-weather') === weather) {
                    el.classList.add('active');
                    currentWeather = weather;
                }
            });
            
            // æ˜¾ç¤ºåº”ç”¨æˆåŠŸæç¤º
            const container = document.getElementById('recommendations-container');
            const successMsg = document.createElement('div');
            successMsg.className = 'recommendation-card';
            successMsg.style.borderColor = '#00FF88';
            successMsg.innerHTML = `
                <div style="color: #00FF88; font-size: 12px; text-align: center;">
                    <i class="fas fa-check-circle mr-2"></i>æ¨èå·²åº”ç”¨ï¼
                </div>
            `;
            container.insertBefore(successMsg, container.firstChild);
            
            setTimeout(() => {
                successMsg.style.opacity = '0';
                successMsg.style.transition = 'opacity 0.5s';
                setTimeout(() => successMsg.remove(), 500);
            }, 2000);
        }
        
        // æ˜¾ç¤ºæ¨èç»“æœ
        function displayRecommendations(recommendations, targetType) {
            const container = document.getElementById('recommendations-container');
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="recommendation-card" style="text-align: center; color: #888; font-size: 12px;">
                        æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¨èç»„åˆ
                    </div>
                `;
                return;
            }
            
            recommendations.forEach((rec, index) => {
                const reason = generateRecommendationReason(rec, targetType);
                const badgeText = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] || 'â­';
                
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                card.innerHTML = `
                    <div class="recommendation-header">
                        <span class="recommendation-badge">${badgeText} æ¨è ${index + 1}</span>
                        <span style="font-size: 11px; color: #888;">è¯„åˆ†: ${rec.score.toFixed(1)}</span>
                    </div>
                    <div class="recommendation-vars">
                        <div><i class="fas fa-car mr-1"></i>${rec.vehicle}</div>
                        <div><i class="fas fa-road mr-1"></i>${rec.bump}</div>
                        <div><i class="fas fa-map-marker-alt mr-1"></i>${rec.location}</div>
                        <div><i class="fas fa-cloud-sun mr-1"></i>${rec.weather}</div>
                    </div>
                    <div class="recommendation-reason">
                        ${reason.join(' ')}
                    </div>
                    <div class="recommendation-preview">
                        <i class="fas fa-chart-line mr-1"></i>
                        é¢„æœŸå¹¸å­˜ç‡: ${rec.preview.survivalRate}%
                        ${targetType === 'max-speed' ? ` | æœ€é«˜é€Ÿåº¦: ${rec.preview.maxSpeed}km/h` : ''}
                    </div>
                    <button class="apply-btn" data-recommendation='${JSON.stringify(rec).replace(/'/g, "&apos;")}'>
                        <i class="fas fa-check mr-1"></i>åº”ç”¨æ¨è
                    </button>
                `;
                
                // ç»‘å®šåº”ç”¨æŒ‰é’®äº‹ä»¶
                const applyBtn = card.querySelector('.apply-btn');
                applyBtn.addEventListener('click', function() {
                    applyRecommendation(rec);
                });
                
                container.appendChild(card);
            });
        }
        
        // ç»‘å®šæ¨èæŒ‰é’®äº‹ä»¶
        document.getElementById('get-recommendations').addEventListener('click', function() {
            const targetType = document.getElementById('recommendation-target').value;
            const recommendations = calculateRecommendation(targetType);
            displayRecommendations(recommendations, targetType);
        });
        
        // ========== æ¨¡æ‹ŸåŠŸèƒ½ ==========
        document.getElementById('start-simulation').addEventListener('click', async function() {
            if (isSimulating) return;
            
            isSimulating = true;
            this.disabled = true;
            
            // æ˜¾ç¤ºè®¡ç®—ä¸­çŠ¶æ€
            const display = document.getElementById('survival-display');
            display.className = 'survival-display survival-safe';
            display.innerHTML = `
                <div class="text-2xl mb-2">
                    <i class="fas fa-cog fa-spin mr-2"></i>
                    ç‰©ç†å­¦å®¶æ­£åœ¨è®¡ç®—ä¸­...
                </div>
                <div class="text-sm opacity-90">è¯·ç¨å€™ï¼Œæ­£åœ¨è¿ç”¨ç‰©ç†å…¬å¼è¿›è¡Œç²¾ç¡®è®¡ç®—</div>
            `;
            
            const details = document.getElementById('survival-details');
            details.innerHTML = `
                <div class="text-center mt-4 text-white text-sm opacity-80">
                    <i class="fas fa-atom fa-spin mr-2"></i>
                    å»ºç«‹ç‰©ç†æ¨¡å‹ â†’ æ¨å¯¼å…¬å¼ â†’ è¿›è¡Œè®¡ç®— â†’ éªŒè¯ç»“æœ
                </div>
            `;
            
            try {
                // è°ƒç”¨ç‰©ç†å­¦å®¶APIè®¡ç®—æ¨¡æ‹Ÿç»“æœï¼ˆæµå¼è¾“å‡ºï¼‰
                const requestData = {
                    session_id: sessionId,
                    vehicle: currentVehicle || 'æœªçŸ¥',
                    bump: currentBump || 'æœªçŸ¥',
                    location: currentLocation || 'æœªçŸ¥',
                    weather: currentWeather || 'æ™´',
                    speed: currentSpeed || 0,
                    stream: true  // ä½¿ç”¨æµå¼è¾“å‡º
                };
                
                // ä½¿ç”¨æµå¼è¾“å‡ºæ¥æ”¶è®¡ç®—ç»“æœ
                await streamPhysicsCalculation(requestData, display, details);
                        
            } catch (error) {
                console.error('ç‰©ç†å­¦å®¶è®¡ç®—å¤±è´¥:', error);
                // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨å‰ç«¯è®¡ç®—ä½œä¸ºåå¤‡
                simulationResult = calculateSurvivalRate(currentSpeed, currentVehicle, currentBump, currentLocation);
                
                display.className = `survival-display ${simulationResult.className}`;
                display.innerHTML = `
                    <div class="text-4xl mb-2">${simulationResult.survivalRate}%</div>
                    <div class="text-xl">${simulationResult.result}</div>
                `;
                
                details.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <div class="text-white text-xs opacity-80">æœ€å¤§åŠ é€Ÿåº¦</div>
                            <div class="text-lg font-semibold">${simulationResult.physics.maxAcceleration.toFixed(2)} m/sÂ²</div>
                        </div>
                        <div>
                            <div class="text-white text-xs opacity-80">å¼¹è·³é«˜åº¦</div>
                            <div class="text-lg font-semibold">${(simulationResult.physics.bounceHeight * 100).toFixed(2)} cm</div>
                        </div>
                    </div>
                `;
                
                updateCharts();
                
                isSimulating = false;
                this.disabled = false;
            }
        });

        document.getElementById('reset-simulation').addEventListener('click', function() {
            // é‡ç½®æ˜¾ç¤º
            document.getElementById('survival-display').className = 'survival-display survival-safe';
            document.getElementById('survival-display').innerHTML = `
                <div class="text-2xl mb-2">ç­‰å¾…æ¨¡æ‹Ÿ</div>
                <div class="text-sm opacity-90">è¯·é€‰æ‹©å‚æ•°å¹¶å¼€å§‹æ¨¡æ‹Ÿ</div>
            `;
            document.getElementById('survival-details').innerHTML = '';
            document.getElementById('explore-modal').classList.remove('show');
            document.getElementById('report-modal').style.display = 'none';
            document.getElementById('physics-analysis-modal').style.display = 'none';
            simulationResult = null;
            isSimulating = false;
            document.getElementById('start-simulation').disabled = false;
            // ç”Ÿæˆæ–°çš„ä¼šè¯ID
            sessionId = `session_${Date.now()}`;
        });

        // ========== D3.js å›¾è¡¨ ==========
        function updateCharts() {
            if (!simulationResult) return;
            
            // 1. é€Ÿåº¦ä¸äº‹æ•…æ¦‚ç‡çƒ­åŠ›å›¾
            updateHeatmap();
            
            // 2. å†²å‡»åŠ›åŠ¨æ€å›¾
            updateImpactChart();
            
            // 3. é€Ÿåº¦-æ—¶é—´æ›²çº¿å›¾
            updateSpeedTimeChart();
        }
        
        function updateHeatmap() {
            const container = d3.select('#heatmap-chart');
            container.selectAll('*').remove();
            
            const width = container.node().offsetWidth || 600;
            const height = 400;
            const margin = { top: 40, right: 40, bottom: 60, left: 60 };
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // ç”Ÿæˆæ›´å¯†é›†çš„æ•°æ®ç‚¹
            const speeds = d3.range(10, 71, 1);
            const probabilities = speeds.map(speed => {
                const result = calculateSurvivalRate(speed, currentVehicle, currentBump, currentLocation);
                return 100 - result.survivalRate;
            });
            
            // åˆ›å»ºç½‘æ ¼æ•°æ®
            const gridSize = 3;
            const xScale = d3.scaleLinear()
                .domain([10, 70])
                .range([margin.left, width - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);
            
            // åˆ›å»ºé¢œè‰²æ¸å˜
            const colorScale = d3.scaleSequential(d3.interpolateRdYlGn)
                .domain([100, 0]);
            
            // åˆ›å»ºçƒ­åŠ›å›¾æ•°æ®
            const heatmapData = [];
            speeds.forEach((speed, i) => {
                const prob = probabilities[i];
                const x = xScale(speed);
                const y = yScale(prob);
                heatmapData.push({ speed, prob, x, y });
            });
            
            // ç»˜åˆ¶çƒ­åŠ›å›¾ç‚¹
            svg.selectAll('circle')
                .data(heatmapData)
                .enter()
                .append('circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', 4)
                .attr('fill', d => colorScale(d.prob))
                .attr('opacity', 0.8)
                .attr('stroke', '#1a1a1a')
                .attr('stroke-width', 0.5)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 6).attr('opacity', 1);
                    tooltip
                        .html(`é€Ÿåº¦: ${d.speed} km/h<br>äº‹æ•…æ¦‚ç‡: ${d.prob.toFixed(1)}%`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY + 10) + 'px')
                        .classed('show', true);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 4).attr('opacity', 0.8);
                    tooltip.classed('show', false);
                });
            
            // æ·»åŠ è¶‹åŠ¿çº¿
            const line = d3.line()
                .x(d => d.x)
                .y(d => d.y)
                .curve(d3.curveMonotoneX);
            
            svg.append('path')
                .datum(heatmapData)
                .attr('fill', 'none')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .attr('opacity', 0.6)
                .attr('d', line);
            
            // æ·»åŠ å½“å‰é€Ÿåº¦æ ‡è®°
            const currentX = xScale(currentSpeed);
            svg.append('line')
                .attr('x1', currentX)
                .attr('x2', currentX)
                .attr('y1', margin.top)
                .attr('y2', height - margin.bottom)
                .attr('stroke', '#fff')
                .attr('stroke-width', 3)
                .attr('stroke-dasharray', '8,4')
                .attr('opacity', 0.9);
            
            svg.append('circle')
                .attr('cx', currentX)
                .attr('cy', yScale(probabilities[speeds.indexOf(Math.round(currentSpeed))]))
                .attr('r', 8)
                .attr('fill', '#fff')
                .attr('stroke', '#667eea')
                .attr('stroke-width', 3);
            
            // æ·»åŠ é£é™©åŒºåŸŸèƒŒæ™¯
            const riskZones = [
                { y: yScale(80), label: 'æé«˜é£é™©', color: 'rgba(220, 53, 69, 0.2)' },
                { y: yScale(60), label: 'é«˜é£é™©', color: 'rgba(255, 193, 7, 0.2)' },
                { y: yScale(40), label: 'ä¸­ç­‰é£é™©', color: 'rgba(40, 167, 69, 0.2)' }
            ];
            
            riskZones.forEach((zone, i) => {
                const nextY = i < riskZones.length - 1 ? riskZones[i + 1].y : height - margin.bottom;
                svg.append('rect')
                    .attr('x', margin.left)
                    .attr('y', zone.y)
                    .attr('width', width - margin.left - margin.right)
                    .attr('height', nextY - zone.y)
                    .attr('fill', zone.color)
                    .attr('opacity', 0.3);
            });
            
            // æ·»åŠ åæ ‡è½´
            const xAxis = d3.axisBottom(xScale)
                .ticks(12)
                .tickFormat(d => d + ' km/h');
            const yAxis = d3.axisLeft(yScale)
                .ticks(10)
                .tickFormat(d => d + '%');
            
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(xAxis)
                .attr('color', '#888')
                .selectAll('text')
                .style('font-size', '11px');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(yAxis)
                .attr('color', '#888')
                .selectAll('text')
                .style('font-size', '11px');
            
            // æ·»åŠ ç½‘æ ¼çº¿
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).ticks(12).tickSize(-height + margin.top + margin.bottom))
                .attr('color', '#333')
                .select('.domain').remove();
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).ticks(10).tickSize(-width + margin.left + margin.right))
                .attr('color', '#333')
                .select('.domain').remove();
            
            // æ·»åŠ æ ‡é¢˜å’Œæ ‡ç­¾
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', 20)
                .attr('text-anchor', 'middle')
                .attr('fill', '#e5e5e5')
                .attr('font-size', '14px')
                .attr('font-weight', '600')
                .text('é€Ÿåº¦ä¸äº‹æ•…æ¦‚ç‡å…³ç³»åˆ†æ');
            
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 10)
                .attr('text-anchor', 'middle')
                .attr('fill', '#888')
                .attr('font-size', '12px')
                .text('é€Ÿåº¦ (km/h)');
            
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', 25)
                .attr('text-anchor', 'middle')
                .attr('fill', '#888')
                .attr('font-size', '12px')
                .text('äº‹æ•…æ¦‚ç‡ (%)');
            
            // æ·»åŠ å›¾ä¾‹
            const legendWidth = 200;
            const legendHeight = 20;
            const legendX = width - margin.right - legendWidth;
            const legendY = margin.top;
            
            const legendScale = d3.scaleLinear()
                .domain([0, 100])
                .range([0, legendWidth]);
            
            const legendData = d3.range(0, 101, 1);
            svg.selectAll('.legend-rect')
                .data(legendData)
                .enter()
                .append('rect')
                .attr('class', 'legend-rect')
                .attr('x', (d, i) => legendX + (i / 100) * legendWidth)
                .attr('y', legendY)
                .attr('width', legendWidth / 100)
                .attr('height', legendHeight)
                .attr('fill', d => colorScale(d));
            
            svg.append('text')
                .attr('x', legendX)
                .attr('y', legendY - 5)
                .attr('fill', '#888')
                .attr('font-size', '10px')
                .text('ä½é£é™©');
            
            svg.append('text')
                .attr('x', legendX + legendWidth)
                .attr('y', legendY - 5)
                .attr('text-anchor', 'end')
                .attr('fill', '#888')
                .attr('font-size', '10px')
                .text('é«˜é£é™©');
        }

        function updateImpactChart() {
            const container = d3.select('#impact-chart');
            container.selectAll('*').remove();
            
            const width = container.node().offsetWidth || 600;
            const height = 350;
            const margin = { top: 40, right: 40, bottom: 60, left: 70 };
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // ç”Ÿæˆæ›´å¯†é›†çš„æ—¶é—´æ•°æ®
            const timeSteps = d3.range(0, 3, 0.02);
            const vehicle = vehicleParams[currentVehicle];
            const speedBump = speedBumpParams[currentBump];
            const v0 = currentSpeed / 3.6;
            const F0 = speedBump.forceAmplitude.avg;
            const omega = speedBump.frequency.avg * 2 * Math.PI;
            const m = vehicle.mass.avg;
            const k = vehicle.springStiffness.avg;
            const c = vehicle.dampingCoeff.avg;
            const omega_n = Math.sqrt(k / m);
            const zeta = c / (2 * Math.sqrt(k * m));
            
            const impactForces = timeSteps.map(t => {
                if (t < 0.3) {
                    // æ¥è¿‘å‡é€Ÿå¸¦
                    return F0 * 0.3 * Math.sin(omega * t * 2);
                } else if (t < 0.8) {
                    // æ¥è§¦å‡é€Ÿå¸¦
                    const contactTime = t - 0.3;
                    return F0 * Math.sin(omega * contactTime) * (1 + Math.exp(-zeta * omega_n * contactTime));
                } else if (t < 1.5) {
                    // ç¦»å¼€å‡é€Ÿå¸¦
                    const leaveTime = t - 0.8;
                    return F0 * Math.sin(omega * leaveTime) * Math.exp(-zeta * omega_n * leaveTime * 3);
                } else {
                    // æ¢å¤é˜¶æ®µ
                    return 0;
                }
            });
            
            const maxForce = d3.max(impactForces);
            const xScale = d3.scaleLinear()
                .domain([0, 3])
                .range([margin.left, width - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain([0, maxForce * 1.1])
                .range([height - margin.bottom, margin.top]);
            
            // åˆ›å»ºåŒºåŸŸå¡«å……
            const area = d3.area()
                .x((d, i) => xScale(timeSteps[i]))
                .y0(height - margin.bottom)
                .y1((d, i) => yScale(impactForces[i]))
                .curve(d3.curveMonotoneX);
            
            // æ·»åŠ æ¸å˜å®šä¹‰
            const gradient = svg.append('defs')
                .append('linearGradient')
                .attr('id', 'impact-gradient')
                .attr('x1', '0%')
                .attr('y1', '0%')
                .attr('x2', '0%')
                .attr('y2', '100%');
            
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', '#667eea')
                .attr('stop-opacity', 0.8);
            
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', '#764ba2')
                .attr('stop-opacity', 0.3);
            
            // ç»˜åˆ¶å¡«å……åŒºåŸŸ
            svg.append('path')
                .datum(impactForces)
                .attr('fill', 'url(#impact-gradient)')
                .attr('d', area);
            
            // ç»˜åˆ¶ä¸»æ›²çº¿
            const line = d3.line()
                .x((d, i) => xScale(timeSteps[i]))
                .y((d, i) => yScale(impactForces[i]))
                .curve(d3.curveMonotoneX);
            
            svg.append('path')
                .datum(impactForces)
                .attr('fill', 'none')
                .attr('stroke', '#667eea')
                .attr('stroke-width', 3)
                .attr('d', line);
            
            // æ ‡è®°å³°å€¼ç‚¹
            const maxIndex = impactForces.indexOf(maxForce);
            const maxTime = timeSteps[maxIndex];
            
            svg.append('circle')
                .attr('cx', xScale(maxTime))
                .attr('cy', yScale(maxForce))
                .attr('r', 6)
                .attr('fill', '#dc3545')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);
            
            svg.append('line')
                .attr('x1', xScale(maxTime))
                .attr('x2', xScale(maxTime))
                .attr('y1', margin.top)
                .attr('y2', yScale(maxForce))
                .attr('stroke', '#dc3545')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '4,4')
                .attr('opacity', 0.5);
            
            svg.append('line')
                .attr('x1', margin.left)
                .attr('x2', xScale(maxTime))
                .attr('y1', yScale(maxForce))
                .attr('y2', yScale(maxForce))
                .attr('stroke', '#dc3545')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '4,4')
                .attr('opacity', 0.5);
            
            svg.append('text')
                .attr('x', xScale(maxTime) + 10)
                .attr('y', yScale(maxForce) - 10)
                .attr('fill', '#dc3545')
                .attr('font-size', '11px')
                .attr('font-weight', '600')
                .text(`å³°å€¼: ${maxForce.toFixed(0)} N`);
            
            // æ·»åŠ å®‰å…¨é˜ˆå€¼çº¿
            const safeThreshold = 5000;
            if (maxForce > safeThreshold) {
                svg.append('line')
                    .attr('x1', margin.left)
                    .attr('x2', width - margin.right)
                    .attr('y1', yScale(safeThreshold))
                    .attr('y2', yScale(safeThreshold))
                    .attr('stroke', '#ffc107')
                    .attr('stroke-width', 2)
                    .attr('stroke-dasharray', '8,4')
                    .attr('opacity', 0.7);
                
                svg.append('text')
                    .attr('x', width - margin.right - 5)
                    .attr('y', yScale(safeThreshold) - 5)
                    .attr('text-anchor', 'end')
                    .attr('fill', '#ffc107')
                    .attr('font-size', '10px')
                    .text('å®‰å…¨é˜ˆå€¼');
            }
            
            // æ·»åŠ é˜¶æ®µæ ‡è®°
            const phases = [
                { start: 0, end: 0.3, label: 'æ¥è¿‘', color: '#28a745' },
                { start: 0.3, end: 0.8, label: 'æ¥è§¦', color: '#dc3545' },
                { start: 0.8, end: 1.5, label: 'ç¦»å¼€', color: '#ffc107' },
                { start: 1.5, end: 3, label: 'æ¢å¤', color: '#6c757d' }
            ];
            
            phases.forEach(phase => {
                svg.append('rect')
                    .attr('x', xScale(phase.start))
                    .attr('y', margin.top)
                    .attr('width', xScale(phase.end) - xScale(phase.start))
                    .attr('height', 15)
                    .attr('fill', phase.color)
                    .attr('opacity', 0.2);
                
                svg.append('text')
                    .attr('x', xScale((phase.start + phase.end) / 2))
                    .attr('y', margin.top + 12)
                    .attr('text-anchor', 'middle')
                    .attr('fill', phase.color)
                    .attr('font-size', '10px')
                    .attr('font-weight', '600')
                    .text(phase.label);
            });
            
            // æ·»åŠ åæ ‡è½´
            const xAxis = d3.axisBottom(xScale)
                .ticks(10)
                .tickFormat(d => d.toFixed(1) + 's');
            const yAxis = d3.axisLeft(yScale)
                .ticks(8)
                .tickFormat(d => d.toFixed(0));
            
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(xAxis)
                .attr('color', '#888')
                .selectAll('text')
                .style('font-size', '11px');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(yAxis)
                .attr('color', '#888')
                .selectAll('text')
                .style('font-size', '11px');
            
            // æ·»åŠ ç½‘æ ¼çº¿
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).ticks(10).tickSize(-height + margin.top + margin.bottom))
                .attr('color', '#333')
                .select('.domain').remove();
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).ticks(8).tickSize(-width + margin.left + margin.right))
                .attr('color', '#333')
                .select('.domain').remove();
            
            // æ·»åŠ æ ‡é¢˜å’Œæ ‡ç­¾
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', 20)
                .attr('text-anchor', 'middle')
                .attr('fill', '#e5e5e5')
                .attr('font-size', '14px')
                .attr('font-weight', '600')
                .text('å†²å‡»åŠ›åŠ¨æ€å˜åŒ–åˆ†æ');
            
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 10)
                .attr('text-anchor', 'middle')
                .attr('fill', '#888')
                .attr('font-size', '12px')
                .text('æ—¶é—´ (ç§’)');
            
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('fill', '#888')
                .attr('font-size', '12px')
                .text('å†²å‡»åŠ› (ç‰›é¡¿)');
        }

        function updateSpeedTimeChart() {
            const container = d3.select('#speed-time-chart');
            container.selectAll('*').remove();
            
            const width = container.node().offsetWidth || 600;
            const height = 350;
            const margin = { top: 40, right: 40, bottom: 60, left: 70 };
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // ç”Ÿæˆæ›´å¯†é›†çš„æ—¶é—´æ•°æ®
            const timeSteps = d3.range(0, 4, 0.02);
            const v0 = currentSpeed / 3.6;
            const vehicle = vehicleParams[currentVehicle];
            const speedBump = speedBumpParams[currentBump];
            const m = vehicle.mass.avg;
            const k = vehicle.springStiffness.avg;
            const c = vehicle.dampingCoeff.avg;
            const omega_n = Math.sqrt(k / m);
            const zeta = c / (2 * Math.sqrt(k * m));
            const L = speedBump.length.avg;
            const t_pass = L / v0;
            
            const speeds = timeSteps.map(t => {
                if (t < 0.5) {
                    // æ¥è¿‘é˜¶æ®µï¼Œé€Ÿåº¦åŸºæœ¬ä¸å˜
                    return v0;
                } else if (t < 0.5 + t_pass) {
                    // é€šè¿‡å‡é€Ÿå¸¦ï¼Œé€Ÿåº¦ä¸‹é™
                    const contactTime = t - 0.5;
                    const decelFactor = 1 - (contactTime / t_pass) * 0.4;
                    return v0 * decelFactor;
                } else if (t < 1.5 + t_pass) {
                    // ç¦»å¼€å‡é€Ÿå¸¦ï¼Œé€æ¸æ¢å¤
                    const recoveryTime = t - (0.5 + t_pass);
                    const recoveryFactor = 0.6 + (recoveryTime / 1.0) * 0.3;
                    return v0 * recoveryFactor;
                } else {
                    // ç¨³å®šé˜¶æ®µ
                    return v0 * 0.9;
                }
            });
            
            const accelerations = timeSteps.map((t, i) => {
                if (i === 0) return 0;
                const dt = timeSteps[i] - timeSteps[i-1];
                return (speeds[i] - speeds[i-1]) / dt;
            });
            
            const xScale = d3.scaleLinear()
                .domain([0, 4])
                .range([margin.left, width - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(speeds) * 1.2])
                .range([height - margin.bottom, margin.top]);
            
            const yScaleAccel = d3.scaleLinear()
                .domain([d3.min(accelerations) * 1.2, d3.max(accelerations) * 1.2])
                .range([height - margin.bottom, margin.top]);
            
            // åˆ›å»ºé€Ÿåº¦åŒºåŸŸå¡«å……
            const area = d3.area()
                .x((d, i) => xScale(timeSteps[i]))
                .y0(height - margin.bottom)
                .y1((d, i) => yScale(speeds[i]))
                .curve(d3.curveMonotoneX);
            
            // æ·»åŠ æ¸å˜
            const gradient = svg.append('defs')
                .append('linearGradient')
                .attr('id', 'speed-gradient')
                .attr('x1', '0%')
                .attr('y1', '0%')
                .attr('x2', '0%')
                .attr('y2', '100%');
            
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', '#28a745')
                .attr('stop-opacity', 0.6);
            
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', '#20c997')
                .attr('stop-opacity', 0.2);
            
            // ç»˜åˆ¶é€Ÿåº¦åŒºåŸŸ
            svg.append('path')
                .datum(speeds)
                .attr('fill', 'url(#speed-gradient)')
                .attr('d', area);
            
            // ç»˜åˆ¶é€Ÿåº¦æ›²çº¿
            const line = d3.line()
                .x((d, i) => xScale(timeSteps[i]))
                .y((d, i) => yScale(speeds[i]))
                .curve(d3.curveMonotoneX);
            
            svg.append('path')
                .datum(speeds)
                .attr('fill', 'none')
                .attr('stroke', '#28a745')
                .attr('stroke-width', 3)
                .attr('d', line);
            
            // ç»˜åˆ¶åŠ é€Ÿåº¦æ›²çº¿ï¼ˆè¾…åŠ©çº¿ï¼‰
            const accelLine = d3.line()
                .x((d, i) => xScale(timeSteps[i]))
                .y((d, i) => yScaleAccel(accelerations[i]))
                .curve(d3.curveMonotoneX);
            
            svg.append('path')
                .datum(accelerations)
                .attr('fill', 'none')
                .attr('stroke', '#ffc107')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5')
                .attr('opacity', 0.6)
                .attr('d', accelLine);
            
            // æ ‡è®°å…³é”®ç‚¹
            const minSpeed = d3.min(speeds);
            const minIndex = speeds.indexOf(minSpeed);
            const minTime = timeSteps[minIndex];
            
            svg.append('circle')
                .attr('cx', xScale(minTime))
                .attr('cy', yScale(minSpeed))
                .attr('r', 6)
                .attr('fill', '#dc3545')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);
            
            svg.append('text')
                .attr('x', xScale(minTime) + 10)
                .attr('y', yScale(minSpeed) - 10)
                .attr('fill', '#dc3545')
                .attr('font-size', '11px')
                .attr('font-weight', '600')
                .text(`æœ€ä½: ${(minSpeed * 3.6).toFixed(1)} km/h`);
            
            // æ ‡è®°å‡é€Ÿå¸¦é€šè¿‡åŒºé—´
            const bumpStart = 0.5;
            const bumpEnd = 0.5 + t_pass;
            
            svg.append('rect')
                .attr('x', xScale(bumpStart))
                .attr('y', margin.top)
                .attr('width', xScale(bumpEnd) - xScale(bumpStart))
                .attr('height', height - margin.top - margin.bottom)
                .attr('fill', '#dc3545')
                .attr('opacity', 0.1);
            
            svg.append('line')
                .attr('x1', xScale(bumpStart))
                .attr('x2', xScale(bumpStart))
                .attr('y1', margin.top)
                .attr('y2', height - margin.bottom)
                .attr('stroke', '#dc3545')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '8,4')
                .attr('opacity', 0.5);
            
            svg.append('line')
                .attr('x1', xScale(bumpEnd))
                .attr('x2', xScale(bumpEnd))
                .attr('y1', margin.top)
                .attr('y2', height - margin.bottom)
                .attr('stroke', '#dc3545')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '8,4')
                .attr('opacity', 0.5);
            
            svg.append('text')
                .attr('x', xScale((bumpStart + bumpEnd) / 2))
                .attr('y', margin.top + 15)
                .attr('text-anchor', 'middle')
                .attr('fill', '#dc3545')
                .attr('font-size', '11px')
                .attr('font-weight', '600')
                .text('å‡é€Ÿå¸¦');
            
            // æ·»åŠ é€Ÿåº¦åŒºé—´æ ‡è®°
            const speedZones = [
                { threshold: v0 * 0.9, label: 'ç¨³å®šé€Ÿåº¦', color: '#28a745' },
                { threshold: v0 * 0.7, label: 'å‡é€Ÿé˜¶æ®µ', color: '#ffc107' },
                { threshold: v0 * 0.5, label: 'æœ€ä½é€Ÿåº¦', color: '#dc3545' }
            ];
            
            speedZones.forEach(zone => {
                svg.append('line')
                    .attr('x1', margin.left)
                    .attr('x2', width - margin.right)
                    .attr('y1', yScale(zone.threshold))
                    .attr('y2', yScale(zone.threshold))
                    .attr('stroke', zone.color)
                    .attr('stroke-width', 1)
                    .attr('stroke-dasharray', '4,4')
                    .attr('opacity', 0.4);
            });
            
            // æ·»åŠ æ•°æ®ç‚¹
            const keyPoints = [0, 0.5, bumpEnd, 2, 4];
            keyPoints.forEach(time => {
                const index = timeSteps.findIndex(t => Math.abs(t - time) < 0.05);
                if (index >= 0) {
                    svg.append('circle')
                        .attr('cx', xScale(timeSteps[index]))
                        .attr('cy', yScale(speeds[index]))
                        .attr('r', 4)
                        .attr('fill', '#fff')
                        .attr('stroke', '#28a745')
                        .attr('stroke-width', 2);
                }
            });
            
            // æ·»åŠ åæ ‡è½´
            const xAxis = d3.axisBottom(xScale)
                .ticks(10)
                .tickFormat(d => d.toFixed(1) + 's');
            const yAxis = d3.axisLeft(yScale)
                .ticks(8)
                .tickFormat(d => (d * 3.6).toFixed(0) + ' km/h');
            
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(xAxis)
                .attr('color', '#888')
                .selectAll('text')
                .style('font-size', '11px');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(yAxis)
                .attr('color', '#888')
                .selectAll('text')
                .style('font-size', '11px');
            
            // æ·»åŠ ç½‘æ ¼çº¿
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).ticks(10).tickSize(-height + margin.top + margin.bottom))
                .attr('color', '#333')
                .select('.domain').remove();
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(yScale).ticks(8).tickSize(-width + margin.left + margin.right))
                .attr('color', '#333')
                .select('.domain').remove();
            
            // æ·»åŠ æ ‡é¢˜å’Œæ ‡ç­¾
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', 20)
                .attr('text-anchor', 'middle')
                .attr('fill', '#e5e5e5')
                .attr('font-size', '14px')
                .attr('font-weight', '600')
                .text('é€Ÿåº¦-æ—¶é—´åŠ¨æ€å˜åŒ–æ›²çº¿');
            
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 10)
                .attr('text-anchor', 'middle')
                .attr('fill', '#888')
                .attr('font-size', '12px')
                .text('æ—¶é—´ (ç§’)');
            
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('fill', '#888')
                .attr('font-size', '12px')
                .text('é€Ÿåº¦ (km/h)');
            
            // æ·»åŠ å›¾ä¾‹
            const legend = svg.append('g')
                .attr('transform', `translate(${width - margin.right - 150}, ${margin.top + 20})`);
            
            legend.append('line')
                .attr('x1', 0)
                .attr('x2', 30)
                .attr('y1', 0)
                .attr('y2', 0)
                .attr('stroke', '#28a745')
                .attr('stroke-width', 3);
            
            legend.append('text')
                .attr('x', 35)
                .attr('y', 4)
                .attr('fill', '#888')
                .attr('font-size', '11px')
                .text('é€Ÿåº¦');
            
            legend.append('line')
                .attr('x1', 0)
                .attr('x2', 30)
                .attr('y1', 20)
                .attr('y2', 20)
                .attr('stroke', '#ffc107')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5')
                .attr('opacity', 0.6);
            
            legend.append('text')
                .attr('x', 35)
                .attr('y', 24)
                .attr('fill', '#888')
                .attr('font-size', '11px')
                .text('åŠ é€Ÿåº¦');
        }

        // ========== å¼¹çª—äº‹ä»¶å¤„ç† ==========
        document.getElementById('explore-btn').addEventListener('click', function() {
            document.getElementById('explore-modal').classList.remove('show');
            generateReport();
            document.getElementById('report-modal').style.display = 'flex';
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            document.getElementById('report-content').scrollTop = 0;
        });

        document.getElementById('not-interested-btn').addEventListener('click', function() {
            document.getElementById('explore-modal').classList.remove('show');
        });

        // å…³é—­æŠ¥å‘Šçª—å£
        document.addEventListener('click', function(e) {
            if (e.target.id === 'report-modal' || e.target.classList.contains('close-report') || e.target.closest('.close-report')) {
                document.getElementById('report-modal').style.display = 'none';
            }
            // å…³é—­ç‰©ç†å­¦å®¶åˆ†æçª—å£
            if (e.target.id === 'physics-analysis-modal' || e.target.classList.contains('close-physics-analysis') || e.target.closest('.close-physics-analysis')) {
                document.getElementById('physics-analysis-modal').style.display = 'none';
            }
            
        });

        // ========== ç‰©ç†å­¦å®¶åˆ†æåŠŸèƒ½ ==========
        async function callPhysicsAnalysis(useStream = false) {
            if (!simulationResult) return;
            
            const analysisContent = document.getElementById('physics-analysis-content');
            const modal = document.getElementById('physics-analysis-modal');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            analysisContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #28a745;">
                    <i class="fas fa-atom fa-spin" style="font-size: 48px; margin-bottom: 20px; animation: spin 2s linear infinite;"></i>
                    <p style="font-size: 18px; font-weight: 600;">ç‰©ç†å­¦å®¶æ­£åœ¨åˆ†æä¸­...</p>
                    <p style="font-size: 14px; color: #888; margin-top: 10px;">æ­£åœ¨è¿ç”¨ç‰©ç†å…¬å¼è¿›è¡Œè¯¦ç»†è®¡ç®—å’Œæ¨å¯¼</p>
                    <div style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 6px; border-left: 4px solid #28a745;">
                        <p style="font-size: 12px; color: #aaa; margin: 0;">
                            <i class="fas fa-cog fa-spin mr-2"></i>
                            æ­£åœ¨å»ºç«‹ç‰©ç†æ¨¡å‹ â†’ æ¨å¯¼å…¬å¼ â†’ è¿›è¡Œè®¡ç®— â†’ éªŒè¯ç»“æœ...
                        </p>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºåˆ†æçª—å£ï¼ˆå¸¦æ·¡å…¥åŠ¨ç”»ï¼‰
            if (modal) {
                modal.style.cssText = 'display: flex !important; opacity: 0;';
                setTimeout(() => {
                    modal.style.transition = 'opacity 0.3s ease';
                    modal.style.opacity = '1';
                }, 10);
            }
            
            try {
                // ç¡®ä¿ physics æ•°æ®å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
                const physicsData = simulationResult.physics || {};
                
                // éªŒè¯physicsæ•°æ®
                if (!physicsData || Object.keys(physicsData).length === 0) {
                    console.error('physicsæ•°æ®ä¸ºç©º:', physicsData);
                    analysisContent.innerHTML = `
                        <div style="padding: 20px; color: #dc3545;">
                            <p>é”™è¯¯ï¼šphysicsæ•°æ®ä¸ºç©ºï¼Œè¯·å…ˆè¿è¡Œæ¨¡æ‹Ÿè®¡ç®—</p>
                        </div>
                    `;
                    return;
                }
                
                // æ„å»ºè¯·æ±‚æ•°æ® - ç¡®ä¿æ‰€æœ‰å€¼éƒ½æ˜¯æ•°å­—ç±»å‹ï¼Œä¸æ˜¯undefined
                // æš‚æ—¶ç¦ç”¨æµå¼æ¨¡å¼ï¼Œä½¿ç”¨æ™®é€šJSONå“åº”
                const requestData = {
                    session_id: sessionId,
                    vehicle: currentVehicle || 'æœªçŸ¥',
                    bump: currentBump || 'æœªçŸ¥',
                    location: currentLocation || 'æœªçŸ¥',
                    weather: currentWeather || 'æ™´',
                    speed: Number(currentSpeed) || 0,
                    survival_rate: Number(simulationResult.survivalRate) || 0,
                    physics: {
                        maxAcceleration: Number(physicsData.maxAcceleration) || 0,
                        maxDisplacement: Number(physicsData.maxDisplacement) || 0,
                        velocityChange: Number(physicsData.velocityChange) || 0,
                        bounceHeight: Number(physicsData.bounceHeight) || 0,
                        t_pass: Number(physicsData.t_pass) || 0,
                        omega_n: Number(physicsData.omega_n) || 0,
                        zeta: Number(physicsData.zeta) || 0
                    },
                    stream: useStream  // æ˜¯å¦ä½¿ç”¨æµå¼è¾“å‡º
                };
                
                // éªŒè¯è¯·æ±‚æ•°æ®å®Œæ•´æ€§
                if (!requestData.physics || Object.values(requestData.physics).every(v => v === 0)) {
                    console.warn('è­¦å‘Šï¼šæ‰€æœ‰physicsæ•°æ®éƒ½æ˜¯0ï¼Œè¿™å¯èƒ½å¯¼è‡´åˆ†æä¸å‡†ç¡®');
                }
                
                console.log('å‘é€ç‰©ç†å­¦å®¶åˆ†æè¯·æ±‚:', requestData);
                console.log('APIåœ°å€:', `${API_BASE_URL}/api/physics/analyze`);
                console.log('simulationResult:', simulationResult);
                console.log('physicsæ•°æ®:', physicsData);
                
                if (useStream) {
                    // æµå¼è¾“å‡ºæ¨¡å¼
                    await streamPhysicsAnalysis(requestData, analysisContent);
                    return; // æµå¼æ¨¡å¼å¤„ç†å®Œæˆåç›´æ¥è¿”å›
                }
                
                // æ™®é€šæ¨¡å¼ï¼ˆç¡®ä¿æ•°æ®æ­£ç¡®å‘é€ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                // éªŒè¯è¯·æ±‚æ•°æ®
                if (!requestData || !requestData.physics) {
                    console.error('è¯·æ±‚æ•°æ®ä¸å®Œæ•´:', requestData);
                    throw new Error('è¯·æ±‚æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå°‘physicsæ•°æ®');
                }
                
                // æ‰“å°å®Œæ•´çš„è¯·æ±‚æ•°æ®ç”¨äºè°ƒè¯•
                console.log('å‡†å¤‡å‘é€è¯·æ±‚ï¼Œæ•°æ®å¤§å°:', JSON.stringify(requestData).length, 'å­—èŠ‚');
                console.log('è¯·æ±‚URL:', `${API_BASE_URL}/api/physics/analyze`);
                console.log('å®Œæ•´è¯·æ±‚æ•°æ®:', JSON.stringify(requestData, null, 2));
                
                const response = await fetch(`${API_BASE_URL}/api/physics/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    signal: controller.signal
                });
                    
                    clearTimeout(timeoutId);
                    
                    console.log('æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);
                    const contentType = response.headers.get('Content-Type');
                    console.log('å“åº”Content-Type:', contentType);
                    
                    if (response.ok) {
                        // æ™®é€šJSONå“åº”
                        const data = await response.json();
                        console.log('å“åº”æ•°æ®:', data);
                        if (data.success) {
                            displayPhysicsAnalysis(data.analysis);
                        } else {
                            console.error('åˆ†æå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯:', data.error);
                            analysisContent.innerHTML = `
                                <div style="padding: 20px; color: #dc3545;">
                                    <p>åˆ†æå¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                                    ${data.traceback ? `<pre style="font-size: 10px; color: #888; margin-top: 10px; overflow: auto;">${data.traceback}</pre>` : ''}
                                </div>
                            `;
                        }
                    } else {
                        let errorText = `HTTP ${response.status}`;
                        let errorDetails = '';
                        try {
                            const errorData = await response.json();
                            errorText = errorData.error || errorData.message || errorText;
                            errorDetails = errorData.traceback || '';
                            console.error('åç«¯é”™è¯¯å“åº”:', errorData);
                        } catch (e) {
                            const textResponse = await response.text();
                            errorText = textResponse || errorText;
                            console.error('æ— æ³•è§£æé”™è¯¯å“åº”:', e, 'åŸå§‹å“åº”:', textResponse);
                        }
                        throw new Error(errorText + (errorDetails ? '\n' + errorDetails : ''));
                    }
            } catch (error) {
                console.error('ç‰©ç†å­¦å®¶åˆ†æAPIè°ƒç”¨å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // åˆ¤æ–­é”™è¯¯ç±»å‹
                let errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                let errorType = 'è¿æ¥é”™è¯¯';
                
                if (error.name === 'AbortError') {
                    errorType = 'è¯·æ±‚è¶…æ—¶';
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼ŒæœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                    errorType = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                    errorMessage = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ';
                } else if (error.message.includes('CORS')) {
                    errorType = 'è·¨åŸŸé”™è¯¯';
                    errorMessage = 'è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨CORSé…ç½®';
                }
                
                analysisContent.innerHTML = `
                    <div style="padding: 20px; color: #dc3545;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px;"></i>
                            <h3 style="margin: 0; color: #dc3545;">åˆ†æå¤±è´¥ - ${errorType}</h3>
                        </div>
                        <p style="margin-bottom: 10px;">${errorMessage}</p>
                        <p style="font-size: 12px; color: #888; margin-bottom: 10px;">é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>
                        <div style="padding: 15px; background: #2a2a2a; border-radius: 6px; border-left: 3px solid #dc3545; margin-bottom: 15px;">
                            <p style="font-size: 12px; color: #aaa; margin: 0 0 10px 0;">
                                <strong style="color: #dc3545;">å»ºè®®ï¼š</strong>
                            </p>
                            <ol style="font-size: 11px; color: #aaa; margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 5px;">æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š<code style="background: #1a1a1a; padding: 2px 6px; border-radius: 3px;">http://localhost:5001</code></li>
                                <li style="margin-bottom: 5px;">å¦‚æœé€šè¿‡æ–‡ä»¶æ‰“å¼€é¡µé¢ï¼Œè¯·ä½¿ç”¨ï¼š<code style="background: #1a1a1a; padding: 2px 6px; border-radius: 3px;">http://localhost:5001</code> è®¿é—®</li>
                                <li style="margin-bottom: 5px;">æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                                <li style="margin-bottom: 5px;">æ£€æŸ¥æœåŠ¡å™¨ç»ˆç«¯æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—</li>
                                <li>ç¨åé‡è¯•æˆ–åˆ·æ–°é¡µé¢</li>
                            </ol>
                        </div>
                        <div style="padding: 10px; background: #1a1a1a; border-radius: 6px; border: 1px solid #2a2a2a;">
                            <p style="font-size: 11px; color: #888; margin: 0;">
                                <strong>å½“å‰APIåœ°å€ï¼š</strong> <code style="color: #28a745;">${API_BASE_URL}/api/physics/analyze</code>
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        // æµå¼åˆ†æå¤„ç†å‡½æ•°
        // å·²åˆå¹¶åˆ°ä¸‹é¢çš„å®Œæ•´ç‰ˆæœ¬ä¸­ï¼Œæ­¤å‡½æ•°å·²åˆ é™¤

        // æµå¼è®¡ç®—å¤„ç†å‡½æ•°
        async function streamPhysicsCalculation(requestData, display, details) {
            return new Promise((resolve, reject) => {
                const physicsResults = {};
                let isComplete = false;
                
                fetch(`${API_BASE_URL}/api/physics/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    function processStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                if (!isComplete) {
                                    reject(new Error('æµå¼è¾“å‡ºæœªå®Œæˆ'));
                                }
                                return;
                            }
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        
                                        if (data.type === 'start') {
                                            // å¼€å§‹è®¡ç®—
                                            display.innerHTML = `
                                                <div class="text-2xl mb-2">
                                                    <i class="fas fa-cog fa-spin mr-2"></i>
                                                    ç‰©ç†å­¦å®¶æ­£åœ¨è®¡ç®—ä¸­...
                                                </div>
                                                <div class="text-sm opacity-90">${data.message || 'è¯·ç¨å€™ï¼Œæ­£åœ¨è¿ç”¨ç‰©ç†å…¬å¼è¿›è¡Œç²¾ç¡®è®¡ç®—'}</div>
                                            `;
                                        } else if (data.type === 'progress') {
                                            // æ˜¾ç¤ºè¿›åº¦
                                            display.innerHTML = `
                                                <div class="text-2xl mb-2">
                                                    <i class="fas fa-cog fa-spin mr-2"></i>
                                                    ${data.step}...
                                                </div>
                                                <div class="text-sm opacity-90">è¿›åº¦: ${data.progress}%</div>
                                            `;
                                            
                                            details.innerHTML = `
                                                <div class="text-center mt-4 text-white text-sm opacity-80">
                                                    <i class="fas fa-atom fa-spin mr-2"></i>
                                                    ${data.step}
                                                </div>
                                            `;
                                        } else if (data.type === 'result') {
                                            // æ¥æ”¶å•ä¸ªç»“æœ
                                            physicsResults[data.key] = data.value;
                                            
                                            // å¦‚æœæ˜¯å…³é”®ç»“æœï¼Œç«‹å³æ˜¾ç¤º
                                            if (data.key === 'survivalRate') {
                                                const survivalRate = Math.round(data.value);
                                                let result = 'æœªçŸ¥';
                                                let className = 'survival-safe';
                                                
                                                if (survivalRate >= 80) {
                                                    result = 'å®‰å…¨é€šè¿‡';
                                                    className = 'survival-safe';
                                                } else if (survivalRate >= 60) {
                                                    result = 'å¯èƒ½é€šè¿‡';
                                                    className = 'survival-warning';
                                                } else if (survivalRate >= 40) {
                                                    result = 'å±é™©';
                                                    className = 'survival-warning';
                                                } else {
                                                    result = 'æå±é™©';
                                                    className = 'survival-danger';
                                                }
                                                
                                                display.className = `survival-display ${className}`;
                                                display.innerHTML = `
                                                    <div class="text-4xl mb-2">${survivalRate}%</div>
                                                    <div class="text-xl">${result}</div>
                                                `;
                                            } else if (data.key === 'maxAcceleration' || data.key === 'bounceHeight') {
                                                // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                                                if (physicsResults.maxAcceleration && physicsResults.bounceHeight) {
                                                    details.innerHTML = `
                                                        <div class="grid grid-cols-2 gap-4 mt-4">
                                                            <div>
                                                                <div class="text-white text-xs opacity-80">æœ€å¤§åŠ é€Ÿåº¦</div>
                                                                <div class="text-lg font-semibold">${physicsResults.maxAcceleration.toFixed(2)} m/sÂ²</div>
                                                            </div>
                                                            <div>
                                                                <div class="text-white text-xs opacity-80">å¼¹è·³é«˜åº¦</div>
                                                                <div class="text-lg font-semibold">${(physicsResults.bounceHeight * 100).toFixed(2)} cm</div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }
                                            }
                                        } else if (data.type === 'complete') {
                                            // è®¡ç®—å®Œæˆ
                                            isComplete = true;
                                            const physics = data.physics;
                                            
                                            // æ„å»ºå®Œæ•´çš„simulationResult
                                            const survivalRate = Math.round(physics.survivalRate);
                                            let result = 'æœªçŸ¥';
                                            let className = 'survival-safe';
                                            
                                            if (survivalRate >= 80) {
                                                result = 'å®‰å…¨é€šè¿‡';
                                                className = 'survival-safe';
                                            } else if (survivalRate >= 60) {
                                                result = 'å¯èƒ½é€šè¿‡';
                                                className = 'survival-warning';
                                            } else if (survivalRate >= 40) {
                                                result = 'å±é™©';
                                                className = 'survival-warning';
                                            } else {
                                                result = 'æå±é™©';
                                                className = 'survival-danger';
                                            }
                                            
                                            simulationResult = {
                                                survivalRate: survivalRate,
                                                result: result,
                                                color: className === 'survival-safe' ? '#28a745' : (className === 'survival-warning' ? '#ffc107' : '#dc3545'),
                                                className: className,
                                                physics: {
                                                    maxAcceleration: physics.maxAcceleration || 0,
                                                    maxDisplacement: physics.maxDisplacement || 0,
                                                    velocityChange: physics.velocityChange || 0,
                                                    bounceHeight: physics.bounceHeight || 0,
                                                    t_pass: physics.t_pass || 0,
                                                    omega_n: physics.omega_n || 0,
                                                    zeta: physics.zeta || 0
                                                }
                                            };
                                            
                                            // æ›´æ–°æ˜¾ç¤º
                                            display.className = `survival-display ${className}`;
                                            display.innerHTML = `
                                                <div class="text-4xl mb-2">${survivalRate}%</div>
                                                <div class="text-xl">${result}</div>
                                            `;
                                            
                                            details.innerHTML = `
                                                <div class="grid grid-cols-2 gap-4 mt-4">
                                                    <div>
                                                        <div class="text-white text-xs opacity-80">æœ€å¤§åŠ é€Ÿåº¦</div>
                                                        <div class="text-lg font-semibold">${physics.maxAcceleration.toFixed(2)} m/sÂ²</div>
                                                    </div>
                                                    <div>
                                                        <div class="text-white text-xs opacity-80">å¼¹è·³é«˜åº¦</div>
                                                        <div class="text-lg font-semibold">${(physics.bounceHeight * 100).toFixed(2)} cm</div>
                                                    </div>
                                                </div>
                                            `;
                                            
                                            // æ›´æ–°å›¾è¡¨
                                            updateCharts();
                                            
                                            // è‡ªåŠ¨è°ƒç”¨ç‰©ç†å­¦å®¶åˆ†æï¼ˆæµå¼ï¼‰
                                            setTimeout(async () => {
                                                isSimulating = false;
                                                document.getElementById('start-simulation').disabled = false;
                                                
                                                await callPhysicsAnalysis(true);
                                                
                                                setTimeout(() => {
                                                    document.getElementById('explore-modal').classList.add('show');
                                                }, 1000);
                                            }, 500);
                                            
                                            resolve();
                                        } else if (data.type === 'error') {
                                            reject(new Error(data.error));
                                        }
                                    } catch (e) {
                                        console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
                                    }
                                }
                            }
                            
                            processStream();
                        }).catch(reject);
                    }
                    
                    processStream();
                }).catch(reject);
            });
        }

        // æµå¼è¾“å‡ºå¤„ç†å‡½æ•°
        async function streamPhysicsAnalysis(requestData, analysisContent) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/physics/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullContent = '';
                
                // åˆå§‹åŒ–æ˜¾ç¤ºåŒºåŸŸ
                analysisContent.innerHTML = `
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #28a74520 0%, #20c99720 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #28a745;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <i class="fas fa-atom" style="font-size: 32px; color: #28a745;"></i>
                                <div>
                                    <h3 style="color: #28a745; margin: 0; font-size: 20px;">ç‰©ç†å­¦å®¶ä¸“ä¸šåˆ†æ</h3>
                                    <p style="color: #888; margin: 5px 0 0 0; font-size: 14px;">åŸºäºå¼¹ç°§-è´¨é‡-é˜»å°¼ç³»ç»Ÿæ¨¡å‹çš„è¯¦ç»†å…¬å¼æ¨å¯¼</p>
                                </div>
                            </div>
                        </div>
                        <div id="streaming-content" style="background: transparent; padding: 25px; border-radius: 8px; border: 1px solid #28a745; min-height: 200px;">
                            <div style="color: #28a745; font-size: 14px;">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                æ­£åœ¨æ¥æ”¶åˆ†æå†…å®¹...
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 6px; border-left: 4px solid #28a745;">
                            <p style="color: #888; font-size: 12px; margin: 0;">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>æç¤ºï¼š</strong>ä»¥ä¸Šåˆ†æåŸºäºç®€åŒ–çš„ç‰©ç†æ¨¡å‹ï¼Œå®é™…è½¦è¾†åŠ¨åŠ›å­¦å¯èƒ½æ›´å¤æ‚ã€‚æœ¬åˆ†ææ—¨åœ¨æ•™è‚²ç›®çš„ï¼Œå¸®åŠ©ç†è§£ç‰©ç†åŸç†ã€‚
                            </p>
                        </div>
                    </div>
                `;
                
                const streamingContent = document.getElementById('streaming-content');
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'start') {
                                    // å¼€å§‹æ¥æ”¶
                                    streamingContent.innerHTML = '<div style="color: #28a745; font-size: 14px;"><i class="fas fa-spinner fa-spin mr-2"></i>æ­£åœ¨æ¥æ”¶åˆ†æå†…å®¹...</div>';
                                } else if (data.type === 'chunk') {
                                    // æ¥æ”¶å†…å®¹å—
                                    fullContent += data.content;
                                    
                                    // æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºå†…å®¹
                                    let html = fullContent;
                                    
                                    // å…ˆè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼Œé¿å…å¹²æ‰°å…¬å¼å¤„ç†
                                    // html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                    
                                    // ä½¿ç”¨å…¨å±€å·¥å…·å‡½æ•° cleanFormula
                                    
                                    // å¤„ç†å—çº§å…¬å¼ \[...\] (LaTeXæ ‡å‡†æ ¼å¼)
                                    html = html.replace(/\\\[([^\]]+)\\\]/g, function(match, formula) {
                                        let clean = cleanFormula(formula);
                                        return `<div style="font-family: 'Courier New', monospace; background: transparent; padding: 12px; border-radius: 6px; border: 2px solid #28a745; color: #28a745; font-weight: 500; margin: 15px 0; text-align: center; font-size: 16px;">${clean}</div>`;
                                    });
                                    
                                    // å¤„ç†è¡Œå†…å…¬å¼ \(...\) (LaTeXæ ‡å‡†æ ¼å¼)
                                    html = html.replace(/\\\(([^\)]+)\\\)/g, function(match, formula) {
                                        let clean = cleanFormula(formula);
                                        return `<span style="font-family: 'Courier New', monospace; background: transparent; padding: 4px 8px; border-radius: 4px; border: 1px solid #28a745; color: #28a745; font-weight: 500; display: inline-block; margin: 2px;">${clean}</span>`;
                                    });
                                    
                                    // å¤„ç†è¡Œå†…å…¬å¼ $...$
                                    html = html.replace(/\$([^$]+)\$/g, function(match, formula) {
                                        let clean = cleanFormula(formula);
                                        return `<span style="font-family: 'Courier New', monospace; background: transparent; padding: 4px 8px; border-radius: 4px; border: 1px solid #28a745; color: #28a745; font-weight: 500; display: inline-block; margin: 2px;">${clean}</span>`;
                                    });
                                    
                                    // å¤„ç†å—çº§å…¬å¼ $$...$$
                                    html = html.replace(/\$\$([^$]+)\$\$/g, function(match, formula) {
                                        let clean = cleanFormula(formula);
                                        return `<div style="font-family: 'Courier New', monospace; background: transparent; padding: 12px; border-radius: 6px; border: 2px solid #28a745; color: #28a745; font-weight: 500; margin: 15px 0; text-align: center; font-size: 16px;">${clean}</div>`;
                                    });
                                    
                                    // å¤„ç†æ ‡é¢˜
                                    html = html.replace(/^###\s+(.+)$/gm, '<h3 style="color: #28a745; margin-top: 20px; margin-bottom: 10px; font-size: 18px; border-left: 4px solid #28a745; padding-left: 10px;">$1</h3>');
                                    html = html.replace(/^##\s+(.+)$/gm, '<h2 style="color: #28a745; margin-top: 25px; margin-bottom: 15px; font-size: 22px; border-bottom: 2px solid #28a745; padding-bottom: 8px;">$1</h2>');
                                    html = html.replace(/^#\s+(.+)$/gm, '<h1 style="color: #28a745; margin-top: 30px; margin-bottom: 20px; font-size: 26px;">$1</h1>');
                                    
                                    // å¤„ç†ç¼–å·åˆ—è¡¨
                                    html = html.replace(/^\d+\.\s+(.+)$/gm, '<div style="margin: 8px 0; padding-left: 20px; position: relative;"><span style="color: #28a745; font-weight: bold; position: absolute; left: 0;">â€¢</span> $1</div>');
                                    
                                    // å¤„ç†æ¢è¡Œ
                                    html = html.replace(/\n\n/g, '</p><p style="margin: 15px 0;">');
                                    html = '<p style="margin: 15px 0;">' + html + '</p>';
                                    
                                    // å¤„ç†ä»£ç å—
                                    html = html.replace(/```([^`]+)```/g, '<pre style="background: transparent; padding: 15px; border-radius: 6px; border: 1px solid #28a745; margin: 15px 0; overflow-x: auto; font-family: \'Courier New\', monospace; font-size: 14px; color: #28a745;">$1</pre>');
                                    
                                    // å¤„ç†è¡Œå†…ä»£ç 
                                    html = html.replace(/`([^`]+)`/g, '<code style="background: transparent; padding: 2px 6px; border-radius: 4px; border: 1px solid #28a745; font-family: \'Courier New\', monospace; color: #28a745;">$1</code>');
                                    
                                    streamingContent.innerHTML = html;
                                    
                                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                    streamingContent.scrollTop = streamingContent.scrollHeight;
                                } else if (data.type === 'done') {
                                    // å®Œæˆ
                                    streamingContent.style.border = '1px solid #28a745';
                                } else if (data.type === 'error') {
                                    throw new Error(data.error);
                                }
                            } catch (e) {
                                console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('æµå¼è¾“å‡ºå¤±è´¥:', error);
                analysisContent.innerHTML = `
                    <div style="padding: 20px; color: #dc3545;">
                        <p>æµå¼è¾“å‡ºå¤±è´¥ï¼š${error.message}</p>
                    </div>
                `;
            }
        }

        function displayPhysicsAnalysis(analysis) {
            const analysisContent = document.getElementById('physics-analysis-content');
            
            // å°†åˆ†ææ–‡æœ¬è½¬æ¢ä¸ºHTMLï¼Œä¿ç•™æ ¼å¼
            let html = analysis;
            
            // è¿‡æ»¤å ä½ç¬¦æ–‡æœ¬ï¼ˆåç«¯æŒ‡ä»¤ä¸åº”è¯¥æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰
            // ç§»é™¤"å¾…ç¡®å®š"ã€"å¾…å®š"ç­‰å ä½ç¬¦åŠå…¶ç›¸å…³è¯´æ˜
            html = html.replace(/å¾…ç¡®å®š/g, '');
            html = html.replace(/å¾…å®š/g, '');
            html = html.replace(/\[å¾…ç¡®å®š\]/g, '');
            html = html.replace(/\[å¾…å®š\]/g, '');
            html = html.replace(/\[å€¼\]/g, '');
            html = html.replace(/to be determined/gi, '');
            html = html.replace(/TBD/gi, '');
            html = html.replace(/å¾…è®¡ç®—/g, '');
            html = html.replace(/å¾…è¡¥å……/g, '');
            // ç§»é™¤åŒ…å«"ä¸èƒ½å†™'å¾…ç¡®å®š'"ç­‰åç«¯æŒ‡ä»¤çš„æ–‡æœ¬
            html = html.replace(/ä¸èƒ½å†™['"]å¾…ç¡®å®š['"]/g, '');
            html = html.replace(/ä¸èƒ½ä½¿ç”¨å ä½ç¬¦[^ã€‚ï¼Œ]*/g, '');
            html = html.replace(/å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^ã€‚ï¼Œ]*/g, '');
            // ç§»é™¤"å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼,ä¸èƒ½å†™\"å¾…ç¡®å®š\""ç­‰å®Œæ•´æŒ‡ä»¤ï¼ˆåŒ¹é…å„ç§æ ¼å¼ï¼‰
            html = html.replace(/å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^ï¼Œã€‚]*ä¸èƒ½å†™[^ï¼Œã€‚]*å¾…ç¡®å®š[^ï¼Œã€‚)]*/g, '');
            html = html.replace(/å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^ï¼Œã€‚]*ä¸èƒ½å†™[^ï¼Œã€‚]*["']å¾…ç¡®å®š["'][^ï¼Œã€‚)]*/g, '');
            html = html.replace(/å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^ï¼Œã€‚]*ä¸èƒ½å†™[^ï¼Œã€‚]*\\["']å¾…ç¡®å®š\\["'][^ï¼Œã€‚)]*/g, '');
            html = html.replace(/å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^ï¼Œã€‚]*ä¸èƒ½å†™[^ï¼Œã€‚]*å¾…ç¡®å®š/g, '');
            html = html.replace(/å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^ï¼Œã€‚]*ä¸èƒ½å†™[^ï¼Œã€‚]*["']å¾…ç¡®å®š["']/g, '');
            html = html.replace(/å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^ï¼Œã€‚]*ä¸èƒ½å†™[^ï¼Œã€‚]*\\["']å¾…ç¡®å®š\\["']/g, '');
            // ç§»é™¤æ ‡é¢˜ä¸­çš„å®Œæ•´æŒ‡ä»¤ï¼ˆå¦‚"1.3 å‰ç«¯æä¾›çš„ç‰©ç†å‚æ•°(å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼,ä¸èƒ½å†™\"å¾…ç¡®å®š\")"ï¼‰
            html = html.replace(/\(å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^)]*ä¸èƒ½å†™[^)]*å¾…ç¡®å®š[^)]*\)/g, '');
            html = html.replace(/\(å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^)]*ä¸èƒ½å†™[^)]*["']å¾…ç¡®å®š["'][^)]*\)/g, '');
            html = html.replace(/\(å¿…é¡»ä½¿ç”¨è¿™äº›å®é™…æ•°å€¼[^)]*ä¸èƒ½å†™[^)]*\\["']å¾…ç¡®å®š\\["'][^)]*\)/g, '');
            // æ¸…ç†å¤šä½™çš„ç©ºè¡Œï¼ˆç”±äºåˆ é™¤å ä½ç¬¦å¯èƒ½äº§ç”Ÿçš„ï¼‰
            html = html.replace(/\n{3,}/g, '\n\n');
            
            // ä½¿ç”¨å…¨å±€å·¥å…·å‡½æ•° cleanFormula
            
            // å¤„ç†å—çº§å…¬å¼ \[...\] (LaTeXæ ‡å‡†æ ¼å¼) - ä¼˜å…ˆå¤„ç†
            html = html.replace(/\\\[([\s\S]*?)\\\]/g, function(match, formula) {
                let clean = cleanFormula(formula);
                return `<div style="font-family: 'Courier New', monospace; background: #1a1a1a; padding: 15px; border-radius: 6px; border: 1px solid #444; color: #ffffff; font-weight: 400; margin: 20px 0; text-align: center; font-size: 15px; line-height: 1.6;">${clean}</div>`;
            });
            
            // å¤„ç†è¡Œå†…å…¬å¼ \(...\) (LaTeXæ ‡å‡†æ ¼å¼)
            html = html.replace(/\\\(([\s\S]*?)\\\)/g, function(match, formula) {
                let clean = cleanFormula(formula);
                return `<span style="font-family: 'Courier New', monospace; background: #1a1a1a; padding: 3px 6px; border-radius: 3px; border: 1px solid #444; color: #ffffff; font-weight: 400; display: inline-block; margin: 0 2px;">${clean}</span>`;
            });
            
            // å¤„ç†è¡Œå†…å…¬å¼ $...$ (ç®€å•æ ¼å¼ï¼Œåœ¨ $$...$$ ä¹‹å‰å¤„ç†ï¼Œé¿å…å†²çª)
            html = html.replace(/(?<!\$)\$([^$\n]+)\$(?!\$)/g, function(match, formula) {
                let clean = cleanFormula(formula);
                return `<span style="font-family: 'Courier New', monospace; background: #1a1a1a; padding: 3px 6px; border-radius: 3px; border: 1px solid #444; color: #ffffff; font-weight: 400; display: inline-block; margin: 0 2px;">${clean}</span>`;
            });
            
            // å¤„ç†å—çº§å…¬å¼ $$...$$
            html = html.replace(/\$\$([^$]+)\$\$/g, function(match, formula) {
                let cleaned = cleanFormula(formula);
                return `<div style="font-family: 'Courier New', monospace; background: #1a1a1a; padding: 15px; border-radius: 6px; border: 1px solid #444; color: #ffffff; font-weight: 400; margin: 20px 0; text-align: center; font-size: 15px; line-height: 1.6;">${cleaned}</div>`;
            });
            
            // å¤„ç†æ ‡é¢˜ï¼ˆ## æˆ– ### å¼€å¤´ï¼‰- ä½¿ç”¨ç™½è‰²ï¼Œä½†ä¿æŒç»“æ„æ¸…æ™°
            html = html.replace(/^###\s+(.+)$/gm, '<h3 style="color: #ffffff !important; margin-top: 30px; margin-bottom: 12px; font-size: 18px; font-weight: 600; border-left: 3px solid #666; padding-left: 12px; padding-bottom: 8px; border-bottom: 1px solid #333;">$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2 style="color: #ffffff !important; margin-top: 35px; margin-bottom: 15px; font-size: 20px; font-weight: 600; padding-bottom: 10px; border-bottom: 2px solid #444;">$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1 style="color: #ffffff !important; margin-top: 40px; margin-bottom: 20px; font-size: 24px; font-weight: 600; padding-bottom: 12px; border-bottom: 3px solid #555;">$1</h1>');
            
            // å¤„ç†ç¼–å·åˆ—è¡¨ - ä½¿ç”¨ç™½è‰²
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<div style="margin: 10px 0; padding-left: 24px; position: relative; color: #ffffff !important;"><span style="color: #888; font-weight: bold; position: absolute; left: 0;">â€¢</span> <span style="color: #ffffff !important;">$1</span></div>');
            
            // å¤„ç†Markdownè¡¨æ ¼ - ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½æ˜¯ç™½è‰²
            html = html.replace(/\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|/g, function(match, col1, col2, col3, col4) {
                return `<div style="display: grid; grid-template-columns: 1fr 1fr 2fr 2fr; gap: 10px; padding: 10px; margin: 10px 0; border-bottom: 1px solid #333; color: #ffffff;">
                    <div style="color: #ffffff;">${col1.trim()}</div>
                    <div style="color: #ffffff;">${col2.trim()}</div>
                    <div style="color: #ffffff;">${col3.trim()}</div>
                    <div style="color: #ffffff;">${col4.trim()}</div>
                </div>`;
            });
            // ç§»é™¤è¡¨æ ¼åˆ†éš”çº¿
            html = html.replace(/\|[\s-]+\|/g, '');
            
            // æ›´å¥½çš„æ®µè½åˆ†éš” - æŒ‰åŒæ¢è¡Œåˆ†æ®µï¼Œæ¯ä¸ªæ®µè½ç‹¬ç«‹æ˜¾ç¤º
            // å…ˆå¤„ç†å•æ¢è¡Œï¼Œè½¬æ¢ä¸ºç©ºæ ¼
            html = html.replace(/(?<!\n)\n(?!\n)/g, ' ');
            // ç„¶åå¤„ç†åŒæ¢è¡ŒåŠä»¥ä¸Šï¼Œè½¬æ¢ä¸ºæ®µè½åˆ†éš”
            html = html.replace(/\n\n+/g, '</p></div><div style="margin: 25px 0; padding: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;"><p style="color: #ffffff !important; line-height: 1.8; margin: 0;">');
            html = '<div style="margin: 0; padding: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;"><p style="color: #ffffff !important; line-height: 1.8; margin: 0;">' + html + '</p></div>';
            
            // å¤„ç†ä»£ç å—ï¼ˆ```...```ï¼‰- ä½¿ç”¨ç™½è‰²
            html = html.replace(/```([^`]+)```/g, '<pre style="background: #1a1a1a; padding: 15px; border-radius: 6px; border-left: 3px solid #666; margin: 20px 0; overflow-x: auto; font-family: \'Courier New\', monospace; font-size: 14px; color: #ffffff; line-height: 1.6;">$1</pre>');
            
            // å¤„ç†è¡Œå†…ä»£ç ï¼ˆ`...`ï¼‰- ä½¿ç”¨ç™½è‰²
            html = html.replace(/`([^`]+)`/g, '<code style="background: #1a1a1a; padding: 3px 6px; border-radius: 3px; font-family: \'Courier New\', monospace; color: #ffffff; border: 1px solid #444;">$1</code>');
            
            // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰ç»¿è‰²æ ·å¼ï¼ˆé˜²æ­¢AIè¾“å‡ºä¸­åŒ…å«ç»¿è‰²ï¼‰- åœ¨æœ€åæ‰§è¡Œï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰æ ·å¼
            html = html.replace(/color:\s*#28a745/gi, 'color: #ffffff !important');
            html = html.replace(/color:\s*#20c997/gi, 'color: #ffffff !important');
            html = html.replace(/color:\s*rgb\(40,\s*167,\s*69\)/gi, 'color: #ffffff !important');
            html = html.replace(/color:\s*green/gi, 'color: #ffffff !important');
            // å¼ºåˆ¶æ‰€æœ‰å…¬å¼æ¡†å’Œå…¬å¼å†…å®¹ä¸ºç™½è‰²ï¼ˆç¡®ä¿å…¬å¼æ²¡æœ‰ç»¿è‰²ï¼‰
            html = html.replace(/(<div[^>]*style="[^"]*)(color:\s*#28a745[^"]*)/gi, '$1color: #ffffff !important;');
            html = html.replace(/(<span[^>]*style="[^"]*)(color:\s*#28a745[^"]*)/gi, '$1color: #ffffff !important;');
            html = html.replace(/(<div[^>]*style="[^"]*)(color:\s*#20c997[^"]*)/gi, '$1color: #ffffff !important;');
            html = html.replace(/(<span[^>]*style="[^"]*)(color:\s*#20c997[^"]*)/gi, '$1color: #ffffff !important;');
            // ç¡®ä¿æ‰€æœ‰å…¬å¼ç›¸å…³çš„divå’Œspanéƒ½æ˜¯ç™½è‰²ï¼ˆé€šè¿‡font-familyè¯†åˆ«ï¼‰
            html = html.replace(/(<div[^>]*style="[^"]*font-family:[^"]*Courier[^"]*)([^"]*">)/gi, '$1; color: #ffffff !important;$2');
            html = html.replace(/(<span[^>]*style="[^"]*font-family:[^"]*Courier[^"]*)([^"]*">)/gi, '$1; color: #ffffff !important;$2');
            // æœ€åï¼Œå¼ºåˆ¶æ‰€æœ‰åŒ…å«æ•°å­¦ç¬¦å·çš„å…ƒç´ éƒ½æ˜¯ç™½è‰²
            html = html.replace(/(<div[^>]*>)([^<]*[Ï‰Î¶Î±Î²Î³Î¸Ï€Î”Î»Î¼ÏƒÏ†][^<]*)(<\/div>)/gi, '$1<span style="color: #ffffff !important;">$2</span>$3');
            html = html.replace(/(<span[^>]*>)([^<]*[Ï‰Î¶Î±Î²Î³Î¸Ï€Î”Î»Î¼ÏƒÏ†][^<]*)(<\/span>)/gi, '$1<span style="color: #ffffff !important;">$2</span>$3');
            html = html.replace(/<div[^>]*>([^<]*å…¬å¼[^<]*)<\/div>/gi, '<div style="color: #ffffff !important;">$1</div>');
            html = html.replace(/<span[^>]*>([^<]*å…¬å¼[^<]*)<\/span>/gi, '<span style="color: #ffffff !important;">$1</span>');
            // ç¡®ä¿æ‰€æœ‰åŒ…å«æ•°å­¦ç¬¦å·çš„å…ƒç´ éƒ½æ˜¯ç™½è‰²
            html = html.replace(/(<div[^>]*style="[^"]*)(color:[^;"]+)([^"]*">)/gi, '$1color: #ffffff !important;$3');
            html = html.replace(/(<span[^>]*style="[^"]*)(color:[^;"]+)([^"]*">)/gi, '$1color: #ffffff !important;$3');
            
            // æ·»åŠ æ ·å¼å®¹å™¨
            analysisContent.innerHTML = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="background: #1a1a1a; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #444;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-atom" style="font-size: 32px; color: #ffffff;"></i>
                            <div>
                                <h3 style="color: #ffffff; margin: 0; font-size: 20px; font-weight: 600;">ç‰©ç†å­¦å®¶ä¸“ä¸šåˆ†æ</h3>
                                <p style="color: #888; margin: 5px 0 0 0; font-size: 14px;">åŸºäºå¼¹ç°§-è´¨é‡-é˜»å°¼ç³»ç»Ÿæ¨¡å‹çš„è¯¦ç»†å…¬å¼æ¨å¯¼</p>
                            </div>
                        </div>
                    </div>
                    <div style="background: #1a1a1a; padding: 30px; border-radius: 8px; border: 1px solid #2a2a2a; color: #ffffff; line-height: 1.8; font-size: 15px;">
                        ${html}
                    </div>
                    <div style="margin-top: 25px; padding: 15px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #666; border: 1px solid #444;">
                        <p style="color: #888; font-size: 13px; margin: 0; line-height: 1.6;">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong style="color: #aaa;">æç¤ºï¼š</strong>ä»¥ä¸Šåˆ†æåŸºäºç®€åŒ–çš„ç‰©ç†æ¨¡å‹ï¼Œå®é™…è½¦è¾†åŠ¨åŠ›å­¦å¯èƒ½æ›´å¤æ‚ã€‚æœ¬åˆ†ææ—¨åœ¨æ•™è‚²ç›®çš„ï¼Œå¸®åŠ©ç†è§£ç‰©ç†åŸç†ã€‚
                        </p>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ»šåŠ¨åŠ¨ç”»
            analysisContent.scrollTop = 0;
        }

        // æ·»åŠ æŒ‰é’®æ¥æ‰‹åŠ¨è§¦å‘ç‰©ç†å­¦å®¶åˆ†æï¼ˆå¯é€‰ï¼‰
        function addPhysicsAnalysisButton() {
            const survivalDetails = document.getElementById('survival-details');
            if (survivalDetails && simulationResult) {
                const existingBtn = document.getElementById('show-physics-analysis-btn');
                if (!existingBtn) {
                    const btn = document.createElement('button');
                    btn.id = 'show-physics-analysis-btn';
                    btn.className = 'btn-primary';
                    btn.style.cssText = 'width: 100%; margin-top: 10px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);';
                    btn.innerHTML = '<i class="fas fa-atom mr-2"></i>æŸ¥çœ‹ç‰©ç†å­¦å®¶è¯¦ç»†åˆ†æ';
                    btn.addEventListener('click', callPhysicsAnalysis);
                    survivalDetails.appendChild(btn);
                }
            }
        }

        function generateEthicsAnalysis() {
            let analysis = '';
            
            // ç¤¾ä¼šæ­£ä¹‰åˆ†æ
            if (currentVehicle === 'è±ªåè½¿è½¦') {
                analysis += '<p><strong>ç¤¾ä¼šæ­£ä¹‰ï¼š</strong>æ‚¨é€‰æ‹©äº†è±ªåè½¿è½¦ï¼Œè¿™å¯èƒ½åæ˜ äº†å¯¹é«˜å“è´¨ç”Ÿæ´»çš„è¿½æ±‚ã€‚ç„¶è€Œï¼Œè±ªåè½¦è¾†çš„æ¶ˆè´¹å¯èƒ½åŠ å‰§ç¤¾ä¼šä¸å¹³ç­‰ï¼Œå› ä¸ºåªæœ‰å°‘æ•°äººèƒ½å¤Ÿè´Ÿæ‹…å¾—èµ·ã€‚è¯·æ€è€ƒï¼šæ‚¨çš„é€‰æ‹©æ˜¯å¦è€ƒè™‘äº†ç¤¾ä¼šå…¬å¹³æ€§ï¼Ÿ</p>';
            } else if (currentVehicle === 'å…¨å°ºå¯¸SUV') {
                analysis += '<p><strong>ç¤¾ä¼šæ­£ä¹‰ï¼š</strong>SUVé€šå¸¸æ¶ˆè€—æ›´å¤šèµ„æºï¼Œæ’æ”¾æ›´å¤šæ¸©å®¤æ°”ä½“ã€‚æ‚¨çš„é€‰æ‹©å¯èƒ½ä½“ç°äº†å¯¹ä¸ªäººèˆ’é€‚çš„é‡è§†ï¼Œä½†è¯·è€ƒè™‘è¿™å¯¹ç¯å¢ƒå’Œç¤¾ä¼šçš„å½±å“ã€‚</p>';
            } else {
                analysis += '<p><strong>ç¤¾ä¼šæ­£ä¹‰ï¼š</strong>æ‚¨çš„è½¦è¾†é€‰æ‹©ç›¸å¯¹å¹³è¡¡äº†ä¸ªäººéœ€æ±‚ä¸ç¤¾ä¼šè´£ä»»ã€‚</p>';
            }
            
            // ä¸ªäººè´£ä»»åˆ†æ
            if (currentSpeed >= 50) {
                analysis += '<p><strong>ä¸ªäººè´£ä»»ï¼š</strong>æ‚¨é€‰æ‹©äº†è¾ƒé«˜çš„é€Ÿåº¦ï¼Œè¿™å¯èƒ½åæ˜ äº†å¯¹æ•ˆç‡çš„è¿½æ±‚ã€‚ä½†è¯·æ€è€ƒï¼šåœ¨è¿½æ±‚ä¸ªäººç›®æ ‡æ—¶ï¼Œæ˜¯å¦å……åˆ†è€ƒè™‘äº†å¯¹ä»–äººçš„è´£ä»»ï¼Ÿé«˜é€Ÿé©¾é©¶ä¸ä»…å±åŠè‡ªèº«ï¼Œä¹Ÿå¯èƒ½å¨èƒä»–äººå®‰å…¨ã€‚</p>';
            } else {
                analysis += '<p><strong>ä¸ªäººè´£ä»»ï¼š</strong>æ‚¨é€‰æ‹©äº†ç›¸å¯¹å®‰å…¨çš„é€Ÿåº¦ï¼Œä½“ç°äº†å¯¹å®‰å…¨è´£ä»»çš„é‡è§†ã€‚</p>';
            }
            
            return analysis;
        }

        function generateSafetyAnalysis() {
            let analysis = '';
            
            if (simulationResult.survivalRate < 60) {
                analysis += '<p><strong>å®‰å…¨æ„è¯†ï¼š</strong>âš ï¸ æ‚¨çš„é€‰æ‹©ç»„åˆå­˜åœ¨è¾ƒé«˜çš„å®‰å…¨é£é™©ã€‚å»ºè®®é™ä½é€Ÿåº¦ï¼Œé€‰æ‹©æ›´å®‰å…¨çš„è½¦è¾†å’Œå‡é€Ÿå¸¦ç»„åˆã€‚</p>';
            } else if (simulationResult.survivalRate < 80) {
                analysis += '<p><strong>å®‰å…¨æ„è¯†ï¼š</strong>âš ï¸ æ‚¨çš„é€‰æ‹©å­˜åœ¨ä¸€å®šé£é™©ã€‚è™½ç„¶å¯èƒ½é€šè¿‡ï¼Œä½†å»ºè®®æ›´åŠ è°¨æ…ã€‚</p>';
            } else {
                analysis += '<p><strong>å®‰å…¨æ„è¯†ï¼š</strong>âœ“ æ‚¨çš„é€‰æ‹©ç›¸å¯¹å®‰å…¨ï¼Œä½“ç°äº†è‰¯å¥½çš„å®‰å…¨æ„è¯†ã€‚</p>';
            }
            
            if (currentSpeed >= 50) {
                analysis += '<p><strong>é€Ÿåº¦é£é™©ï¼š</strong>é«˜é€Ÿé€šè¿‡å‡é€Ÿå¸¦æ˜¯æå…¶å±é™©çš„ï¼Œå¯èƒ½å¯¼è‡´è½¦è¾†å¤±æ§ã€ç¢°æ’ç”šè‡³ç¿»è½¦ã€‚è¯·åŠ¡å¿…åœ¨ç°å®ä¸­éµå®ˆäº¤é€šè§„åˆ™ã€‚</p>';
            }
            
            if (currentBump === 'é‡‘å±å‡é€Ÿå¸¦' && currentSpeed > 40) {
                analysis += '<p><strong>å‡é€Ÿå¸¦é£é™©ï¼š</strong>é«˜é€Ÿé€šè¿‡é‡‘å±å‡é€Ÿå¸¦å¯èƒ½å¯¼è‡´ä¸¥é‡çš„è½¦è¾†æŸåï¼Œç‰¹åˆ«æ˜¯å¯¹æ‚¬æŒ‚ç³»ç»Ÿã€‚</p>';
            }
            
            return analysis;
        }

        function generateSummaryAnalysis() {
            const riskLevel = simulationResult.survivalRate < 60 ? 'é«˜' : simulationResult.survivalRate < 80 ? 'ä¸­' : 'ä½';
            
            return `
                <p>åŸºäºæ‚¨çš„é€‰æ‹©ï¼ˆ${currentVehicle}ã€${currentBump}ã€${currentLocation}ã€${currentSpeed} km/hï¼‰ï¼Œç»¼åˆåˆ†ææ˜¾ç¤ºï¼š</p>
                <ul class="list-disc list-inside mt-2 space-y-1 ml-4">
                    <li>å®‰å…¨é£é™©ç­‰çº§ï¼š<strong>${riskLevel}</strong></li>
                    <li>å¹¸å­˜ç‡ï¼š<strong>${simulationResult.survivalRate}%</strong></li>
                    <li>å»ºè®®ï¼š${simulationResult.survivalRate < 60 ? 'å¼ºçƒˆå»ºè®®è°ƒæ•´å‚æ•°ä»¥æé«˜å®‰å…¨æ€§' : 'å½“å‰å‚æ•°ç»„åˆç›¸å¯¹åˆç†'}</li>
                </ul>
            `;
        }

        // ========== ç”Ÿæˆå®Œæ•´å¯è§†åŒ–æŠ¥å‘Š ==========
        async function generateReport() {
            if (!simulationResult) return;
            
            const reportContent = document.getElementById('report-content');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            reportContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #667eea;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p style="font-size: 18px;">æ­£åœ¨ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š...</p>
                    <p style="font-size: 14px; color: #888; margin-top: 10px;">è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨è°ƒç”¨å„ä¸“ä¸šè§’è‰²è¿›è¡Œåˆ†æ</p>
                </div>
            `;
            
            // å…ˆä½¿ç”¨æœ¬åœ°è®¡ç®—ä½œä¸ºé»˜è®¤å€¼
            let personalityData = calculatePersonalityTraits();
            let justiceData = calculateJusticeIndex();
            let backendAnalysis = null;
            
            // å°è¯•è°ƒç”¨åç«¯APIè·å–ä¸“ä¸šåˆ†æ
            try {
                const response = await fetch(`${API_BASE_URL}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        vehicle: currentVehicle,
                        bump: currentBump,
                        location: currentLocation,
                        speed: currentSpeed,
                        survival_rate: simulationResult.survivalRate
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        backendAnalysis = data.results;
                        
                        // ä½¿ç”¨åç«¯åˆ†æç»“æœæ›´æ–°æ•°æ®
                        if (backendAnalysis.ethicist && !backendAnalysis.ethicist.error) {
                            // æ›´æ–°æ­£ä¹‰åº¦æ•°æ®
                            justiceData = {
                                socialJustice: Math.round(backendAnalysis.ethicist.social_justice || justiceData.socialJustice),
                                personalResponsibility: Math.round(backendAnalysis.ethicist.personal_responsibility || justiceData.personalResponsibility),
                                environmentalJustice: justiceData.environmentalJustice,
                                overall: Math.round((backendAnalysis.ethicist.social_justice + backendAnalysis.ethicist.personal_responsibility + justiceData.environmentalJustice) / 3)
                            };
                        }
                    }
                }
            } catch (error) {
                console.warn('åç«¯APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®¡ç®—:', error);
                // ç»§ç»­ä½¿ç”¨æœ¬åœ°è®¡ç®—
            }
            
            // æ„å»ºä¸“ä¸šåˆ†æHTML
            let professionalAnalysisHTML = '';
            if (backendAnalysis) {
                professionalAnalysisHTML = `
                    ${backendAnalysis.ethicist && !backendAnalysis.ethicist.error ? `
                        <div style="margin-bottom: 10px; padding: 10px; background: transparent; border: 1px solid #00D9FF; border-radius: 6px;">
                            <h3 style="font-size: 13px; color: #667eea; margin-bottom: 6px;">
                                <i class="fas fa-balance-scale mr-2"></i>${backendAnalysis.ethicist.role}åˆ†æ
                            </h3>
                            <p style="font-size: 11px; color: #e5e5e5; line-height: 1.5; max-height: 200px; overflow-y: auto;">${backendAnalysis.ethicist.analysis}</p>
                        </div>
                    ` : ''}
                    ${backendAnalysis.safety && !backendAnalysis.safety.error ? `
                        <div style="margin-bottom: 10px; padding: 10px; background: transparent; border: 1px solid #00D9FF; border-radius: 6px;">
                            <h3 style="font-size: 13px; color: #ffc107; margin-bottom: 6px;">
                                <i class="fas fa-shield-alt mr-2"></i>${backendAnalysis.safety.role}åˆ†æ
                            </h3>
                            <p style="font-size: 11px; color: #e5e5e5; line-height: 1.5; max-height: 150px; overflow-y: auto;">${backendAnalysis.safety.analysis}</p>
                            ${backendAnalysis.safety.recommendations && backendAnalysis.safety.recommendations.length > 0 ? `
                                <div style="margin-top: 8px;">
                                    <strong style="color: #ffc107; font-size: 10px;">å»ºè®®ï¼š</strong>
                                    <ul style="margin-top: 4px; padding-left: 18px; font-size: 10px; color: #aaa;">
                                        ${backendAnalysis.safety.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    ${backendAnalysis.physicist && !backendAnalysis.physicist.error ? `
                        <div style="margin-bottom: 10px; padding: 10px; background: transparent; border: 1px solid #00D9FF; border-radius: 6px;">
                            <h3 style="font-size: 13px; color: #28a745; margin-bottom: 6px;">
                                <i class="fas fa-atom mr-2"></i>${backendAnalysis.physicist.role}åˆ†æ
                            </h3>
                            <p style="font-size: 11px; color: #e5e5e5; line-height: 1.5; max-height: 200px; overflow-y: auto;">${backendAnalysis.physicist.analysis}</p>
                        </div>
                    ` : ''}
                `;
            }
            
            reportContent.innerHTML = `
                <!-- æ ‡é¢˜æ¨ªç€æ”¾æœ€ä¸Šé¢ -->
                <div class="report-cover" style="margin-bottom: 15px; text-align: center; padding: 20px; background: transparent; border: 2px solid #00D9FF; border-radius: 12px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                    <div style="font-size: 48px; margin-bottom: 10px;">${getPersonalityEmoji()}</div>
                    <h1 style="font-size: 32px; margin-bottom: 10px; font-weight: 700; color: #00D9FF;">æ­ç§˜ä½ çš„å†…åœ¨ç‰¹è´¨</h1>
                    <p style="font-size: 16px; opacity: 0.9; color: #ffffff;">ä¸ªæ€§åŒ–æ€§æ ¼ä¸æ­£ä¹‰æ„Ÿåˆ†ææŠ¥å‘Š</p>
                    <div style="margin-top: 15px; font-size: 13px; opacity: 0.8; color: #ffffff;">
                        <p>${currentVehicle} | ${currentBump} | ${currentLocation} | ${currentSpeed} km/h</p>
                    </div>
                    ${backendAnalysis ? '<div style="margin-top: 10px; font-size: 12px; opacity: 0.7; color: #00D9FF;"><i class="fas fa-check-circle mr-2"></i>å·²æ¥å…¥ä¸“ä¸šè§’è‰²åˆ†æ</div>' : ''}
                </div>

                <!-- æ€§æ ¼åˆ†æå’Œæ­£ä¹‰åº¦åˆ†ææ”¾åœ¨æ ‡é¢˜ä¸‹é¢ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <!-- æ€§æ ¼åˆ†æ -->
                    <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                        <h2 style="font-size: 18px; margin-bottom: 12px; color: #00D9FF;">
                            <i class="fas fa-user-circle mr-2"></i>æ€§æ ¼åˆ†æ
                        </h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                            <div id="personality-radar-chart" class="report-chart"></div>
                            <div id="personality-pie-chart" class="report-chart"></div>
                        </div>
                        <div style="margin-top: 12px;">
                            ${generatePersonalityDescription(personalityData)}
                        </div>
                    </div>

                    <!-- æ­£ä¹‰åº¦åˆ†æ -->
                    <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                        <h2 style="font-size: 18px; margin-bottom: 12px; color: #00D9FF;">
                            <i class="fas fa-balance-scale mr-2"></i>æ­£ä¹‰åº¦åˆ†æ
                        </h2>
                        <div style="margin-top: 12px;">
                            ${generateJusticeDescription(justiceData)}
                        </div>
                    </div>
                </div>
                
                <!-- å®Œæ•´ä¼¦ç†åˆ†ææ¨¡å— -->
                <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px; margin-top: 15px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                    <h2 style="font-size: 18px; margin-bottom: 12px; color: #00D9FF;">
                        <i class="fas fa-book-open mr-2"></i>å®Œæ•´ä¼¦ç†åˆ†æ
                    </h2>
                    <button id="show-full-ethics-btn" style="width: 100%; padding: 12px; background: transparent; border: 2px solid #00D9FF; color: #00D9FF; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; margin-bottom: 15px;">
                        <i class="fas fa-chevron-down mr-2"></i>æŸ¥çœ‹å®Œæ•´ä¼¦ç†åˆ†æ
                    </button>
                    <div id="full-ethics-analysis" style="display: none; padding: 15px; background: rgba(0, 217, 255, 0.05); border: 1px solid #00D9FF; border-radius: 8px; max-height: 500px; overflow-y: auto;">
                        ${backendAnalysis && backendAnalysis.ethicist && !backendAnalysis.ethicist.error ? `
                            <div style="line-height: 1.8; font-size: 13px; color: #e5e5e5; white-space: pre-wrap;">${backendAnalysis.ethicist.analysis}</div>
                        ` : `
                            <p style="color: #888; font-size: 12px; text-align: center;">æš‚æ— å®Œæ•´ä¼¦ç†åˆ†ææ•°æ®</p>
                        `}
                    </div>
                </div>

                <!-- æ‰€æœ‰æ¨¡å—æ¨ªå‘æ’åˆ— -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 15px;">
                    <!-- æŠ¥å‘Šç®€ä»‹ -->
                    <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px;">
                        <h2 style="font-size: 16px; margin-bottom: 10px; color: #00D9FF;">
                            <i class="fas fa-info-circle mr-2"></i>æŠ¥å‘Šç®€ä»‹
                        </h2>
                        <p style="line-height: 1.5; color: #e5e5e5; font-size: 12px; margin-bottom: 8px;">
                            æœ¬æŠ¥å‘ŠåŸºäºæ‚¨åœ¨ã€Šé£è·ƒå‡é€Ÿå¸¦ã€‹å®éªŒä¸­çš„é€‰æ‹©è¡Œä¸ºï¼Œé€šè¿‡ä¼¦ç†å­¦å®¶ã€å®‰å…¨å‘˜ã€ç‰©ç†å­¦å®¶ç­‰ä¸“ä¸šè§’è‰²çš„AIåˆ†æï¼Œ
                            ç»“åˆD3.jsæ•°æ®å¯è§†åŒ–æŠ€æœ¯ï¼Œä¸ºæ‚¨æ­ç¤ºéšè—åœ¨å†³ç­–èƒŒåçš„æ€§æ ¼ç‰¹è´¨å’Œæ­£ä¹‰æ„ŸæŒ‡æ•°ã€‚
                        </p>
                        <div style="padding: 8px; background: transparent; border: 1px solid #00D9FF; border-radius: 6px;">
                            <p style="color: #888; font-size: 11px;">
                                <i class="fas fa-shield-alt mr-2"></i>
                                <strong>æ•°æ®å®‰å…¨ï¼š</strong>æ‰€æœ‰åˆ†ææ•°æ®ä»…ç”¨äºç”ŸæˆæŠ¥å‘Šï¼Œä¸ä¼šç”¨äºå…¶ä»–ç›®çš„ã€‚
                            </p>
                        </div>
                    </div>
                    
                    <!-- ä¸“ä¸šè§’è‰²åˆ†æ -->
                    <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px; overflow-y: auto; max-height: 400px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                        <h2 style="font-size: 16px; margin-bottom: 10px; color: #00D9FF;">
                            <i class="fas fa-users mr-2"></i>ä¸“ä¸šè§’è‰²åˆ†æ
                        </h2>
                        ${professionalAnalysisHTML || '<p style="color: #888; font-size: 12px;">æš‚æ— æ•°æ®</p>'}
                    </div>

                    <!-- ä¸ªäººæ•…äº‹ -->
                    <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px; overflow-y: auto; max-height: 400px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                        <h2 style="font-size: 16px; margin-bottom: 10px; color: #00D9FF;">
                            <i class="fas fa-book-open mr-2"></i>ä¸ªäººæ•…äº‹
                        </h2>
                        ${generatePersonalStory(personalityData, justiceData)}
                    </div>

                    <!-- å»ºè®®ä¸è¡ŒåŠ¨ -->
                    <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px; overflow-y: auto; max-height: 400px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                        <h2 style="font-size: 16px; margin-bottom: 10px; color: #00D9FF;">
                            <i class="fas fa-lightbulb mr-2"></i>å»ºè®®ä¸è¡ŒåŠ¨
                        </h2>
                        ${generateRecommendations(personalityData, justiceData)}
                    </div>

                    <!-- ç»“è®º -->
                    <div class="report-section" style="background: transparent; border: 2px solid #00D9FF; border-radius: 12px; padding: 15px; overflow-y: auto; max-height: 400px; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);">
                        <h2 style="font-size: 16px; margin-bottom: 10px; color: #00D9FF;">
                            <i class="fas fa-check-circle mr-2"></i>ç»“è®º
                        </h2>
                        ${generateConclusion(personalityData, justiceData)}
                    </div>
                </div>


            `;
            
            // ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨
            setTimeout(() => {
                createPersonalityRadarChart(personalityData);
                createPersonalityPieChart(personalityData);
                // åˆ é™¤ç©ºç™½æ¨¡å— personality-force-chart
                // createPersonalityForceChart(personalityData);
                // ç§»é™¤æ­£ä¹‰åº¦å›¾è¡¨ï¼Œé¿å…ç©ºç™½æ¨¡å—
                // createJusticeChart(justiceData);
                // createJusticeTreeChart(justiceData);
                
                // æ·»åŠ æ»šåŠ¨åŠ¨ç”»
                addScrollAnimations();
                
                // æ·»åŠ å®Œæ•´ä¼¦ç†åˆ†ææŒ‰é’®äº‹ä»¶
                const showFullEthicsBtn = document.getElementById('show-full-ethics-btn');
                const fullEthicsAnalysis = document.getElementById('full-ethics-analysis');
                if (showFullEthicsBtn && fullEthicsAnalysis) {
                    showFullEthicsBtn.addEventListener('click', function() {
                        const isVisible = fullEthicsAnalysis.style.display !== 'none';
                        fullEthicsAnalysis.style.display = isVisible ? 'none' : 'block';
                        showFullEthicsBtn.innerHTML = isVisible 
                            ? '<i class="fas fa-chevron-down mr-2"></i>æŸ¥çœ‹å®Œæ•´ä¼¦ç†åˆ†æ'
                            : '<i class="fas fa-chevron-up mr-2"></i>éšè—å®Œæ•´ä¼¦ç†åˆ†æ';
                    });
                }
            }, 100);
        }

        // è®¡ç®—æ€§æ ¼ç‰¹è´¨
        function calculatePersonalityTraits() {
            let riskTaking = 0;
            let socialAwareness = 0;
            let environmentalConcern = 0;
            let safetyConsciousness = 0;
            let efficiencyFocus = 0;
            
            // åŸºäºè½¦è¾†é€‰æ‹©
            if (currentVehicle === 'é«˜æ€§èƒ½è·‘è½¦') {
                riskTaking += 30;
                efficiencyFocus += 25;
            } else if (currentVehicle === 'å…¨å°ºå¯¸SUV') {
                socialAwareness -= 15;
                environmentalConcern -= 20;
            } else if (currentVehicle === 'è±ªåè½¿è½¦') {
                socialAwareness -= 25;
                environmentalConcern -= 15;
            } else {
                environmentalConcern += 20;
                safetyConsciousness += 15;
            }
            
            // åŸºäºé€Ÿåº¦é€‰æ‹©
            if (currentSpeed >= 50) {
                riskTaking += 40;
                safetyConsciousness -= 30;
            } else if (currentSpeed >= 30) {
                riskTaking += 15;
                safetyConsciousness -= 10;
            } else {
                safetyConsciousness += 25;
            }
            
            // åŸºäºå‡é€Ÿå¸¦é€‰æ‹©
            if (currentBump === 'é‡‘å±å‡é€Ÿå¸¦') {
                safetyConsciousness -= 10;
            } else if (currentBump === 'æ³¡æ²«å‡é€Ÿå¸¦') {
                environmentalConcern += 10;
            }
            
            // åŸºäºåœ°ç‚¹é€‰æ‹©
            if (currentLocation === 'å­¦æ ¡é—¨å£') {
                socialAwareness += 30;
            } else if (currentLocation === 'æ£®æ—') {
                environmentalConcern += 25;
            }
            
            // åŸºäºå¹¸å­˜ç‡
            if (simulationResult.survivalRate < 60) {
                riskTaking += 20;
                safetyConsciousness -= 20;
            } else if (simulationResult.survivalRate >= 80) {
                safetyConsciousness += 20;
            }
            
            // å½’ä¸€åŒ–åˆ°0-100
            return {
                riskTaking: Math.max(0, Math.min(100, 50 + riskTaking)),
                socialAwareness: Math.max(0, Math.min(100, 50 + socialAwareness)),
                environmentalConcern: Math.max(0, Math.min(100, 50 + environmentalConcern)),
                safetyConsciousness: Math.max(0, Math.min(100, 50 + safetyConsciousness)),
                efficiencyFocus: Math.max(0, Math.min(100, 50 + efficiencyFocus))
            };
        }

        // è®¡ç®—æ­£ä¹‰æ„ŸæŒ‡æ•°
        function calculateJusticeIndex() {
            let socialJustice = 0;
            let personalResponsibility = 0;
            let environmentalJustice = 0;
            
            // åŸºäºè½¦è¾†é€‰æ‹©
            if (currentVehicle === 'è±ªåè½¿è½¦') {
                socialJustice -= 20;
            } else if (currentVehicle === 'å…¨å°ºå¯¸SUV') {
                environmentalJustice -= 15;
            } else {
                socialJustice += 10;
                environmentalJustice += 10;
            }
            
            // åŸºäºé€Ÿåº¦é€‰æ‹©
            if (currentSpeed >= 50) {
                personalResponsibility -= 25;
            } else {
                personalResponsibility += 20;
            }
            
            // åŸºäºåœ°ç‚¹é€‰æ‹©
            if (currentLocation === 'å­¦æ ¡é—¨å£') {
                socialJustice += 25;
            } else if (currentLocation === 'æ£®æ—') {
                environmentalJustice += 20;
            }
            
            return {
                socialJustice: Math.max(0, Math.min(100, 50 + socialJustice)),
                personalResponsibility: Math.max(0, Math.min(100, 50 + personalResponsibility)),
                environmentalJustice: Math.max(0, Math.min(100, 50 + environmentalJustice)),
                overall: Math.round((50 + socialJustice + personalResponsibility + environmentalJustice) / 3)
            };
        }

        // è·å–æ€§æ ¼è¡¨æƒ…ç¬¦å·
        function getPersonalityEmoji() {
            const traits = calculatePersonalityTraits();
            if (traits.riskTaking > 70) return 'ğŸ¯';
            if (traits.safetyConsciousness > 70) return 'ğŸ›¡ï¸';
            if (traits.environmentalConcern > 70) return 'ğŸŒ±';
            if (traits.socialAwareness > 70) return 'ğŸ¤';
            return 'ğŸŒŸ';
        }

        // ç”Ÿæˆæ€§æ ¼æè¿°
        function generatePersonalityDescription(traits) {
            let html = '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">';
            
            const descriptions = [
                {
                    name: 'å†’é™©å€¾å‘',
                    value: traits.riskTaking,
                    icon: 'ğŸ¯',
                    desc: traits.riskTaking > 60 ? 'æ‚¨å€¾å‘äºæ¥å—æŒ‘æˆ˜å’Œé£é™©ï¼Œè¿½æ±‚åˆºæ¿€ä½“éªŒ' : 'æ‚¨æ›´å€¾å‘äºä¿å®ˆå’Œç¨³å¦¥çš„é€‰æ‹©'
                },
                {
                    name: 'ç¤¾ä¼šæ„è¯†',
                    value: traits.socialAwareness,
                    icon: 'ğŸ¤',
                    desc: traits.socialAwareness > 60 ? 'æ‚¨éå¸¸å…³æ³¨ä»–äººå’Œç¤¾ä¼šçš„ç¦ç¥‰' : 'æ‚¨æ›´å…³æ³¨ä¸ªäººéœ€æ±‚å’Œç›®æ ‡'
                },
                {
                    name: 'ç¯ä¿æ„è¯†',
                    value: traits.environmentalConcern,
                    icon: 'ğŸŒ±',
                    desc: traits.environmentalConcern > 60 ? 'æ‚¨é«˜åº¦é‡è§†ç¯å¢ƒä¿æŠ¤å’Œå¯æŒç»­å‘å±•' : 'æ‚¨å¯¹ç¯å¢ƒé—®é¢˜çš„å…³æ³¨åº¦è¾ƒä½'
                },
                {
                    name: 'å®‰å…¨æ„è¯†',
                    value: traits.safetyConsciousness,
                    icon: 'ğŸ›¡ï¸',
                    desc: traits.safetyConsciousness > 60 ? 'æ‚¨éå¸¸é‡è§†å®‰å…¨å’Œé£é™©æ§åˆ¶' : 'æ‚¨å¯¹é£é™©çš„å®¹å¿åº¦è¾ƒé«˜'
                },
                {
                    name: 'æ•ˆç‡å¯¼å‘',
                    value: traits.efficiencyFocus,
                    icon: 'âš¡',
                    desc: traits.efficiencyFocus > 60 ? 'æ‚¨è¿½æ±‚æ•ˆç‡å’Œé€Ÿåº¦ï¼Œæ³¨é‡æ—¶é—´ç®¡ç†' : 'æ‚¨æ›´æ³¨é‡è¿‡ç¨‹çš„ä½“éªŒå’Œç»†èŠ‚'
                }
            ];
            
            descriptions.forEach(trait => {
                html += `
                    <div style="background: transparent; padding: 10px; border: 1px solid #00D9FF; border-radius: 6px;">
                        <div style="font-size: 18px; margin-bottom: 6px; text-align: center;">${trait.icon}</div>
                        <h3 style="font-size: 12px; margin-bottom: 6px; color: #e5e5e5; text-align: center;">${trait.name}</h3>
                        <div style="font-size: 20px; font-weight: bold; color: #667eea; margin-bottom: 6px; text-align: center;">${trait.value}%</div>
                        <p style="font-size: 10px; color: #888; line-height: 1.4; text-align: center;">${trait.desc}</p>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ç”Ÿæˆæ­£ä¹‰åº¦æè¿°
        function generateJusticeDescription(justice) {
            const ethicsText = generateEthicsAnalysis();
            const socialJusticeText = ethicsText.includes('ç¤¾ä¼šæ­£ä¹‰ï¼š') ? ethicsText.split('ç¤¾ä¼šæ­£ä¹‰ï¼š')[1].split('</p>')[0] : 'æ‚¨çš„ç¤¾ä¼šæ­£ä¹‰æ„è¯†';
            const personalRespText = ethicsText.includes('ä¸ªäººè´£ä»»ï¼š') ? ethicsText.split('ä¸ªäººè´£ä»»ï¼š')[1].split('</p>')[0] : 'æ‚¨çš„ä¸ªäººè´£ä»»æ„Ÿ';
            
            return `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px;">
                    <div style="background: transparent; padding: 12px; border-radius: 6px; text-align: center; border: 2px solid #00D9FF;">
                        <div style="font-size: 28px; margin-bottom: 8px;">âš–ï¸</div>
                        <h3 style="font-size: 13px; margin-bottom: 8px; color: #e5e5e5;">ç¤¾ä¼šæ­£ä¹‰</h3>
                        <div style="font-size: 22px; font-weight: bold; color: #667eea; margin-bottom: 6px;">${justice.socialJustice}%</div>
                        <p style="font-size: 11px; color: #888; line-height: 1.3;">${socialJusticeText.substring(0, 30)}...</p>
                    </div>
                    <div style="background: transparent; padding: 12px; border-radius: 6px; text-align: center; border: 2px solid #00D9FF;">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸ¯</div>
                        <h3 style="font-size: 13px; margin-bottom: 8px; color: #e5e5e5;">ä¸ªäººè´£ä»»</h3>
                        <div style="font-size: 22px; font-weight: bold; color: #667eea; margin-bottom: 6px;">${justice.personalResponsibility}%</div>
                        <p style="font-size: 11px; color: #888; line-height: 1.3;">${personalRespText.substring(0, 30)}...</p>
                    </div>
                    <div style="background: transparent; padding: 12px; border-radius: 6px; text-align: center; border: 2px solid #00D9FF;">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸŒ</div>
                        <h3 style="font-size: 13px; margin-bottom: 8px; color: #e5e5e5;">ç¯å¢ƒæ­£ä¹‰</h3>
                        <div style="font-size: 22px; font-weight: bold; color: #667eea; margin-bottom: 6px;">${justice.environmentalJustice}%</div>
                        <p style="font-size: 11px; color: #888; line-height: 1.3;">æ‚¨å¯¹ç¯å¢ƒæ­£ä¹‰çš„å…³æ³¨ç¨‹åº¦</p>
                    </div>
                </div>
                <div style="text-align: center; padding: 15px; background: transparent; border: 2px solid #00D9FF; border-radius: 8px;">
                    <h3 style="font-size: 16px; margin-bottom: 8px; color: #e5e5e5;">ç»¼åˆæ­£ä¹‰æ„ŸæŒ‡æ•°</h3>
                    <div style="font-size: 36px; font-weight: bold; color: #00D9FF;">${justice.overall}%</div>
                </div>
            `;
        }

        // ç”Ÿæˆä¸ªäººæ•…äº‹
        function generatePersonalStory(personality, justice) {
            const stories = [];
            
            if (personality.riskTaking > 70) {
                stories.push('æ‚¨æ˜¯ä¸€ä½æ•¢äºå†’é™©çš„æ¢ç´¢è€…ã€‚åœ¨ã€Šé£è·ƒå‡é€Ÿå¸¦ã€‹å®éªŒä¸­ï¼Œæ‚¨é€‰æ‹©äº†è¾ƒé«˜çš„é€Ÿåº¦ï¼Œè¿™åæ˜ äº†æ‚¨å¯¹æŒ‘æˆ˜çš„æ¸´æœ›å’Œå¯¹æé™çš„æ¢ç´¢ç²¾ç¥ã€‚');
            }
            
            if (personality.socialAwareness > 70) {
                stories.push('æ‚¨å…·æœ‰å¼ºçƒˆçš„ç¤¾ä¼šè´£ä»»æ„Ÿã€‚é€‰æ‹©å­¦æ ¡é—¨å£ä½œä¸ºå®éªŒåœ°ç‚¹ï¼Œä½“ç°äº†æ‚¨å¯¹ä»–äººå®‰å…¨çš„å…³æ³¨ï¼Œç‰¹åˆ«æ˜¯å¯¹å¼±åŠ¿ç¾¤ä½“çš„ä¿æŠ¤æ„è¯†ã€‚');
            }
            
            if (justice.overall > 70) {
                stories.push('æ‚¨çš„æ­£ä¹‰æ„ŸæŒ‡æ•°è¾ƒé«˜ï¼Œè¿™è¡¨æ˜æ‚¨åœ¨åšå‡ºå†³ç­–æ—¶ï¼Œä¼šç»¼åˆè€ƒè™‘ä¸ªäººåˆ©ç›Šä¸ç¤¾ä¼šè´£ä»»ï¼ŒåŠªåŠ›åœ¨ä¸¤è€…ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚');
            } else if (justice.overall < 50) {
                stories.push('æ‚¨çš„é€‰æ‹©æ›´å¤šåœ°ä½“ç°äº†ä¸ªäººåå¥½ï¼Œå»ºè®®åœ¨æœªæ¥çš„å†³ç­–ä¸­æ›´å¤šåœ°è€ƒè™‘ç¤¾ä¼šå½±å“å’Œä¼¦ç†è´£ä»»ã€‚');
            }
            
            if (personality.safetyConsciousness > 70) {
                stories.push('æ‚¨æ˜¯ä¸€ä½è°¨æ…çš„å†³ç­–è€…ã€‚å³ä½¿åœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸­ï¼Œæ‚¨ä¹Ÿé€‰æ‹©äº†ç›¸å¯¹å®‰å…¨çš„å‚æ•°ï¼Œè¿™ä½“ç°äº†æ‚¨å¯¹é£é™©çš„æ•æ„Ÿå’Œå¯¹å®‰å…¨çš„é‡è§†ã€‚');
            }
            
            return `
                <div style="line-height: 1.6; font-size: 13px; color: #e5e5e5;">
                    ${stories.length > 0 ? stories.join(' ') : 'åŸºäºæ‚¨çš„é€‰æ‹©ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ªç‹¬ç‰¹çš„å†³ç­–æ¨¡å¼ã€‚æ‚¨çš„æ¯ä¸€æ¬¡é€‰æ‹©éƒ½åæ˜ äº†å†…åœ¨çš„ä»·å€¼è§‚å’Œæ€§æ ¼ç‰¹è´¨ã€‚'}
                </div>
            `;
        }

        // ç”Ÿæˆå»ºè®®
        function generateRecommendations(personality, justice) {
            const recommendations = [];
            
            if (personality.riskTaking > 70) {
                recommendations.push({
                    icon: 'ğŸ¯',
                    title: 'å¹³è¡¡å†’é™©ä¸å®‰å…¨',
                    desc: 'å»ºè®®åœ¨è¿½æ±‚åˆºæ¿€çš„åŒæ—¶ï¼Œä¹Ÿè¦è€ƒè™‘å®‰å…¨å› ç´ ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠä»–äººå®‰å…¨çš„åœºæ™¯ä¸­ã€‚',
                    action: 'é˜…è¯»ã€Šé£é™©å†³ç­–å¿ƒç†å­¦ã€‹ç›¸å…³ä¹¦ç±'
                });
            }
            
            if (justice.socialJustice < 50) {
                recommendations.push({
                    icon: 'ğŸ¤',
                    title: 'å¢å¼ºç¤¾ä¼šæ„è¯†',
                    desc: 'å»ºè®®å¤šå…³æ³¨ç¤¾ä¼šå…¬å¹³é—®é¢˜ï¼Œæ€è€ƒä¸ªäººé€‰æ‹©å¦‚ä½•å½±å“ä»–äººå’Œæ•´ä¸ªç¤¾ä¼šã€‚',
                    action: 'å‚ä¸ç¤¾åŒºå¿—æ„¿æœåŠ¡æˆ–å…¬ç›Šæ´»åŠ¨'
                });
            }
            
            if (personality.environmentalConcern < 50) {
                recommendations.push({
                    icon: 'ğŸŒ±',
                    title: 'æå‡ç¯ä¿æ„è¯†',
                    desc: 'å»ºè®®äº†è§£æ›´å¤šå…³äºç¯å¢ƒä¿æŠ¤å’Œå¯æŒç»­å‘å±•çš„çŸ¥è¯†ï¼Œæ€è€ƒå¦‚ä½•åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­åšå‡ºæ›´ç¯ä¿çš„é€‰æ‹©ã€‚',
                    action: 'å…³æ³¨ç¯ä¿ç»„ç»‡ï¼Œå­¦ä¹ å¯æŒç»­ç”Ÿæ´»æ–¹å¼'
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    icon: 'ğŸŒŸ',
                    title: 'æŒç»­è‡ªæˆ‘æå‡',
                    desc: 'æ‚¨çš„é€‰æ‹©ä½“ç°äº†è‰¯å¥½çš„å¹³è¡¡æ„Ÿï¼Œå»ºè®®ç»§ç»­ä¿æŒè¿™ç§æ€è€ƒæ–¹å¼ï¼Œå¹¶åœ¨å®è·µä¸­ä¸æ–­ä¼˜åŒ–ã€‚',
                    action: 'å®šæœŸåæ€è‡ªå·±çš„å†³ç­–ï¼Œä¿æŒå¼€æ”¾çš„å­¦ä¹ æ€åº¦'
                });
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            recommendations.forEach(rec => {
                html += `
                    <div style="background: transparent; padding: 12px; border: 1px solid #00D9FF; border-radius: 6px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <div style="font-size: 24px;">${rec.icon}</div>
                            <div style="flex: 1;">
                                <h3 style="font-size: 14px; margin-bottom: 6px; color: #e5e5e5;">${rec.title}</h3>
                                <p style="color: #888; margin-bottom: 8px; line-height: 1.4; font-size: 12px;">${rec.desc}</p>
                                <div style="padding: 6px; background: transparent; border: 1px solid #00D9FF; border-radius: 4px; font-size: 11px;">
                                    <strong style="color: #667eea;">è¡ŒåŠ¨ï¼š</strong>
                                    <span style="color: #aaa;">${rec.action}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // ç”Ÿæˆç»“è®º
        function generateConclusion(personality, justice) {
            return `
                <div style="line-height: 1.6; font-size: 13px; color: #e5e5e5;">
                    <p style="margin-bottom: 10px;">
                        é€šè¿‡æœ¬æ¬¡ã€Šé£è·ƒå‡é€Ÿå¸¦ã€‹å®éªŒï¼Œæˆ‘ä»¬æ·±å…¥åˆ†æäº†æ‚¨çš„é€‰æ‹©è¡Œä¸ºï¼Œæ­ç¤ºäº†éšè—åœ¨å†³ç­–èƒŒåçš„æ€§æ ¼ç‰¹è´¨å’Œæ­£ä¹‰æ„ŸæŒ‡æ•°ã€‚
                    </p>
                    <p style="margin-bottom: 10px;">
                        æ‚¨çš„ç»¼åˆæ­£ä¹‰æ„ŸæŒ‡æ•°ä¸º <strong style="color: #667eea; font-size: 16px;">${justice.overall}%</strong>ï¼Œ
                        è¿™åæ˜ äº†æ‚¨åœ¨ä¸ªäººé€‰æ‹©ä¸ç¤¾ä¼šè´£ä»»ä¹‹é—´çš„å¹³è¡¡èƒ½åŠ›ã€‚
                    </p>
                    <p style="margin-bottom: 10px; font-size: 12px;">
                        <strong>é‡è¦æç¤ºï¼š</strong>æœ¬æŠ¥å‘Šä»…åŸºäºæ‚¨çš„å®éªŒé€‰æ‹©è¿›è¡Œåˆ†æï¼Œæ—¨åœ¨å¸®åŠ©æ‚¨æ›´å¥½åœ°äº†è§£è‡ªå·±çš„å†³ç­–æ¨¡å¼ã€‚
                        æŠ¥å‘Šçš„ç›®çš„ä¸æ˜¯è¯„åˆ¤ï¼Œè€Œæ˜¯å¯å‘æ€è€ƒã€‚
                    </p>
                    <p style="color: #667eea; font-size: 14px; font-weight: 600; margin-top: 15px;">
                        æ„¿è¿™ä»½æŠ¥å‘Šèƒ½æˆä¸ºæ‚¨è‡ªæˆ‘äº†è§£å’Œæˆé•¿çš„èµ·ç‚¹ã€‚ğŸŒŸ
                    </p>
                </div>
            `;
        }

        // åˆ›å»ºæ€§æ ¼é›·è¾¾å›¾
        function createPersonalityRadarChart(traits) {
            const container = d3.select('#personality-radar-chart');
            container.selectAll('*').remove();
            
            const containerWidth = container.node().offsetWidth || 300;
            const size = Math.min(containerWidth - 24, 280);
            const width = size;
            const height = size;
            const margin = 40;
            const radius = Math.min(width, height) / 2 - margin;
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width/2}, ${height/2})`);
            
            const categories = [
                { name: 'å†’é™©å€¾å‘', value: traits.riskTaking },
                { name: 'ç¤¾ä¼šæ„è¯†', value: traits.socialAwareness },
                { name: 'ç¯ä¿æ„è¯†', value: traits.environmentalConcern },
                { name: 'å®‰å…¨æ„è¯†', value: traits.safetyConsciousness },
                { name: 'æ•ˆç‡å¯¼å‘', value: traits.efficiencyFocus }
            ];
            
            const angleSlice = Math.PI * 2 / categories.length;
            
            // åˆ›å»ºæ¯”ä¾‹å°º
            const rScale = d3.scaleLinear()
                .domain([0, 100])
                .range([0, radius]);
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            const levels = 5;
            for (let level = 1; level <= levels; level++) {
                svg.append('circle')
                    .attr('r', radius * level / levels)
                    .attr('fill', 'none')
                    .attr('stroke', '#333')
                    .attr('stroke-width', 1);
            }
            
            // ç»˜åˆ¶è½´çº¿
            categories.forEach((d, i) => {
                const angle = i * angleSlice - Math.PI / 2;
                svg.append('line')
                    .attr('x1', 0)
                    .attr('y1', 0)
                    .attr('x2', Math.cos(angle) * radius)
                    .attr('y2', Math.sin(angle) * radius)
                    .attr('stroke', '#333')
                    .attr('stroke-width', 1);
                
                // æ ‡ç­¾
                svg.append('text')
                    .attr('x', Math.cos(angle) * (radius + 15))
                    .attr('y', Math.sin(angle) * (radius + 15))
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#888')
                    .attr('font-size', '11px')
                    .text(d.name);
            });
            
            // ç»˜åˆ¶æ•°æ®åŒºåŸŸ
            const line = d3.lineRadial()
                .angle((d, i) => i * angleSlice - Math.PI / 2)
                .radius(d => rScale(d.value))
                .curve(d3.curveLinearClosed);
            
            svg.append('path')
                .datum(categories.map(d => d.value))
                .attr('d', line)
                .attr('fill', '#667eea')
                .attr('fill-opacity', 0.3)
                .attr('stroke', '#667eea')
                .attr('stroke-width', 2);
            
            // ç»˜åˆ¶æ•°æ®ç‚¹
            categories.forEach((d, i) => {
                const angle = i * angleSlice - Math.PI / 2;
                svg.append('circle')
                    .attr('cx', Math.cos(angle) * rScale(d.value))
                    .attr('cy', Math.sin(angle) * rScale(d.value))
                    .attr('r', 5)
                    .attr('fill', '#667eea');
                
                svg.append('text')
                    .attr('x', Math.cos(angle) * rScale(d.value))
                    .attr('y', Math.sin(angle) * rScale(d.value) - 12)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#fff')
                    .attr('font-size', '10px')
                    .attr('font-weight', 'bold')
                    .text(d.value + '%');
            });
        }

        // åˆ›å»ºæ­£ä¹‰åº¦å›¾è¡¨
        function createJusticeChart(justice) {
            const container = d3.select('#justice-chart');
            container.selectAll('*').remove();
            
            const containerWidth = container.node().offsetWidth || 600;
            const width = Math.min(containerWidth - 24, containerWidth - 24);
            const height = Math.min(width * 0.4, 180);
            const margin = { top: 20, right: 30, bottom: 40, left: 50 };
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const data = [
                { name: 'ç¤¾ä¼šæ­£ä¹‰', value: justice.socialJustice },
                { name: 'ä¸ªäººè´£ä»»', value: justice.personalResponsibility },
                { name: 'ç¯å¢ƒæ­£ä¹‰', value: justice.environmentalJustice }
            ];
            
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.name))
                .range([margin.left, width - margin.right])
                .padding(0.3);
            
            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - margin.bottom, margin.top]);
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            svg.selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', d => xScale(d.name))
                .attr('y', height - margin.bottom)
                .attr('width', xScale.bandwidth())
                .attr('height', 0)
                .attr('fill', '#667eea')
                .attr('rx', 4)
                .transition()
                .duration(1000)
                .delay((d, i) => i * 200)
                .attr('y', d => yScale(d.value))
                .attr('height', d => height - margin.bottom - yScale(d.value))
                .attr('fill', (d, i) => ['#667eea', '#764ba2', '#28a745'][i])
                .on('end', function() {
                    d3.select(this)
                        .on('mouseover', function(event, d) {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .attr('opacity', 0.8)
                                .attr('y', d => yScale(d.value) - 5)
                                .attr('height', d => height - margin.bottom - yScale(d.value) + 5);
                            
                            tooltip
                                .html(`${d.name}<br>${d.value}%`)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY + 10) + 'px')
                                .classed('show', true);
                        })
                        .on('mouseout', function(event, d) {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .attr('opacity', 1)
                                .attr('y', d => yScale(d.value))
                                .attr('height', d => height - margin.bottom - yScale(d.value));
                            tooltip.classed('show', false);
                        });
                });
            
            // æ·»åŠ æ•°å€¼æ ‡ç­¾
            svg.selectAll('text.value')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'value')
                .attr('x', d => xScale(d.name) + xScale.bandwidth() / 2)
                .attr('y', d => yScale(d.value) - 10)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '16px')
                .attr('font-weight', 'bold')
                .text(d => d.value + '%');
            
            // æ·»åŠ åæ ‡è½´
            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale).ticks(5);
            
            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .call(xAxis)
                .attr('color', '#888');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .call(yAxis)
                .attr('color', '#888');
        }

        // åˆ›å»ºæ€§æ ¼é¥¼å›¾
        function createPersonalityPieChart(traits) {
            const container = d3.select('#personality-pie-chart');
            container.selectAll('*').remove();
            
            const containerWidth = container.node().offsetWidth || 300;
            const size = Math.min(containerWidth - 24, 280);
            const width = size;
            const height = size;
            const radius = Math.min(width, height) / 2 - 20;
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width/2}, ${height/2})`);
            
            const data = [
                { name: 'å†’é™©å€¾å‘', value: traits.riskTaking, color: '#667eea' },
                { name: 'ç¤¾ä¼šæ„è¯†', value: traits.socialAwareness, color: '#764ba2' },
                { name: 'ç¯ä¿æ„è¯†', value: traits.environmentalConcern, color: '#28a745' },
                { name: 'å®‰å…¨æ„è¯†', value: traits.safetyConsciousness, color: '#ffc107' },
                { name: 'æ•ˆç‡å¯¼å‘', value: traits.efficiencyFocus, color: '#dc3545' }
            ];
            
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);
            
            const arc = d3.arc()
                .innerRadius(radius * 0.4)
                .outerRadius(radius * 0.85);
            
            const arcs = svg.selectAll('arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');
            
            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => d.data.color)
                .attr('stroke', '#1a1a1a')
                .attr('stroke-width', 2)
                .attr('opacity', 0)
                .transition()
                .duration(1000)
                .attr('opacity', 0.8)
                .on('end', function() {
                    d3.select(this).attr('opacity', 0.8);
                })
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('opacity', 1)
                        .attr('stroke-width', 3);
                    
                    tooltip
                        .html(`${d.data.name}<br>${d.data.value}%`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY + 10) + 'px')
                        .classed('show', true);
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('opacity', 0.8)
                        .attr('stroke-width', 2);
                    tooltip.classed('show', false);
                });
            
            // æ·»åŠ æ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºæ•°å€¼ï¼‰
            arcs.filter(d => (d.endAngle - d.startAngle) > 0.1)
                .append('text')
                .attr('transform', d => `translate(${arc.centroid(d)})`)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '10px')
                .attr('font-weight', 'bold')
                .text(d => d.data.value + '%');
            
            // æ·»åŠ å›¾ä¾‹ï¼ˆç´§å‡‘ç‰ˆï¼‰
            const legend = svg.selectAll('.legend')
                .data(data)
                .enter()
                .append('g')
                .attr('class', 'legend')
                .attr('transform', (d, i) => `translate(${radius + 20}, ${-radius + i * 18})`);
            
            legend.append('rect')
                .attr('width', 10)
                .attr('height', 10)
                .attr('fill', d => d.color);
            
            legend.append('text')
                .attr('x', 14)
                .attr('y', 8)
                .attr('fill', '#888')
                .attr('font-size', '9px')
                .text(d => `${d.name.substring(0, 2)}:${d.value}%`);
            
            // åœ¨é¥¼å›¾ä¸‹æ–¹æ·»åŠ é¢œè‰²è¯´æ˜ï¼ˆä½¿ç”¨åŸç”ŸDOMæ“ä½œï¼‰
            const containerNode = container.node();
            if (containerNode) {
                const legendContainer = document.createElement('div');
                legendContainer.style.cssText = 'margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;';
                
                data.forEach(d => {
                    const legendItem = document.createElement('div');
                    legendItem.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 11px; color: #e5e5e5;';
                    
                    const colorBox = document.createElement('div');
                    colorBox.style.cssText = `width: 12px; height: 12px; background-color: ${d.color}; border-radius: 2px; border: 1px solid #00D9FF;`;
                    
                    const label = document.createElement('span');
                    label.textContent = `${d.name}: ${d.value}%`;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(label);
                    legendContainer.appendChild(legendItem);
                });
                
                containerNode.appendChild(legendContainer);
            }
        }

        // åˆ›å»ºæ€§æ ¼åŠ›å¯¼å‘å›¾
        function createPersonalityForceChart(traits) {
            const container = d3.select('#personality-force-chart');
            container.selectAll('*').remove();
            
            const containerWidth = container.node().offsetWidth || 600;
            const width = Math.min(containerWidth - 24, containerWidth - 24);
            const height = Math.min(width * 0.5, 200);
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const nodes = [
                { id: 'æ ¸å¿ƒ', group: 0, size: 30, x: width / 2, y: height / 2 },
                { id: 'å†’é™©å€¾å‘', group: 1, size: Math.max(15, traits.riskTaking / 3), value: traits.riskTaking },
                { id: 'ç¤¾ä¼šæ„è¯†', group: 2, size: Math.max(15, traits.socialAwareness / 3), value: traits.socialAwareness },
                { id: 'ç¯ä¿æ„è¯†', group: 3, size: Math.max(15, traits.environmentalConcern / 3), value: traits.environmentalConcern },
                { id: 'å®‰å…¨æ„è¯†', group: 4, size: Math.max(15, traits.safetyConsciousness / 3), value: traits.safetyConsciousness },
                { id: 'æ•ˆç‡å¯¼å‘', group: 5, size: Math.max(15, traits.efficiencyFocus / 3), value: traits.efficiencyFocus }
            ];
            
            const coreNode = nodes[0];
            const links = nodes.slice(1).map(node => ({
                source: coreNode,
                target: node,
                value: node.value
            }));
            
            // å›ºå®šæ ¸å¿ƒèŠ‚ç‚¹ä½ç½®
            coreNode.fx = width / 2;
            coreNode.fy = height / 2;
            
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2));
            
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('stroke', '#667eea')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', d => Math.sqrt(d.value) / 5);
            
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('r', d => d.size)
                .attr('fill', (d, i) => i === 0 ? '#667eea' : ['#667eea', '#764ba2', '#28a745', '#ffc107', '#dc3545'][d.group - 1])
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(drag(simulation));
            
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter()
                .append('text')
                .attr('text-anchor', 'middle')
                .attr('fill', '#e5e5e5')
                .attr('font-size', '12px')
                .text(d => d.id);
            
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y + 5);
            });
            
            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }
                
                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }
                
                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }
                
                return d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended);
            }
        }

        // åˆ›å»ºæ­£ä¹‰åº¦æ ‘çŠ¶å›¾
        function createJusticeTreeChart(justice) {
            const container = d3.select('#justice-tree-chart');
            container.selectAll('*').remove();
            
            const containerWidth = container.node().offsetWidth || 600;
            const width = Math.min(containerWidth - 24, containerWidth - 24);
            const height = Math.min(width * 0.4, 180);
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const treeData = {
                name: 'æ­£ä¹‰æ„ŸæŒ‡æ•°',
                value: justice.overall,
                children: [
                    {
                        name: 'ç¤¾ä¼šæ­£ä¹‰',
                        value: justice.socialJustice,
                        children: [
                            { name: 'å…¬å¹³æ„è¯†', value: Math.round(justice.socialJustice * 0.6) },
                            { name: 'ç¤¾ä¼šè´£ä»»', value: Math.round(justice.socialJustice * 0.4) }
                        ]
                    },
                    {
                        name: 'ä¸ªäººè´£ä»»',
                        value: justice.personalResponsibility,
                        children: [
                            { name: 'è‡ªæˆ‘çº¦æŸ', value: Math.round(justice.personalResponsibility * 0.5) },
                            { name: 'è¡Œä¸ºè§„èŒƒ', value: Math.round(justice.personalResponsibility * 0.5) }
                        ]
                    },
                    {
                        name: 'ç¯å¢ƒæ­£ä¹‰',
                        value: justice.environmentalJustice,
                        children: [
                            { name: 'ç¯ä¿æ„è¯†', value: Math.round(justice.environmentalJustice * 0.6) },
                            { name: 'å¯æŒç»­æ€§', value: Math.round(justice.environmentalJustice * 0.4) }
                        ]
                    }
                ]
            };
            
            const treemap = d3.treemap()
                .size([width, height])
                .padding(2);
            
            const root = d3.hierarchy(treeData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);
            
            treemap(root);
            
            const color = d3.scaleOrdinal()
                .domain([0, 1, 2])
                .range(['#667eea', '#764ba2', '#28a745']);
            
            const cells = svg.selectAll('g')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('transform', d => `translate(${d.x0},${d.y0})`);
            
            cells.append('rect')
                .attr('width', d => d.x1 - d.x0)
                .attr('height', d => d.y1 - d.y0)
                .attr('fill', d => {
                    if (d.depth === 0) return '#667eea';
                    if (d.depth === 1) return color(d.parent.children.indexOf(d));
                    return d3.color(color(d.parent.parent.children.indexOf(d.parent))).brighter(0.5);
                })
                .attr('stroke', '#1a1a1a')
                .attr('stroke-width', 2)
                .attr('opacity', 0)
                .transition()
                .duration(800)
                .delay((d, i) => i * 50)
                .attr('opacity', 0.8)
                .on('end', function() {
                    d3.select(this)
                        .on('mouseover', function(event, d) {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .attr('opacity', 1)
                                .attr('stroke-width', 3);
                            
                            tooltip
                                .html(`${d.data.name}<br>${d.data.value}%`)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY + 10) + 'px')
                                .classed('show', true);
                        })
                        .on('mouseout', function() {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .attr('opacity', 0.8)
                                .attr('stroke-width', 2);
                            tooltip.classed('show', false);
                        });
                });
            
            cells.filter(d => d.depth > 0 && (d.x1 - d.x0) > 60 && (d.y1 - d.y0) > 30)
                .append('text')
                .attr('x', d => (d.x1 - d.x0) / 2)
                .attr('y', d => (d.y1 - d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', d => Math.min(14, (d.x1 - d.x0) / 8))
                .text(d => d.data.name);
            
            cells.filter(d => d.depth > 0 && (d.x1 - d.x0) > 60 && (d.y1 - d.y0) > 40)
                .append('text')
                .attr('x', d => (d.x1 - d.x0) / 2)
                .attr('y', d => (d.y1 - d.y0) / 2 + 15)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text(d => d.data.value + '%');
        }

        // æ·»åŠ æ»šåŠ¨åŠ¨ç”»
        function addScrollAnimations() {
            const reportContent = document.getElementById('report-content');
            const sections = reportContent.querySelectorAll('.report-section, .report-cover');
            
            // åˆå§‹çŠ¶æ€ï¼šæ‰€æœ‰å…ƒç´ é€æ˜
            sections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
            });
            
            // ä½¿ç”¨ IntersectionObserver å®ç°æ»šåŠ¨åŠ¨ç”»
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.transition = 'all 0.5s ease';
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px'
            });
            
            sections.forEach(section => {
                observer.observe(section);
            });
            
            // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€ä¸ªå…ƒç´ 
            if (sections.length > 0) {
                setTimeout(() => {
                    sections[0].style.transition = 'all 0.5s ease';
                    sections[0].style.opacity = '1';
                    sections[0].style.transform = 'translateY(0)';
                }, 100);
            }
        }

        // ========== å›¾è¡¨å®¹å™¨ç‚¹å‡»æç¤º ==========
        document.querySelectorAll('.chart-container').forEach(container => {
            container.addEventListener('click', function() {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡æ‹Ÿç»“æœ
                if (!simulationResult) {
                    // æ˜¾ç¤ºæç¤ºå¼¹çª—
                    const tipModal = document.getElementById('chart-tip-modal');
                    tipModal.classList.add('show');
                }
            });
        });
        
        // å…³é—­å›¾è¡¨æç¤ºå¼¹çª—
        document.getElementById('close-chart-tip').addEventListener('click', function() {
            document.getElementById('chart-tip-modal').classList.remove('show');
        });
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('chart-tip-modal').addEventListener('click', function(e) {
            if (e.target.id === 'chart-tip-modal') {
                this.classList.remove('show');
            }
        });

        // ========== åˆå§‹åŒ– ==========
        updateSpeedometer(0);
        document.querySelector('[data-type="vehicle"]').classList.add('active');
        document.querySelector('[data-type="bump"]').classList.add('active');
        document.querySelector('[data-type="location"]').classList.add('active');
        
    </script>
</body>
</html>
